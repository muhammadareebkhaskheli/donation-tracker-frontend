<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceFlow Dashboard</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

        <style>
        /* ==================== GLOBAL STYLES ==================== */
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* ==================== LAYOUT ==================== */
        
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar-container {
            width: 256px;
            flex-shrink: 0;
            background: white;
            border-right: 1px solid #e5e7eb;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 40;
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-container.hidden {
            transform: translateX(-100%);
        }

        .sidebar-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            min-height: 80px;
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-item.active i {
            color: white;
        }

        /* Main Content */
        .main-content-wrapper {
            flex: 1;
            margin-left: 256px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2rem;
        }

        .header-container {
            position: sticky;
            top: 0;
            z-index: 30;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            height: 80px;
            min-height: 80px;
        }

        /* ==================== SCROLLBAR STYLES ==================== */
        
        /* Default Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Custom Scrollbar (for specific elements) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ==================== DASHBOARD CONTAINERS ==================== */
        
        /* Budget, Bills, Transactions - Shared Styles */
        #dashboard-budget-container,
        #dashboard-bills-container,
        #dashboard-transactions-container {
            height: 350px;
            overflow: hidden;
            transition: overflow 0.3s ease;
        }

        #dashboard-budget-container.collapsed,
        #dashboard-bills-container.collapsed,
        #dashboard-transactions-container.collapsed {
            overflow: hidden;
        }

        #dashboard-budget-container.expanded,
        #dashboard-bills-container.expanded,
        #dashboard-transactions-container.expanded {
            overflow-y: auto;
            padding-right: 8px;
        }

        /* Expanded Scrollbar */
        #dashboard-budget-container.expanded::-webkit-scrollbar,
        #dashboard-bills-container.expanded::-webkit-scrollbar,
        #dashboard-transactions-container.expanded::-webkit-scrollbar {
            width: 6px;
        }

        #dashboard-budget-container.expanded::-webkit-scrollbar-track,
        #dashboard-bills-container.expanded::-webkit-scrollbar-track,
        #dashboard-transactions-container.expanded::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        #dashboard-budget-container.expanded::-webkit-scrollbar-thumb,
        #dashboard-bills-container.expanded::-webkit-scrollbar-thumb,
        #dashboard-transactions-container.expanded::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        #dashboard-budget-container.expanded::-webkit-scrollbar-thumb:hover,
        #dashboard-bills-container.expanded::-webkit-scrollbar-thumb:hover,
        #dashboard-transactions-container.expanded::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Fade Overlay for Collapsed View */
        #dashboard-budget-container.collapsed::after,
        #dashboard-bills-container.collapsed::after,
        #dashboard-transactions-container.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(transparent, white);
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #dashboard-budget-container.expanded::after,
        #dashboard-bills-container.expanded::after,
        #dashboard-transactions-container.expanded::after {
            opacity: 0;
        }

        /* Toggle Icons */
        #budget-toggle-icon,
        #bills-toggle-icon,
        #transactions-toggle-icon {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }

        #budget-toggle-icon.expanded,
        #bills-toggle-icon.expanded,
        #transactions-toggle-icon.expanded {
            transform: rotate(90deg);
        }

        /* ==================== ANIMATIONS ==================== */
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* List Item Animations */
        #dashboard-budget-list li,
        #dashboard-upcoming-bills li,
        #dashboard-recent-transactions li {
            animation: fadeInUp 0.3s ease-out forwards;
            opacity: 0;
        }

        #dashboard-budget-list li:nth-child(1),
        #dashboard-upcoming-bills li:nth-child(1),
        #dashboard-recent-transactions li:nth-child(1) { animation-delay: 0.05s; }
        
        #dashboard-budget-list li:nth-child(2),
        #dashboard-upcoming-bills li:nth-child(2),
        #dashboard-recent-transactions li:nth-child(2) { animation-delay: 0.1s; }
        
        #dashboard-budget-list li:nth-child(3),
        #dashboard-upcoming-bills li:nth-child(3),
        #dashboard-recent-transactions li:nth-child(3) { animation-delay: 0.15s; }
        
        #dashboard-budget-list li:nth-child(4),
        #dashboard-upcoming-bills li:nth-child(4),
        #dashboard-recent-transactions li:nth-child(4) { animation-delay: 0.2s; }
        
        #dashboard-budget-list li:nth-child(5),
        #dashboard-upcoming-bills li:nth-child(5),
        #dashboard-recent-transactions li:nth-child(5) { animation-delay: 0.25s; }
        
        #dashboard-budget-list li:nth-child(6),
        #dashboard-upcoming-bills li:nth-child(6),
        #dashboard-recent-transactions li:nth-child(6) { animation-delay: 0.3s; }
        
        #dashboard-budget-list li:nth-child(7),
        #dashboard-upcoming-bills li:nth-child(7),
        #dashboard-recent-transactions li:nth-child(7) { animation-delay: 0.35s; }
        
        #dashboard-budget-list li:nth-child(8),
        #dashboard-upcoming-bills li:nth-child(8),
        #dashboard-recent-transactions li:nth-child(8) { animation-delay: 0.4s; }
        
        #dashboard-budget-list li:nth-child(9),
        #dashboard-upcoming-bills li:nth-child(9),
        #dashboard-recent-transactions li:nth-child(9) { animation-delay: 0.45s; }
        
        #dashboard-budget-list li:nth-child(10),
        #dashboard-upcoming-bills li:nth-child(10),
        #dashboard-recent-transactions li:nth-child(10) { animation-delay: 0.5s; }

        /* ==================== PAGES ==================== */
        
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* ==================== EXPENSE PAGE ==================== */
        
        #expense .grid {
            align-items: start;
        }

        #expense .lg\:col-span-1 > div,
        #expense .lg\:col-span-2 > div {
            height: 680px;
        }

        #expense .lg\:col-span-1 > div {
            display: flex;
            flex-direction: column;
        }

        #expense .sticky {
            position: sticky;
            top: 6rem;
        }

        #expense-form {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #expense-form > div:first-child {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        #expense .lg\:col-span-2 > div {
            display: flex;
            flex-direction: column;
        }

        #expenses-list-container {
            flex: 1;
            overflow-y: auto;
        }

        #expense-form > div:first-child::-webkit-scrollbar,
        #expenses-list-container::-webkit-scrollbar {
            width: 6px;
        }

        #expense-form > div:first-child::-webkit-scrollbar-track,
        #expenses-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #expense-form > div:first-child::-webkit-scrollbar-thumb,
        #expenses-list-container::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 3px;
        }

        #expense-form > div:first-child::-webkit-scrollbar-thumb:hover,
        #expenses-list-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* ==================== CHARTS ==================== */
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            overflow: hidden !important;
        }

        #savings-donut-chart {
            max-height: 280px !important;
            max-width: 100% !important;
        }

        #savings-donut-chart-container,
        .savings-distribution {
            overflow: hidden !important;
            max-height: 320px;
        }

        /* ==================== MODALS ==================== */
        
        /* Category Modal */
        #category-modal .icon-option,
        #category-modal .color-option {
            border: 2px solid transparent;
            transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }

        #category-modal .icon-option:hover,
        #category-modal .color-option:hover {
            border-color: #667eea;
            background-color: #f0f7ff;
        }

        #category-modal .icon-option.selected,
        #category-modal .color-option.selected {
            border-color: #667eea;
            background-color: #f0f7ff;
        }

        /* Draggable Modal */
        .modal-draggable {
            position: relative;
            cursor: default;
        }

        .modal-drag-handle {
            cursor: move;
            user-select: none;
        }

        .modal-dragging {
            cursor: move;
        }

        .modal-dragging * {
            cursor: move !important;
            user-select: none !important;
        }

        /* Delete Modal */
        #delete-modal .bg-red-100 {
            background-color: #fef3f2;
        }

        #delete-modal .text-red-600 {
            color: #991b1b;
        }

        /* ==================== CALENDAR ==================== */
        
        .calendar-day {
            position: relative;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .calendar-day:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .calendar-day.selected {
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }

        #calendar-dropdown {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #calendar-dropdown.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }

        #calendar-dropdown:not(.hidden) {
            opacity: 1;
            transform: translateY(0);
        }

        /* ==================== UTILITIES ==================== */
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        .max-h-96::-webkit-scrollbar {
            width: 6px;
        }

        .max-h-96::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .max-h-96::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .max-h-96::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ==================== RESPONSIVE ==================== */
        
        @media (max-width: 1023px) {
            .main-content-wrapper {
                margin-left: 0;
            }
            
            .sidebar-container {
                transform: translateX(-100%);
            }
            
            .sidebar-container.open {
                transform: translateX(0);
            }
        }

        /* Name Animation - Mobile (Typing + Underline) */
        .name-animated {
            display: inline-block;
            font-weight: 600;
            color: #667eea;
            position: relative;
            animation: typing 2s steps(6) 0.5s forwards;
            overflow: hidden;
            white-space: nowrap;
            border-right: 2px solid #667eea;
            width: 0;
        }

        .name-animated::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            animation: underline 1s ease-out 2.5s forwards;
        }

        @keyframes typing {
            from { width: 0; }
            to { 
                width: 100%;
                border-right-color: transparent;
            }
        }

        @keyframes underline {
            to { width: 100%; }
        }

        /* Name Animation - Desktop */
        .name-animated-desktop {
            display: inline-block;
            font-weight: 700;
            color: #667eea;
            animation: typing 2s steps(6) 0.5s forwards, colorShift 3s ease infinite 2.5s;
            overflow: hidden;
            white-space: nowrap;
            border-right: 2px solid #667eea;
            width: 0;
        }

        @keyframes colorShift {
            0%, 100% { color: #667eea; }
            50% { color: #764ba2; }
        }

        /* Logo Bounce */
        .logo-bounce {
            animation: gentleBounce 2s ease-in-out infinite;
        }

        @keyframes gentleBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-6px);
            }
        }

        /* Avatar Scale */
        .avatar-scale {
            animation: breathe 3s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.08);
            }
        }

        /* Hover Effects */
        .name-animated:hover,
        .name-animated-desktop:hover {
            color: #764ba2;
            cursor: default;
            animation: none;
            border-right: none;
        }

        .logo-bounce:hover {
            animation: none;
            transform: scale(1.1) rotate(5deg);
            transition: transform 0.3s ease;
        }

        .avatar-scale:hover {
            animation: none;
            transform: scale(1.15);
            transition: transform 0.3s ease;
        }

    </style>

</head>
<body class="bg-gradient-to-br from-gray-50 via-gray-100 to-gray-50">
    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar-container lg:translate-x-0">
            <div class="flex flex-col h-full">
                <!-- Sidebar header -->
                <div class="sidebar-header flex items-center justify-center">
                    <div class="flex items-center space-x-3">
                        <div class="logo flex items-center gap-3 font-bold text-indigo-500 select-none">
                        <i class="fas fa-chart-line text-2xl"></i>
                        </div>
                        <h1 class="text-2xl font-extrabold text-indigo-500">
                        <span class="bg-gradient-to-r from-indigo-500 to-purple-600 bg-clip-text text-transparent">FinanceFlow</span>
                        </h1>
                    </div>
                    <button id="close-sidebar" class="lg:hidden p-1 rounded-lg hover:bg-gray-100">
                        <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                    </button>
                </div>

                <!-- Navigation Menu -->
                <nav class="flex-1 p-4">
                    <ul class="space-y-2">
                        <li>
                            <a href="#" data-page="dashboard" class="sidebar-item flex items-center space-x-3 px-3 py-2 rounded-lg bg-indigo-50 text-indigo-700 font-medium active">
                                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="categories" class="sidebar-item flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 font-medium">
                                <i data-lucide="tag" class="w-5 h-5"></i>
                                <span>Categories</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="expense" class="sidebar-item flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 font-medium">
                                <i data-lucide="credit-card" class="w-5 h-5"></i>
                                <span>Expense</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="income" class="sidebar-item flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 font-medium">
                                <i data-lucide="dollar-sign" class="w-5 h-5"></i>
                                <span>Income</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="accounts" class="sidebar-item flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 font-medium">
                                <i data-lucide="wallet" class="w-5 h-5"></i>
                                <span>Accounts</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="budget" class="sidebar-item flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 font-medium">
                                <i data-lucide="target" class="w-5 h-5"></i>
                                <span>Budget</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="savings" class="sidebar-item flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 font-medium">
                                <i data-lucide="piggy-bank" class="w-5 h-5"></i>
                                <span>Savings</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="investments" class="sidebar-item flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 font-medium">
                                <i data-lucide="trending-up" class="w-5 h-5"></i>
                                <span>Investments</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="bills" class="sidebar-item flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 font-medium">
                                <i data-lucide="receipt" class="w-5 h-5"></i>
                                <span>Bills & Payments</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="reports" class="sidebar-item flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 font-medium">
                                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                                <span>Reports</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="calendar" class="sidebar-item flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 font-medium">
                                <i data-lucide="calendar" class="w-5 h-5"></i>
                                <span>Financial Calendar</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" data-page="security" class="sidebar-item flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 font-medium">
                                <i data-lucide="shield" class="w-5 h-5"></i>
                                <span>Security</span>
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- Sidebar Footer -->
                <div class="p-4 border-t border-gray-200">
                    <div class="flex items-center space-x-3 mb-3">
                        <div class="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-medium">A</span>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Areesh</p>
                            <p class="text-xs text-gray-500">Premium Plan</p>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <a href="#" class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 transition-colors">
                            <i data-lucide="settings" class="w-4 h-4"></i>
                            <span class="text-sm">Settings</span>
                        </a>
                        <a href="#" class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 transition-colors">
                            <i data-lucide="help-circle" class="w-4 h-4"></i>
                            <span class="text-sm">Help & Support</span>
                        </a>
                        <a href="#" class="flex items-center space-x-3 px-3 py-2 rounded-lg hover:bg-gray-50 text-gray-700 hover:text-gray-900 transition-colors">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            <span class="text-sm">Sign Out</span>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="main-content-wrapper">
            <!-- Header -->
            <header class="header-container">
                <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 h-full flex items-center">
                    <div class="flex items-center space-x-4 flex-1">
                        <button id="menu-toggle" class="lg:hidden p-2 rounded-lg hover:bg-gray-100">
                            <i data-lucide="menu" class="w-6 h-6 text-gray-600"></i>
                        </button>
                        
                        <!-- Mobile Logo & Name -->
                        <div class="flex items-center space-x-3 lg:hidden">
                            <div class="logo-bounce">
                                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i class="fas fa-chart-line text-white text-lg"></i>
                                </div>
                            </div>
                            <div>
                                <h1 class="text-xl font-bold text-gray-900">FinanceFlow</h1>
                                <p class="text-sm text-gray-600">
                                    Welcome back, <span class="name-animated">Areesh</span>
                                </p>
                            </div>
                        </div>
                        
                        <!-- Desktop User Greeting -->
                        <div class="hidden lg:block">
                            <div class="flex items-center space-x-3">
                                <div class="avatar-scale">
                                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
                                        <i data-lucide="user" class="w-5 h-5 text-white"></i>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Welcome back,</p>
                                    <p class="text-lg font-semibold">
                                        <span class="name-animated-desktop">Muhammad Areesh</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Centered Search Bar -->
                    <!-- <div class="hidden md:flex items-center bg-gray-100 rounded-lg px-4 py-2 flex-1 max-w-md mx-8">
                        <i data-lucide="search" class="w-4 h-4 text-gray-500 mr-2"></i>
                        <input type="text" placeholder="Search transactions..." class="bg-transparent border-none outline-none text-sm w-full" />
                    </div> -->

                    <div class="flex items-center space-x-4 flex-1 justify-end">
                        <!-- Calendar Widget -->
                        <div class="relative">
                            <button id="calendar-toggle" class="border border-gray-300 rounded-lg px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 flex items-center space-x-2">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                <span id="current-date"></span>
                                <i data-lucide="chevron-down" class="w-4 h-4"></i>
                            </button>
                        
                            <!-- Calendar Dropdown -->
                            <div id="calendar-dropdown" class="absolute right-0 top-full mt-2 bg-white border border-gray-200 rounded-xl shadow-2xl z-50 hidden overflow-hidden transition-all duration-300" style="width: 380px;">
                                <div class="p-5">
                                    <!-- Real-Time Clock Display -->
                                    <div class="text-center mb-4 pb-4 border-b border-gray-200">
                                        <div id="live-time" class="text-3xl font-bold text-indigo-600 transition-all duration-300"></div>
                                        <div id="live-date" class="text-sm text-gray-600 mt-1"></div>
                                    </div>
                                    
                                    <!-- Calendar Header with Year Navigation -->
                                    <div class="flex items-center justify-between mb-4">
                                        <button id="prev-year" class="p-2 hover:bg-indigo-50 rounded-lg transition-all duration-200" title="Previous Year">
                                            <i data-lucide="chevrons-left" class="w-4 h-4 text-gray-600"></i>
                                        </button>
                                        <button id="prev-month" class="p-2 hover:bg-indigo-50 rounded-lg transition-all duration-200" title="Previous Month">
                                            <i data-lucide="chevron-left" class="w-4 h-4 text-gray-600"></i>
                                        </button>
                                        <h3 id="calendar-month-year" class="font-bold text-gray-900 flex-1 text-center transition-all duration-300"></h3>
                                        <button id="next-month" class="p-2 hover:bg-indigo-50 rounded-lg transition-all duration-200" title="Next Month">
                                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600"></i>
                                        </button>
                                        <button id="next-year" class="p-2 hover:bg-indigo-50 rounded-lg transition-all duration-200" title="Next Year">
                                            <i data-lucide="chevrons-right" class="w-4 h-4 text-gray-600"></i>
                                        </button>
                                    </div>
                                
                                    <!-- Calendar Grid -->
                                    <div class="grid grid-cols-7 gap-1 mb-2">
                                        <div class="text-center text-xs font-semibold text-gray-500 py-2">S</div>
                                        <div class="text-center text-xs font-semibold text-gray-500 py-2">M</div>
                                        <div class="text-center text-xs font-semibold text-gray-500 py-2">T</div>
                                        <div class="text-center text-xs font-semibold text-gray-500 py-2">W</div>
                                        <div class="text-center text-xs font-semibold text-gray-500 py-2">T</div>
                                        <div class="text-center text-xs font-semibold text-gray-500 py-2">F</div>
                                        <div class="text-center text-xs font-semibold text-gray-500 py-2">S</div>
                                    </div>
                                
                                    <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                                        <!-- Calendar days will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notification Button -->
                        <button class="p-2 rounded-lg hover:bg-gray-100 relative">
                            <i data-lucide="bell" class="w-5 h-5 text-gray-600"></i>
                            <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                        </button>
                        
                        <!-- Settings Button -->
                        <button class="p-2 rounded-lg hover:bg-gray-100">
                            <i data-lucide="settings" class="w-5 h-5 text-gray-600"></i>
                        </button>
                    </div>

                    <!-- Notes Modal/Overlay (Samsung Style) - Place at the END of your HTML, just before </body> -->
                    <div id="notes-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm transition-all duration-300">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="notes-modal-content">
                            <!-- Modal Header -->
                            <div class="p-5 border-b border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 id="modal-date-title" class="text-xl font-bold text-gray-900"></h3>
                                        <p class="text-sm text-gray-500 mt-1" id="modal-notes-count">0 reminders</p>
                                    </div>
                                    <button id="close-modal" class="p-2 hover:bg-gray-100 rounded-lg transition-all duration-200">
                                        <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Modal Body -->
                            <div class="p-5 max-h-96 overflow-y-auto custom-scrollbar">
                                <div id="modal-notes-list" class="space-y-3">
                                    <!-- Notes will be populated here -->
                                </div>
                                
                                <div id="modal-empty-state" class="text-center py-8">
                                    <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i data-lucide="calendar-plus" class="w-8 h-8 text-indigo-600"></i>
                                    </div>
                                    <p class="text-sm text-gray-500">No reminders for this day</p>
                                    <p class="text-xs text-gray-400 mt-1">Add one below</p>
                                </div>
                            </div>
                            
                            <!-- Modal Footer - Add Note -->
                            <div class="p-5 border-t border-gray-200 bg-gray-50">
                                <div class="flex gap-2">
                                    <input 
                                        type="text" 
                                        id="modal-note-input" 
                                        placeholder="Add a reminder..." 
                                        class="flex-1 px-4 py-3 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200 bg-white"
                                    />
                                    <button id="modal-add-note-btn" class="px-5 py-3 bg-indigo-600 text-white rounded-xl text-sm font-medium hover:bg-indigo-700 active:scale-95 transition-all duration-200 flex items-center gap-2 shadow-lg shadow-indigo-500/30">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                        Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Dashboard-Page -->
                <div id="dashboard" class="page-section active">
                    <!-- Financial Health -->
                    <div class="mb-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 text-white shadow-lg fade-in">
                        <h3 class="text-lg font-bold mb-2">Financial Health Score: <span id="health-score">0</span>/100</h3>
                        <p id="health-message" class="text-indigo-100 text-sm mb-3">Loading...</p>
                        <div class="flex flex-wrap items-center gap-4 text-sm">
                            <span class="flex items-center">
                                <span id="budget-indicator" class="w-2 h-2 bg-gray-300 rounded-full mr-2"></span>
                                <span id="budget-text">Budget: Calculating...</span>
                            </span>
                            <span class="flex items-center">
                                <span id="savings-indicator" class="w-2 h-2 bg-gray-300 rounded-full mr-2"></span>
                                <span id="savings-text">Savings: Calculating...</span>
                            </span>
                            <span class="flex items-center">
                                <span id="debt-indicator" class="w-2 h-2 bg-green-300 rounded-full mr-2"></span>
                                <span id="debt-text">Debt: None</span>
                            </span>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg hover:scale-105 hover:border-gray-200 transition-all duration-300 cursor-pointer fade-in">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Total Balance</p>
                                    <h3 id="dashboard-total-balance" class="text-3xl font-bold text-gray-900 mb-2">$0</h3>
                                    <span id="dashboard-balance-change" class="text-green-500 text-sm font-medium flex items-center">
                                        <i data-lucide="arrow-up-right" class="w-4 h-4 mr-1"></i>+0%
                                    </span>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg">
                                    <i data-lucide="wallet" class="w-6 h-6 text-green-500"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg hover:scale-105 hover:border-gray-200 transition-all duration-300 cursor-pointer fade-in">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Monthly Income</p>
                                    <h3 id="dashboard-monthly-income" class="text-3xl font-bold text-gray-900 mb-2">$0</h3>
                                    <span id="dashboard-income-change" class="text-green-500 text-sm font-medium flex items-center">
                                        <i data-lucide="arrow-up-right" class="w-4 h-4 mr-1"></i>+0%
                                    </span>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-green-500"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg hover:scale-105 hover:border-gray-200 transition-all duration-300 cursor-pointer fade-in">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Monthly Expenses</p>
                                    <h3 id="dashboard-monthly-expenses" class="text-3xl font-bold text-gray-900 mb-2">$0</h3>
                                    <span id="dashboard-expenses-change" class="text-red-500 text-sm font-medium flex items-center">
                                        <i data-lucide="arrow-down-right" class="w-4 h-4 mr-1"></i>-0%
                                    </span>
                                </div>
                                <div class="bg-red-50 p-3 rounded-lg">
                                    <i data-lucide="trending-down" class="w-6 h-6 text-red-500"></i>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg hover:scale-105 hover:border-gray-200 transition-all duration-300 cursor-pointer fade-in">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Net Savings</p>
                                    <h3 id="dashboard-net-savings" class="text-3xl font-bold text-gray-900 mb-2">$0</h3>
                                    <span id="dashboard-savings-change" class="text-green-500 text-sm font-medium flex items-center">
                                        <i data-lucide="arrow-up-right" class="w-4 h-4 mr-1"></i>+0%
                                    </span>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg">
                                    <i data-lucide="piggy-bank" class="w-6 h-6 text-green-500"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Placeholders -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in">
                            <h3 class="text-lg font-bold mb-4">Cash Flow</h3>
                            <div class="chart-container">
                                <canvas id="cashFlowChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6 fade-in">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Spending by Category</h3>
                            <div class="flex justify-center">
                                <div style="width: 280px; height: 280px;">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Budget and Transactions -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Budget Progress -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-bold">Budget Progress</h2>
                                <button id="toggle-budget-view" class="text-indigo-600 text-sm font-medium hover:text-indigo-700 flex items-center group">
                                    <span id="budget-toggle-text">View All</span>
                                    <svg id="budget-toggle-icon" class="w-4 h-4 ml-1 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            </div>
                            <div class="relative">
                                <div id="dashboard-budget-container" class="collapsed">
                                    <ul id="dashboard-budget-list" class="space-y-3 text-sm text-gray-700">
                                        <!-- Budget items will be populated by JavaScript -->
                                    </ul>
                                </div>
                            </div>
                            <div id="dashboard-budget-empty" class="hidden text-center py-8 text-gray-500">
                                <p>No budgets set yet. Start by creating categories with budgets!</p>
                            </div>
                        </div>

                        <!-- Recent Transactions -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-bold">Recent Transactions</h2>
                                <button id="toggle-transactions-view" class="text-indigo-600 text-sm font-medium hover:text-indigo-700 flex items-center group">
                                    <span id="transactions-toggle-text">View All</span>
                                    <svg id="transactions-toggle-icon" class="w-4 h-4 ml-1 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            </div>
                            <div class="relative">
                                <div id="dashboard-transactions-container" class="collapsed">
                                    <ul id="dashboard-recent-transactions" class="space-y-3 text-sm text-gray-700">
                                        <!-- Recent transactions will be populated by JavaScript -->
                                    </ul>
                                </div>
                            </div>
                            <div id="dashboard-transactions-empty" class="hidden text-center py-8 text-gray-500">
                                <p>No transactions yet. Start adding expenses and income!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Upcoming Bills + Monthly Savings -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Upcoming Bills -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-bold">Upcoming Bills</h2>
                                <button id="toggle-bills-view" class="text-indigo-600 text-sm font-medium hover:text-indigo-700 flex items-center group">
                                    <span id="bills-toggle-text">View All</span>
                                    <svg id="bills-toggle-icon" class="w-4 h-4 ml-1 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </button>
                            </div>
                            <div class="relative">
                                <div id="dashboard-bills-container" class="collapsed">
                                    <ul id="dashboard-upcoming-bills" class="space-y-3 text-sm text-gray-700">
                                        <!-- Bills will be populated by JavaScript -->
                                    </ul>
                                </div>
                            </div>
                            <div id="dashboard-bills-empty" class="hidden text-center py-8 text-gray-500">
                                <p>No upcoming bills. Add bills to track payments!</p>
                            </div>
                        </div>

                        <!-- Monthly Savings -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in">
                            <h3 class="text-lg font-bold mb-4">Monthly Savings</h3>
                            <div class="chart-container">
                                <canvas id="savingsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <!--  CLOSE SECOND GRID HERE -->

                    <!-- Row 3: Quick Actions -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 hover:shadow-md transition-all cursor-pointer fade-in">
                            <div class="flex flex-col items-center text-center">
                                <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center mb-2">
                                    <i data-lucide="receipt" class="w-5 h-5 text-indigo-600"></i>
                                </div>
                                <p class="text-xs font-semibold text-gray-900">Scan Receipt</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 hover:shadow-md transition-all cursor-pointer fade-in">
                            <div class="flex flex-col items-center text-center">
                                <div class="w-10 h-10 bg-purple-50 rounded-full flex items-center justify-center mb-2">
                                    <i data-lucide="credit-card" class="w-5 h-5 text-purple-600"></i>
                                </div>
                                <p class="text-xs font-semibold text-gray-900">Link Account</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 hover:shadow-md transition-all cursor-pointer fade-in">
                            <div class="flex flex-col items-center text-center">
                                <div class="w-10 h-10 bg-pink-50 rounded-full flex items-center justify-center mb-2">
                                    <i data-lucide="calendar" class="w-5 h-5 text-pink-600"></i>
                                </div>
                                <p class="text-xs font-semibold text-gray-900">Set Reminder</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-100 hover:shadow-md transition-all cursor-pointer fade-in">
                            <div class="flex flex-col items-center text-center">
                                <div class="w-10 h-10 bg-green-50 rounded-full flex items-center justify-center mb-2">
                                    <i data-lucide="activity" class="w-5 h-5 text-green-600"></i>
                                </div>
                                <p class="text-xs font-semibold text-gray-900">View Reports</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories Page -->
                <div id="categories" class="page-section">
                    <div class="mb-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 text-white shadow-lg fade-in">
                        <h3 class="text-lg font-bold mb-2">Categories Management</h3>
                        <p class="text-indigo-100 text-sm mb-3">Organize your expenses and income with custom categories.</p>
                        <div class="flex flex-wrap items-center gap-4 text-sm">
                            <span class="flex items-center"><span class="w-2 h-2 bg-green-300 rounded-full mr-2"></span>Expense Categories:&nbsp;<span id="expense-count">8</span></span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-blue-300 rounded-full mr-2"></span>Income Categories:&nbsp;<span id="income-count">4</span></span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-yellow-300 rounded-full mr-2"></span>Budget Tracking:&nbsp;Active</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-900">Your Categories</h2>                            
                            <button 
                                id="add-category-btn" 
                                class="px-6 py-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-base font-semibold shadow-sm hover:from-indigo-600 hover:to-purple-600 transition-all duration-300 flex items-center space-x-2">
                                <!-- <i data-lucide="plus" class="w-5 h-5"></i> -->
                                <span>Add Category</span>
                            </button>
                        </div>

                        <!-- Filter Tabs -->
                        <div class="flex space-x-1 mb-6 bg-gray-100 p-1 rounded-lg w-fit">
                            <button id="filter-all" class="px-4 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm">All</button>
                            <button id="filter-expense" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900">Expenses</button>
                            <button id="filter-income" class="px-4 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900">Income</button>
                        </div>

                        <div id="categories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Categories will be populated by JavaScript -->
                        </div>

                        <!-- Empty State -->
                        <div id="empty-state" class="text-center py-12 hidden">
                            <i data-lucide="tag" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No categories found</h3>
                            <p class="text-gray-500 mb-4">Get started by creating your first category</p>
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">
                                Create Category
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add/Edit Category Modal -->
                <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div id="modal-content" class="bg-white rounded-xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-hidden modal-draggable">

                        <!-- Drag Handle -->
                        <div id="modal-drag-handle" class="bg-gray-50 px-6 py-3 border-b border-gray-200 rounded-t-xl" style="cursor: default;">
                            <div class="flex items-center justify-between">
                                <h3 id="modal-title" class="text-lg font-semibold text-gray-900">Add Category</h3>
                                <button id="close-modal" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-200 transition-colors">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Modal Body -->
                        <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                            <form id="category-form">
                                <div class="space-y-4">
                                    <!-- Category Name -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Category Name</label>
                                        <input type="text" id="category-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Groceries, Salary" required>
                                    </div>

                                    <!-- Description -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                        <textarea id="category-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="2" placeholder="Brief description"></textarea>
                                    </div>

                                    <!-- Type -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                        <select id="category-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                            <option value="expense">Expense</option>
                                            <option value="income">Income</option>
                                        </select>
                                    </div>

                                    <!-- Icon Section -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Icon</label>
                                        <div class="grid grid-cols-8 gap-2 overflow-y-auto max-h-40 p-2 border rounded-lg" id="icon-selector">
                                            <!-- Icons (45 total) -->
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="home"><i data-lucide="home" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="utensils"><i data-lucide="utensils" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="car"><i data-lucide="car" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="briefcase"><i data-lucide="briefcase" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="book"><i data-lucide="book" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="shopping-cart"><i data-lucide="shopping-cart" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="coffee"><i data-lucide="coffee" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="plane"><i data-lucide="plane" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="gamepad-2"><i data-lucide="gamepad-2" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="music"><i data-lucide="music" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="dumbbell"><i data-lucide="dumbbell" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="gift"><i data-lucide="gift" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="camera"><i data-lucide="camera" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="tv"><i data-lucide="tv" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="coins"><i data-lucide="coins" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="wallet"><i data-lucide="wallet" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="heart"><i data-lucide="heart" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="graduation-cap"><i data-lucide="graduation-cap" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="piggy-bank"><i data-lucide="piggy-bank" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="smartphone"><i data-lucide="smartphone" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="stethoscope"><i data-lucide="stethoscope" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="bus"><i data-lucide="bus" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="building"><i data-lucide="building" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="credit-card"><i data-lucide="credit-card" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="droplet"><i data-lucide="droplet" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="lightbulb"><i data-lucide="lightbulb" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="shopping-bag"><i data-lucide="shopping-bag" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="tree-pine"><i data-lucide="tree-pine" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="cup-soda"><i data-lucide="cup-soda" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="dollar-sign"><i data-lucide="dollar-sign" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="calendar"><i data-lucide="calendar" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="target"><i data-lucide="target" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="bell"><i data-lucide="bell" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="settings"><i data-lucide="settings" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="user"><i data-lucide="user" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="users"><i data-lucide="users" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="banknote"><i data-lucide="banknote" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="receipt"><i data-lucide="receipt" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="chart-pie"><i data-lucide="chart-pie" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="chart-bar"><i data-lucide="chart-bar" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="lock"><i data-lucide="lock" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="unlock"><i data-lucide="unlock" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="file-text"><i data-lucide="file-text" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="globe"><i data-lucide="globe" class="w-5 h-5"></i></button>
                                            <button type="button" class="icon-option p-2 border rounded-lg hover:border-indigo-500 hover:bg-indigo-50 flex items-center justify-center aspect-square" data-icon="save"><i data-lucide="save" class="w-5 h-5"></i></button>
                                        </div>
                                        <input type="hidden" id="selected-icon" value="home">
                                    </div>

                                    <!-- Color Section -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Color</label>
                                        <div class="flex flex-wrap gap-2 p-2 border rounded-lg" id="color-selector">
                                            <button type="button" class="color-option w-8 h-8 rounded-full border-2 border-gray-300 hover:border-gray-500" style="background-color: #4f46e5;" data-color="#4f46e5"></button>
                                            <button type="button" class="color-option w-8 h-8 rounded-full border-2 border-gray-300 hover:border-gray-500" style="background-color: #6366f1;" data-color="#6366f1"></button>
                                            <button type="button" class="color-option w-8 h-8 rounded-full border-2 border-gray-300 hover:border-gray-500" style="background-color: #3b82f6;" data-color="#3b82f6"></button>
                                            <button type="button" class="color-option w-8 h-8 rounded-full border-2 border-gray-300 hover:border-gray-500" style="background-color: #06b6d4;" data-color="#06b6d4"></button>
                                            <button type="button" class="color-option w-8 h-8 rounded-full border-2 border-gray-300 hover:border-gray-500" style="background-color: #10b981;" data-color="#10b981"></button>
                                            <button type="button" class="color-option w-8 h-8 rounded-full border-2 border-gray-300 hover:border-gray-500" style="background-color: #f59e0b;" data-color="#f59e0b"></button>
                                            <button type="button" class="color-option w-8 h-8 rounded-full border-2 border-gray-300 hover:border-gray-500" style="background-color: #f97316;" data-color="#f97316"></button>
                                            <button type="button" class="color-option w-8 h-8 rounded-full border-2 border-gray-300 hover:border-gray-500" style="background-color: #ef4444;" data-color="#ef4444"></button>
                                            <button type="button" class="color-option w-8 h-8 rounded-full border-2 border-gray-300 hover:border-gray-500" style="background-color: #ec4899;" data-color="#ec4899"></button>
                                            <button type="button" class="color-option w-8 h-8 rounded-full border-2 border-gray-300 hover:border-gray-500" style="background-color: #8b5cf6;" data-color="#8b5cf6"></button>
                                            <button type="button" class="color-option w-8 h-8 rounded-full border-2 border-gray-300 hover:border-gray-500" style="background-color: #14b8a6;" data-color="#14b8a6"></button>
                                            <button type="button" class="color-option w-8 h-8 rounded-full border-2 border-gray-300 hover:border-gray-500" style="background-color: #0ea5e9;" data-color="#0ea5e9"></button>
                                        </div>
                                        <input type="hidden" id="selected-color" value="#4f46e5">
                                    </div>
                                </div>

                                <!-- Footer Buttons -->
                                <div class="flex space-x-3 mt-6 pt-4 border-t border-gray-200">
                                    <button type="button" id="cancel-btn" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                                        Cancel
                                    </button>
                                    <button type="submit" id="save-btn" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                                        Save Category
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Delete Confirmation Modal -->
                <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-sm">
                        <div class="p-6">
                            <div class="flex items-center justify-center w-12 h-12 mx-auto mb-4 bg-red-100 rounded-full">
                                <i data-lucide="trash-2" class="w-6 h-6 text-red-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 text-center mb-2">Delete Category</h3>
                            <p class="text-gray-600 text-center mb-6">Are you sure you want to delete this category? This action cannot be undone.</p>
                            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                                <button id="cancel-delete" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                                Cancel
                                </button>
                                <button id="confirm-delete" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expense Page -->
                <div id="expense" class="page-section">
                    <div class="mb-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 text-white shadow-lg fade-in">
                        <h3 class="text-lg font-bold mb-2">Expense Tracker</h3>
                        <p class="text-indigo-100 text-sm mb-3">Track and manage all your expenses in one place.</p>
                        <div class="flex flex-wrap items-center gap-4 text-sm">
                            <span class="flex items-center"><span class="w-2 h-2 bg-red-300 rounded-full mr-2"></span>Total Expenses:&nbsp;$<span id="total-expenses">0</span></span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-yellow-300 rounded-full mr-2"></span>Expenses Count:&nbsp;<span id="total-transactions">0</span></span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Add Expense Form (Fixed Column) -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in sticky top-24">
                                <h2 class="text-xl font-bold text-gray-900 mb-4">Add Expense</h2>
                                <form id="expense-form">
                                    <div class="space-y-4">
                                        <!-- Amount -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                                            <div class="relative">
                                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                                <input type="number" id="expense-amount" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0.00" step="0.01" min="0" required>
                                            </div>
                                        </div>

                                        <!-- Category -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                            <select id="expense-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                                <option value="">Select category</option>
                                            </select>
                                        </div>

                                        <!-- Description -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                            <input type="text" id="expense-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter description" required>
                                        </div>

                                        <!-- Date -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                            <input type="date" id="expense-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                        </div>

                                        <!-- Payment Method -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                                            <select id="expense-payment" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="cash">Cash</option>
                                                <option value="credit">Credit Card</option>
                                                <option value="debit">Debit Card</option>
                                                <option value="bank">Bank Transfer</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>

                                        <!-- Notes -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                                            <textarea id="expense-notes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="2" placeholder="Add any additional notes"></textarea>
                                        </div>

                                        <!-- Submit Buttons -->
                                        <div class="flex items-center justify-center space-x-4 mt-4">
                                            <!-- Add Expense Button -->
                                            <button 
                                                type="submit" 
                                                class="w-36 py-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-sm font-semibold shadow-sm hover:from-indigo-600 hover:to-purple-600 transition-all duration-300">
                                                Add Expense
                                            </button>

                                            <!-- Clear Button -->
                                            <button 
                                                type="button" 
                                                id="reset-expense-form" 
                                                class="w-36 py-2.5 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-base font-semibold shadow-sm hover:from-indigo-600 hover:to-purple-600 transition-all duration-300">
                                                Clear
                                            </button>
                                        </div>

                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Expense History (Scrollable Column) -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 fade-in flex flex-col h-[686px]">
                                <div class="p-6 border-b border-gray-200">
                                    <!-- Category Filters -->
                                    <div id="category-filters" class="flex gap-2 flex-wrap mb-4"></div>

                                    <!-- Date Range Filter -->
                                    <div class="mb-4">
                                        <div class="flex flex-wrap items-center gap-3 mb-3">
                                            <!-- Quick Filters -->
                                            <div class="flex items-center gap-2">
                                                <label class="text-sm font-medium text-gray-700">Quick Filter:</label>
                                                <select id="date-range-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                    <option value="all">All Time</option>
                                                    <option value="today">Today</option>
                                                    <option value="week">This Week</option>
                                                    <option value="month">This Month</option>
                                                    <option value="year">This Year</option>
                                                    <option value="custom">Custom Range</option>
                                                </select>
                                            </div>

                                            <!-- Delete All Button -->
                                            <button id="delete-all-expenses-btn" class="ml-auto flex items-center space-x-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition-colors group">
                                                <i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                                                <span>Delete All</span>
                                            </button>
                                        </div>

                                        <!-- Custom Date Range (Hidden by default) -->
                                        <div id="custom-date-range" class="hidden flex items-center gap-2">
                                            <div class="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                                <i data-lucide="calendar" class="w-4 h-4 text-gray-500"></i>
                                                <input type="date" id="expense-date-from" class="bg-transparent border-none outline-none text-sm w-32" placeholder="From">
                                            </div>
                                            <span class="text-gray-400"></span>
                                            <div class="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                                <i data-lucide="calendar" class="w-4 h-4 text-gray-500"></i>
                                                <input type="date" id="expense-date-to" class="bg-transparent border-none outline-none text-sm w-32" placeholder="To">
                                            </div>
                                            <button id="apply-expense-date-range" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700 transition-colors">
                                                Apply
                                            </button>
                                            <button id="clear-expense-date-range" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50 transition-colors">
                                                Clear
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Search and Sort -->
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <div class="flex-1 relative">
                                            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                            <input type="text" id="search-expenses" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search expenses...">
                                        </div>
                                        <select id="sort-expenses" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                            <option value="date-desc">Date (Newest)</option>
                                            <option value="date-asc">Date (Oldest)</option>
                                            <option value="amount-desc">Amount (High to Low)</option>
                                            <option value="amount-asc">Amount (Low to High)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Scrollable History -->
                                <div id="expenses-list-container" class="overflow-y-auto flex-1">
                                    <div id="expenses-list" class="divide-y divide-gray-100"></div>

                                    <!-- Empty State -->
                                    <div id="expenses-empty-state" class="p-12 text-center hidden">
                                        <i data-lucide="receipt" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">No expenses yet</h3>
                                        <p class="text-gray-500 mb-4">Start tracking your expenses</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Expense Modal -->
                <div id="delete-expense-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-lg w-96 p-6 text-center relative">
                        <!-- Red Delete Icon -->
                        <div class="flex justify-center mb-3">
                            <i data-lucide="trash-2" class="w-10 h-10 text-red-600"></i>
                        </div>
                        <h3 class="text-lg font-bold mb-2">Delete Expense</h3>
                        <p class="text-gray-500 mb-6">Are you sure you want to delete this expense? This action cannot be undone.</p>
                        <div class="flex justify-center gap-4">
                            <button id="cancel-delete-expense" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">Cancel</button>
                            <button id="confirm-delete-expense" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- Insufficient Balance Modal for Expenses -->
                <div id="insufficient-expense-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-xl w-96 p-6">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                                <i data-lucide="alert-circle" class="h-6 w-6 text-red-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Insufficient Balance</h3>
                            <div class="text-left mb-4 p-4 bg-red-50 rounded-lg border border-red-200">
                                <p class="text-sm text-gray-700 mb-2">
                                    <span class="font-semibold">Expense Amount:</span> 
                                    <span id="insufficient-expense-cost" class="text-red-600 font-bold"></span>
                                </p>
                                <p class="text-sm text-gray-700 mb-2">
                                    <span class="font-semibold">Available Balance:</span> 
                                    <span id="insufficient-expense-balance" class="text-gray-900 font-bold"></span>
                                </p>
                                <p class="text-sm text-gray-700">
                                    <span class="font-semibold">Shortfall:</span> 
                                    <span id="insufficient-expense-shortfall" class="text-red-600 font-bold"></span>
                                </p>
                            </div>
                            <p class="text-xs text-gray-500 mb-4">
                                You don't have enough balance to add this expense. Please add more income or reduce the expense amount.
                            </p>
                            <button onclick="document.getElementById('insufficient-expense-modal').classList.add('hidden')" class="w-full px-4 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition">
                                Okay, Got It
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Income Page -->
                <div id="income" class="page-section hidden">
                    <div class="mb-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 text-white shadow-lg fade-in">
                        <h3 class="text-lg font-bold mb-2">Income Tracker</h3>
                        <p class="text-indigo-100 text-sm mb-3">Track and manage all your income sources in one place.</p>
                        <div class="flex flex-wrap items-center gap-4 text-sm">
                            <span class="flex items-center">
                                <span class="w-2 h-2 bg-red-300 rounded-full mr-2"></span>Total Income:&nbsp;$<span id="total-income">0</span>
                            </span>
                            <span class="flex items-center">
                                <span class="w-2 h-2 bg-yellow-300 rounded-full mr-2"></span>Income Count:&nbsp;<span id="total-income-transactions">0</span>
                            </span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Add Income Form -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in sticky top-24">
                                <h2 class="text-xl font-bold text-gray-900 mb-4">Add Income</h2>
                                <form id="income-form">
                                    <div class="space-y-4">
                                        <!-- Amount -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                                            <div class="relative">
                                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                                <input type="number" id="income-amount" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0.00" step="0.01" min="0" required>
                                            </div>
                                        </div>

                                        <!-- Source / Category -->
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                        <select id="income-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                            <option value="">Select category</option>
                                        </select>

                                        <!-- Description -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                            <input type="text" id="income-description" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter description" required>
                                        </div>

                                        <!-- Date -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                            <input type="date" id="income-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                        </div>

                                        <!-- Payment Method -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                                            <select id="income-payment" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="cash">Cash</option>
                                                <option value="credit">Credit Card</option>
                                                <option value="debit">Debit Card</option>
                                                <option value="bank">Bank Transfer</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>

                                        <!-- Notes -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                                            <textarea id="income-notes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="2" placeholder="Add any additional notes"></textarea>
                                        </div>

                                        <!-- Buttons -->
                                        <div class="flex items-center justify-center space-x-4 mt-4">
                                            <button type="submit" class="w-36 py-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-sm font-semibold shadow-sm hover:from-indigo-600 hover:to-purple-600 transition-all duration-300">Add Income</button>
                                            <button type="button" id="reset-income-form" class="w-36 py-2.5 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-base font-semibold shadow-sm hover:from-indigo-600 hover:to-purple-600 transition-all duration-300">Clear</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Income History -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 fade-in flex flex-col h-[690px]">
                                <div class="p-6 border-b border-gray-200">
                                    <!-- Category Filters -->
                                    <div id="income-category-filters" class="flex gap-2 flex-wrap mb-4"></div>

                                    <!-- Date Range Filter -->
                                    <div class="mb-4">
                                        <div class="flex flex-wrap items-center gap-3 mb-3">
                                            <!-- Quick Filters -->
                                            <div class="flex items-center gap-2">
                                                <label class="text-sm font-medium text-gray-700">Quick Filter:</label>
                                                <select id="income-date-range-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                    <option value="all">All Time</option>
                                                    <option value="today">Today</option>
                                                    <option value="week">This Week</option>
                                                    <option value="month">This Month</option>
                                                    <option value="year">This Year</option>
                                                    <option value="custom">Custom Range</option>
                                                </select>
                                            </div>

                                            <!-- Delete All Button -->
                                            <button id="delete-all-income-btn" class="ml-auto flex items-center space-x-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition-colors group">
                                                <i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                                                <span>Delete All</span>
                                            </button>
                                        </div>

                                        <!-- Custom Date Range (Hidden by default) -->
                                        <div id="income-custom-date-range" class="hidden flex items-center gap-2">
                                            <div class="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                                <i data-lucide="calendar" class="w-4 h-4 text-gray-500"></i>
                                                <input type="date" id="income-date-from" class="bg-transparent border-none outline-none text-sm w-32" placeholder="From">
                                            </div>
                                            <span class="text-gray-400"></span>
                                            <div class="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                                <i data-lucide="calendar" class="w-4 h-4 text-gray-500"></i>
                                                <input type="date" id="income-date-to" class="bg-transparent border-none outline-none text-sm w-32" placeholder="To">
                                            </div>
                                            <button id="apply-income-date-range" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700 transition-colors">
                                                Apply
                                            </button>
                                            <button id="clear-income-date-range" class="px-3 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50 transition-colors">
                                                Clear
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Search and Sort -->
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <div class="flex-1 relative">
                                            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                            <input type="text" id="search-income" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search income...">
                                        </div>
                                        <select id="sort-income" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                            <option value="date-desc">Date (Newest)</option>
                                            <option value="date-asc">Date (Oldest)</option>
                                            <option value="amount-desc">Amount (High to Low)</option>
                                            <option value="amount-asc">Amount (Low to High)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Scrollable History -->
                                <div id="income-list-container" class="overflow-y-auto flex-1">
                                    <div id="income-list" class="divide-y divide-gray-100"></div>

                                    <!-- Empty State -->
                                    <div id="income-empty-state" class="p-12 text-center hidden">
                                        <i data-lucide="dollar-sign" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">No income yet</h3>
                                        <p class="text-gray-500 mb-4">Start tracking your income</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Modal -->
                 <div id="delete-income-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-lg w-96 p-6 text-center relative">
                        <div class="flex justify-center mb-3">
                            <i data-lucide="trash-2" class="w-10 h-10 text-red-600"></i>
                        </div>
                        <h3 class="text-lg font-bold mb-2">Delete Income</h3>
                        <p class="text-gray-500 mb-6">Are you sure you want to delete this income? This action cannot be undone.</p>
                        <div class="flex justify-center gap-4">
                            <button id="cancel-delete-income" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">Cancel</button>
                            <button id="confirm-delete-income" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete</button>
                        </div>
                    </div>
                </div>

                <div id="accounts" class="page-section">
                    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">Accounts</h2>
                        <p class="text-gray-600">This is the accounts page content. It would show all your financial accounts.</p>
                    </div>
                </div>

                <!-- Budget Page -->
                <div id="budget" class="page-section">
                    <!-- Header Banner -->
                    <div class="mb-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 text-white shadow-lg fade-in">
                        <h3 class="text-lg font-bold mb-2">Budget Planning & Tracking</h3>
                        <p class="text-indigo-100 text-sm mb-3">Set monthly and yearly budget limits for your categories and track your spending progress.</p>
                        <div class="flex flex-wrap items-center gap-4 text-sm">
                            <span class="flex items-center"><span class="w-2 h-2 bg-green-300 rounded-full mr-2"></span>Monthly Budget: $<span id="budget-total-monthly">0</span></span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-yellow-300 rounded-full mr-2"></span>This Month Spent: $<span id="budget-spent-monthly">0</span></span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-blue-300 rounded-full mr-2"></span>Remaining: $<span id="budget-remaining-monthly">0</span></span>
                        </div>
                    </div>

                    <!-- Budget Overview Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <!-- Monthly Budget Card -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg transition-all fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Monthly Budget</p>
                                    <h3 class="text-3xl font-bold text-gray-900">$<span id="budget-overview-monthly">0</span></h3>
                                </div>
                                <div class="bg-indigo-50 p-3 rounded-lg">
                                    <i data-lucide="calendar" class="w-6 h-6 text-indigo-500"></i>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500">Total monthly allocation</p>
                        </div>

                        <!-- Monthly Spent Card -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg transition-all fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">This Month Spent</p>
                                    <h3 class="text-3xl font-bold text-red-600">$<span id="budget-overview-spent-monthly">0</span></h3>
                                </div>
                                <div class="bg-red-50 p-3 rounded-lg">
                                    <i data-lucide="trending-down" class="w-6 h-6 text-red-500"></i>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500" id="budget-spent-percentage-monthly">0% of budget used</p>
                        </div>

                        <!-- Yearly Budget Card -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg transition-all fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Yearly Budget</p>
                                    <h3 class="text-3xl font-bold text-purple-600">$<span id="budget-overview-yearly">0</span></h3>
                                </div>
                                <div class="bg-purple-50 p-3 rounded-lg">
                                    <i data-lucide="target" class="w-6 h-6 text-purple-500"></i>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500">Annual allocation</p>
                        </div>

                        <!-- Year to Date Spent Card -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg transition-all fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">YTD Spent</p>
                                    <h3 class="text-3xl font-bold text-orange-600">$<span id="budget-overview-spent-yearly">0</span></h3>
                                </div>
                                <div class="bg-orange-50 p-3 rounded-lg">
                                    <i data-lucide="bar-chart" class="w-6 h-6 text-orange-500"></i>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500" id="budget-spent-percentage-yearly">0% of yearly budget</p>
                        </div>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="mb-6 fade-in">
                        <div class="flex space-x-2 bg-gray-100 p-1 rounded-lg w-fit">
                            <button id="monthly-tab" class="px-6 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm">
                                Monthly Budget
                            </button>
                            <button id="yearly-tab" class="px-6 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900">
                                Yearly Budget
                            </button>
                        </div>
                    </div>

                    <!-- Monthly Budget Section -->
                    <div id="monthly-budget-section" class="fade-in">
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mb-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-xl font-bold text-gray-900">Monthly Budget by Category</h2>
                                <div class="flex items-center space-x-3">
                                    <select id="monthly-budget-filter" class="px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="all">All Categories</option>
                                        <option value="on-track">On Track</option>
                                        <option value="warning">Warning (70%+)</option>
                                        <option value="over">Over Budget</option>
                                        <option value="no-budget">No Budget Set</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Monthly Budget List -->
                            <div id="monthly-budget-list" class="space-y-4">
                                <!-- Budget items will be populated by JavaScript -->
                            </div>

                            <!-- Empty State -->
                            <div id="monthly-budget-empty-state" class="text-center py-12 hidden">
                                <i data-lucide="target" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No categories found</h3>
                                <p class="text-gray-500 mb-4">Create expense categories to start budgeting</p>
                            </div>
                        </div>
                    </div>

                    <!-- Yearly Budget Section -->
                    <div id="yearly-budget-section" class="hidden fade-in">
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mb-6">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-xl font-bold text-gray-900">Yearly Budget by Category</h2>
                                <p class="text-sm text-gray-500">Set annual spending limits for each category</p>
                            </div>

                            <!-- Yearly Budget List -->
                            <div id="yearly-budget-list" class="space-y-4">
                                <!-- Budget items will be populated by JavaScript -->
                            </div>

                            <!-- Empty State -->
                            <div id="yearly-budget-empty-state" class="text-center py-12 hidden">
                                <i data-lucide="target" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">No categories found</h3>
                                <p class="text-gray-500 mb-4">Create expense categories to start budgeting</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Budget Edit Modal -->
                <div id="budget-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-xl">
                            <div class="flex items-center justify-between">
                                <h3 id="budget-modal-title" class="text-lg font-semibold text-gray-900">Set Budget</h3>
                                <button id="close-budget-modal" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-200 transition-colors">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <div class="p-6">
                            <form id="budget-form">
                                <!-- Category Display -->
                                <div class="mb-4">
                                    <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                                        <div id="budget-modal-icon" class="w-10 h-10 rounded-full flex items-center justify-center"></div>
                                        <div>
                                            <p class="font-semibold text-gray-900" id="budget-modal-category-name"></p>
                                            <p class="text-sm text-gray-500" id="budget-modal-budget-type">Monthly Budget</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Budget Amount -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Budget Amount</label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                        <input type="number" id="budget-amount" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0.00" step="0.01" min="0" required>
                                    </div>
                                </div>

                                <!-- Current Spent Info -->
                                <div class="mb-6 p-3 bg-blue-50 rounded-lg">
                                    <p class="text-sm text-gray-700">
                                        <span class="font-medium">Current spent:</span> $<span id="budget-modal-current-spent">0</span>
                                    </p>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex items-center space-x-3">
                                    <button type="button" id="reset-budget-btn" class="flex-1 px-4 py-2 border border-red-300 rounded-lg text-red-600 hover:bg-red-50 transition-colors">
                                        Reset
                                    </button>
                                    <button type="button" id="cancel-budget-btn" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                                        Cancel
                                    </button>
                                    <button type="submit" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                                        Save
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Savings Page -->
                <div id="savings" class="page-section">
                    <!-- Hero Banner with Key Stats -->
                    <div class="mb-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 text-white shadow-lg fade-in relative overflow-hidden">
                        <div class="absolute inset-0 bg-black opacity-5"></div>
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h3 class="text-2xl font-bold mb-1">Your Savings Journey</h3>
                                    <p class="text-indigo-100 text-sm">Track goals, visualize progress, and build your financial future.</p>
                                </div>
                                <button id="add-savings-goal-btn" class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg font-semibold transition backdrop-blur-sm flex items-center space-x-2">
                                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                                    <span>New Goal</span>
                                </button>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                                <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur-sm">
                                    <p class="text-xs text-indigo-100 mb-1">Total Saved</p>
                                    <p class="text-2xl font-bold">$<span id="banner-total-saved">0</span></p>
                                </div>
                                <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur-sm">
                                    <p class="text-xs text-indigo-100 mb-1">Active Goals</p>
                                    <p class="text-2xl font-bold"><span id="banner-active-goals">0</span></p>
                                </div>
                                <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur-sm">
                                    <p class="text-xs text-indigo-100 mb-1">This Month</p>
                                    <p class="text-2xl font-bold">$<span id="banner-month-saved">0</span></p>
                                </div>
                                <div class="bg-white bg-opacity-10 rounded-lg p-3 backdrop-blur-sm">
                                    <p class="text-xs text-indigo-100 mb-1">Savings Rate</p>
                                    <p class="text-2xl font-bold"><span id="banner-savings-rate">0</span>%</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Grid: Charts + Quick Actions -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Savings Distribution Chart -->
                        <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-gray-100 p-6 fade-in">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">Savings Distribution</h3>
                            <div class="relative" style="height: 280px;">
                                <canvas id="savings-donut-chart"></canvas>
                            </div>
                        </div>

                        <!-- Monthly Growth Chart -->
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6 fade-in">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">Monthly Growth Trend</h3>
                            <div class="relative" style="height: 280px;">
                                <canvas id="savings-growth-chart"></canvas>
                            </div>
                            <div class="mt-4 flex items-center justify-between text-sm text-gray-600">
                                <span>Last 12 months savings activity</span>
                                <span id="growth-total" class="font-semibold text-indigo-600">Total: $0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Smart Insights Panel -->
                    <div id="insights-panel" class="mb-6 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-5 fade-in">
                        <div class="flex items-start space-x-3">
                            <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i data-lucide="lightbulb" class="w-5 h-5 text-white"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-900 mb-2">Smart Insights</h3>
                                <div id="insights-content" class="text-sm text-gray-700 space-y-1">
                                    <!-- Insights populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Savings Goals Section -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-900">Your Goals</h2>
                            <div class="flex items-center space-x-3">
                                <select id="savings-filter" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                                    <option value="all">All Goals</option>
                                    <option value="active">Active</option>
                                    <option value="spent">Spent</option>
                                    <option value="completed">Completed</option>
                                </select>
                                <select id="savings-sort" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                                    <option value="progress-desc">Highest Progress</option>
                                    <option value="progress-asc">Lowest Progress</option>
                                    <option value="amount-desc">Highest Amount</option>
                                    <option value="deadline-asc">Nearest Deadline</option>
                                </select>
                            </div>
                        </div>

                        <!-- Goals Grid -->
                        <div id="savings-goals-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Goals populated by JavaScript -->
                        </div>

                        <!-- Empty State -->
                        <div id="savings-empty-state" class="text-center py-16 hidden">
                            <div class="w-24 h-24 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i data-lucide="target" class="w-12 h-12 text-indigo-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">Start Your Savings Journey</h3>
                            <p class="text-gray-500 mb-6 max-w-md mx-auto">Set your first goal and watch your dreams become achievable milestones!</p>
                            <button id="empty-add-goal-btn" class="px-6 py-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-semibold hover:from-indigo-600 hover:to-purple-600 transition-all shadow-lg">
                                Create Your First Goal
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add/Edit Goal Modal -->
                <div id="savings-goal-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-xl flex-shrink-0">
                            <div class="flex items-center justify-between">
                                <h3 id="savings-modal-title" class="text-lg font-semibold text-gray-900">Create Savings Goal</h3>
                                <button id="close-savings-modal" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-200 transition-colors">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <div class="p-6 overflow-y-auto flex-1">
                            <form id="savings-goal-form">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Goal Name</label>
                                        <input type="text" id="savings-goal-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Emergency Fund" required>
                                    </div>

                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Target Amount</label>
                                            <div class="relative">
                                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                                <input type="number" id="savings-goal-target" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="1000" step="0.01" min="1" required>
                                            </div>
                                        </div>
                                        <div id="current-amount-field" class="hidden">
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Current</label>
                                            <div class="relative">
                                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                                <input type="number" id="savings-goal-current" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="0" step="0.01" min="0">
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Target Date (Optional)</label>
                                        <input type="date" id="savings-goal-deadline" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                        <select id="savings-goal-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                            <option value="emergency">Emergency Fund</option>
                                            <option value="travel">Travel</option>
                                            <option value="purchase">Big Purchase</option>
                                            <option value="education">Education</option>
                                            <option value="home">Home/Property</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Choose Icon</label>
                                        <div class="grid grid-cols-4 gap-2">
                                            <button type="button" class="goal-icon-btn p-3 border-2 border-indigo-500 rounded-lg bg-indigo-50" data-icon="target">
                                                <i data-lucide="target" class="w-5 h-5 text-indigo-600"></i>
                                            </button>
                                            <button type="button" class="goal-icon-btn p-3 border-2 border-gray-200 rounded-lg hover:border-indigo-500" data-icon="piggy-bank">
                                                <i data-lucide="piggy-bank" class="w-5 h-5"></i>
                                            </button>
                                            <button type="button" class="goal-icon-btn p-3 border-2 border-gray-200 rounded-lg hover:border-indigo-500" data-icon="home">
                                                <i data-lucide="home" class="w-5 h-5"></i>
                                            </button>
                                            <button type="button" class="goal-icon-btn p-3 border-2 border-gray-200 rounded-lg hover:border-indigo-500" data-icon="car">
                                                <i data-lucide="car" class="w-5 h-5"></i>
                                            </button>
                                            <button type="button" class="goal-icon-btn p-3 border-2 border-gray-200 rounded-lg hover:border-indigo-500" data-icon="plane">
                                                <i data-lucide="plane" class="w-5 h-5"></i>
                                            </button>
                                            <button type="button" class="goal-icon-btn p-3 border-2 border-gray-200 rounded-lg hover:border-indigo-500" data-icon="graduation-cap">
                                                <i data-lucide="graduation-cap" class="w-5 h-5"></i>
                                            </button>
                                            <button type="button" class="goal-icon-btn p-3 border-2 border-gray-200 rounded-lg hover:border-indigo-500" data-icon="heart">
                                                <i data-lucide="heart" class="w-5 h-5"></i>
                                            </button>
                                            <button type="button" class="goal-icon-btn p-3 border-2 border-gray-200 rounded-lg hover:border-indigo-500" data-icon="gift">
                                                <i data-lucide="gift" class="w-5 h-5"></i>
                                            </button>
                                        </div>
                                        <input type="hidden" id="savings-goal-icon" value="target">
                                    </div>

                                    <div class="flex items-center space-x-3 pt-2">
                                        <button type="button" id="cancel-savings-btn" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                                            Cancel
                                        </button>
                                        <button type="submit" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                                            Save Goal
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Quick Deposit Modal -->
                <div id="quick-deposit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
                    <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-xl">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">Quick Deposit</h3>
                                <button id="close-deposit-modal" class="text-gray-400 hover:text-gray-600 p-1 rounded-lg hover:bg-gray-200 transition">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <div class="p-6">
                            <form id="quick-deposit-form">
                                <input type="hidden" id="deposit-goal-id">
                                <div class="space-y-4">
                                    <div class="text-center bg-indigo-50 rounded-lg p-3 mb-4">
                                        <p class="text-sm text-gray-600">Goal: <span id="deposit-goal-name" class="font-bold text-gray-900"></span></p>
                                        <p class="text-xs text-gray-500">Current: $<span id="deposit-current">0</span> / $<span id="deposit-target">0</span></p>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                            <input type="number" id="deposit-amount" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="0.00" step="0.01" min="0.01" required>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                        <input type="date" id="deposit-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                                    </div>

                                    <div class="flex space-x-3">
                                        <button type="button" id="cancel-deposit-btn" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Cancel</button>
                                        <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">Add Deposit</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Delete Goal Modal -->
                <div id="delete-goal-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-lg w-96 p-6 text-center">
                        <div class="flex justify-center mb-3">
                            <i data-lucide="trash-2" class="w-10 h-10 text-red-600"></i>
                        </div>
                        <h3 class="text-lg font-bold mb-2">Delete Goal</h3>
                        <p class="text-gray-500 mb-6">Are you sure? All progress will be lost.</p>
                        <div class="flex gap-3">
                            <button id="cancel-delete-goal" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">Cancel</button>
                            <button id="confirm-delete-goal" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- Investments Page -->
                <div id="investments" class="page-section hidden">
                    <!-- Header Banner - Matching your project style -->
                    <div class="mb-6 bg-gradient-to-r from-amber-500 via-orange-500 to-yellow-500 rounded-xl p-6 text-white shadow-lg fade-in">
                        <h3 class="text-lg font-bold mb-2">Investment Portfolio</h3>
                        <p class="text-amber-100 text-sm mb-3">Track your stocks, crypto, and other investments in one place.</p>
                        <div class="flex flex-wrap items-center gap-4 text-sm">
                            <span class="flex items-center"><span class="w-2 h-2 bg-green-300 rounded-full mr-2"></span>Portfolio Value: $<span id="banner-portfolio-value">0</span></span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-yellow-300 rounded-full mr-2"></span>Total Invested: $<span id="banner-invested">0</span></span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-blue-300 rounded-full mr-2"></span>Returns: <span id="banner-returns-percent">0</span>%</span>
                        </div>
                    </div>

                    <!-- Overview Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <!-- Portfolio Value Card -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg transition-all fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Portfolio Value</p>
                                    <h3 class="text-3xl font-bold text-gray-900">$<span id="portfolio-value">0</span></h3>
                                </div>
                                <div class="bg-amber-50 p-3 rounded-lg">
                                    <i data-lucide="wallet" class="w-6 h-6 text-amber-500"></i>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500">Current total value</p>
                        </div>

                        <!-- Total Invested Card -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg transition-all fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Total Invested</p>
                                    <h3 class="text-3xl font-bold text-blue-600">$<span id="total-invested">0</span></h3>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <i data-lucide="coins" class="w-6 h-6 text-blue-500"></i>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500">Money put in</p>
                        </div>

                        <!-- Total Returns Card -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg transition-all fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Total Returns</p>
                                    <h3 class="text-3xl font-bold" id="total-returns-amount">$0</h3>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-green-500"></i>
                                </div>
                            </div>
                            <p class="text-sm" id="total-returns-percent">0% gain</p>
                        </div>

                        <!-- Best Performer Card -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg transition-all fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Best Performer</p>
                                    <h3 class="text-2xl font-bold text-purple-600" id="best-performer-name">-</h3>
                                </div>
                                <div class="bg-purple-50 p-3 rounded-lg">
                                    <i data-lucide="trophy" class="w-6 h-6 text-purple-500"></i>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500" id="best-performer-return">-</p>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <!-- Asset Allocation Chart - SMALLER (1 column) -->
                        <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-gray-100 p-6 fade-in">
                            <h3 class="text-lg font-bold mb-4">Asset Allocation</h3>
                            <div class="relative flex items-center justify-center" style="height: 250px; width: 100%; max-width: 250px; margin: 0 auto;">
                                <canvas id="investment-allocation-chart"></canvas>
                            </div>
                            <div id="investment-chart-legend" class="mt-4 space-y-2" style="max-height: 200px; overflow-y: auto;">
                                <!-- Legend populated by JS -->
                            </div>
                        </div>

                        <!-- Portfolio Performance Chart - LARGER (2 columns) -->
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-6 fade-in">
                            <h3 class="text-lg font-bold mb-4">Portfolio Performance</h3>
                            <div class="chart-container">
                                <canvas id="investment-performance-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Grid - Matching Expense/Income layout -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Add Investment Form -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in sticky top-24">
                                <h2 class="text-xl font-bold text-gray-900 mb-4">Add Investment</h2>
                                <form id="investment-form">
                                    <div class="space-y-4">
                                        <!-- Investment Name -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Investment Name</label>
                                            <input type="text" id="investment-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" placeholder="e.g., Apple Stock, Bitcoin" required>
                                        </div>

                                        <!-- Type -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                            <select id="investment-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" required>
                                                <option value="">Select type</option>
                                                <option value="stocks">Stocks</option>
                                                <option value="crypto">Cryptocurrency</option>
                                                <option value="mutual-funds">Mutual Funds</option>
                                                <option value="real-estate">Real Estate</option>
                                                <option value="bonds">Bonds/FDs</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>

                                        <!-- Purchase Date -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Purchase Date</label>
                                            <input type="date" id="investment-purchase-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" required>
                                        </div>

                                        <!-- Quantity -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                                            <input type="number" id="investment-quantity" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" placeholder="e.g., 10" step="0.01" min="0.01" required>
                                        </div>

                                        <!-- Purchase Price -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Purchase Price (per unit)</label>
                                            <div class="relative">
                                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                                <input type="number" id="investment-purchase-price" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" placeholder="0.00" step="0.01" min="0" required>
                                            </div>
                                        </div>

                                        <!-- Notes -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                                            <textarea id="investment-notes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" rows="2" placeholder="Add any additional notes"></textarea>
                                        </div>

                                        <!-- Buttons - Matching your button style -->
                                        <div class="flex items-center justify-center space-x-4 mt-4">
                                            <button type="submit" class="w-36 py-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-sm font-semibold shadow-sm hover:from-indigo-600 hover:to-purple-600 transition-all duration-300">
                                                Add Investment
                                            </button>
                                            <button type="button" id="reset-investment-form" class="w-36 py-2.5 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-base font-semibold shadow-sm hover:from-indigo-600 hover:to-purple-600 transition-all duration-300">
                                                Clear
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Investments List - Matching your layout -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 fade-in flex flex-col h-[686px]">
                                <div class="p-6 border-b border-gray-200">
                                    <h2 class="text-xl font-bold text-gray-900 mb-4">Your Holdings</h2>

                                    <!-- Type Filters (like Expense Categories) -->
                                    <div id="investment-category-filters" class="flex gap-2 flex-wrap mb-4">
                                        <!-- Will be populated by JavaScript -->
                                    </div>

                                    <!-- Quick Filter + Delete All + Search + Sort -->
                                    <div class="flex flex-wrap items-center gap-2 mb-4">
                                        <div class="flex items-center gap-2">
                                            <label class="text-sm font-medium text-gray-700">Quick Filter:</label>
                                            <select id="investment-date-range-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                                                <option value="all">All Time</option>
                                                <option value="today">Today</option>
                                                <option value="week">This Week</option>
                                                <option value="month">This Month</option>
                                                <option value="year">This Year</option>
                                                <option value="custom">Custom Range</option>
                                            </select>
                                        </div>

                                        <!-- Custom Date Range (Hidden by default) -->
                                        <div id="custom-investment-date-range" class="flex items-center gap-2 hidden">
                                            <input type="date" id="investment-date-from" class="px-2 py-1 border border-gray-300 rounded text-sm">
                                            <span class="text-gray-500">to</span>
                                            <input type="date" id="investment-date-to" class="px-2 py-1 border border-gray-300 rounded text-sm">
                                            <button id="apply-investment-date-range" class="px-3 py-1 bg-amber-600 text-white rounded text-sm hover:bg-amber-700">Apply</button>
                                            <button id="clear-investment-date-range" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">Clear</button>
                                        </div>

                                        <!-- Delete All Button -->
                                        <button id="delete-all-investments-btn" class="ml-auto flex items-center space-x-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition-colors duration-200">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            <span>Delete All</span>
                                        </button>
                                    </div>

                                    <!-- Search and Sort -->
                                    <div class="flex flex-wrap items-center gap-2">
                                        <div class="relative flex-1 min-w-[200px]">
                                            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                            <input type="text" id="search-investments" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500" placeholder="Search investments...">
                                        </div>
                                        <select id="sort-investments" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                                            <option value="date-desc">Date (Newest)</option>
                                            <option value="date-asc">Date (Oldest)</option>
                                            <option value="amount-desc">Value (High to Low)</option>
                                            <option value="amount-asc">Value (Low to High)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Investments List Container -->
                                <div id="investments-list-container" class="overflow-y-auto flex-1">
                                    <div id="investments-list" class="divide-y divide-gray-100">
                                        <!-- Investments will be populated by JavaScript -->
                                    </div>

                                    <!-- Empty State -->
                                    <div id="investments-empty-state" class="p-12 text-center hidden">
                                        <i data-lucide="trending-up" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">No investments yet</h3>
                                        <p class="text-gray-500 mb-4">Start building your portfolio by adding your first investment!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete All Investments Confirmation Modal -->
                <div id="delete-all-investments-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-xl w-96 mx-4 p-6">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                                <i data-lucide="trash-2" class="h-6 w-6 text-red-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Delete All Investments?</h3>
                            <p class="text-sm text-gray-500 mb-6">
                                This will permanently delete all <span id="delete-all-investments-count" class="font-semibold text-red-600">0</span> investments. 
                                This action cannot be undone.
                            </p>
                            <div class="flex space-x-3">
                                <button id="cancel-delete-all-investments" class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition">
                                    Cancel
                                </button>
                                <button id="confirm-delete-all-investments" class="flex-1 px-4 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition">
                                    Delete All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Update Investment Modal -->
                <div id="update-price-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-xl w-96 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-900">Update Current Price</h3>
                            <button id="close-update-modal" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <form id="update-price-form">
                            <input type="hidden" id="update-investment-id">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Investment</label>
                                <p id="update-investment-name" class="font-semibold text-gray-900"></p>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">New Current Price</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                    <input type="number" id="update-new-price" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" step="0.01" min="0" required>
                                </div>
                            </div>
                            <div class="flex space-x-3">
                                <button type="button" id="cancel-update" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">Cancel</button>
                                <button type="submit" class="flex-1 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition">Update</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Delete Investment Modal -->
                <div id="delete-investment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-lg w-96 p-6 text-center">
                        <div class="flex justify-center mb-3">
                            <i data-lucide="trash-2" class="w-10 h-10 text-red-600"></i>
                        </div>
                        <h3 class="text-lg font-bold mb-2">Delete Investment</h3>
                        <p class="text-gray-500 mb-6">Are you sure you want to delete this investment? This action cannot be undone.</p>
                        <div class="flex justify-center gap-4">
                            <button id="cancel-delete-investment" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">Cancel</button>
                            <button id="confirm-delete-investment" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- Mark Sold Confirmation Modal -->
                <div id="mark-sold-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-xl w-96 p-6">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                                <i data-lucide="dollar-sign" class="h-6 w-6 text-green-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Mark Investment as Sold</h3>
                            <div class="text-left mb-4 p-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600 mb-2"><span class="font-semibold">Investment:</span> <span id="sold-investment-name"></span></p>
                                <p class="text-sm text-gray-600 mb-2"><span class="font-semibold">Sale Value:</span> <span id="sold-investment-value" class="text-green-600 font-bold"></span></p>
                                <p class="text-sm text-gray-600 mb-2"><span class="font-semibold">Profit/Loss:</span> <span id="sold-investment-returns"></span></p>
                                <p class="text-xs text-gray-500 mt-2">This will create an income entry and remove the investment from tracking.</p>
                            </div>
                            <div class="flex space-x-3">
                                <button id="cancel-mark-sold" class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition">
                                    Cancel
                                </button>
                                <button id="confirm-mark-sold" class="flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition">
                                    Confirm Sale
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insufficient Balance Modal -->
                <div id="insufficient-balance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-xl w-96 p-6">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                                <i data-lucide="alert-circle" class="h-6 w-6 text-red-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Insufficient Balance</h3>
                            <div class="text-left mb-4 p-4 bg-red-50 rounded-lg border border-red-200">
                                <p class="text-sm text-gray-700 mb-2">
                                    <span class="font-semibold">Investment Cost:</span> 
                                    <span id="insufficient-investment-cost" class="text-red-600 font-bold"></span>
                                </p>
                                <p class="text-sm text-gray-700 mb-2">
                                    <span class="font-semibold">Available Balance:</span> 
                                    <span id="insufficient-available-balance" class="text-gray-900 font-bold"></span>
                                </p>
                                <p class="text-sm text-gray-700">
                                    <span class="font-semibold">Shortfall:</span> 
                                    <span id="insufficient-shortfall" class="text-red-600 font-bold"></span>
                                </p>
                            </div>
                            <p class="text-xs text-gray-500 mb-4">
                                You don't have enough balance to purchase this investment. Please add more income or reduce the investment amount.
                            </p>
                            <button id="close-insufficient-balance" class="w-full px-4 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition">
                                Okay, Got It
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bills & Payments Page -->
                <div id="bills" class="page-section">
                    <!-- Header Banner - Matching Expense/Income style -->
                    <div class="mb-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-6 text-white shadow-lg fade-in">
                        <h3 class="text-lg font-bold mb-2">Bills & Payments Management</h3>
                        <p class="text-indigo-100 text-sm mb-3">Never miss a payment. Schedule and track all your recurring bills in one place.</p>
                        <div class="flex flex-wrap items-center gap-4 text-sm">
                            <span class="flex items-center"><span class="w-2 h-2 bg-red-300 rounded-full mr-2"></span>Upcoming Bills: <span id="upcoming-bills-count">0</span></span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-yellow-300 rounded-full mr-2"></span>Due This Week: <span id="due-this-week-count">0</span></span>
                            <span class="flex items-center"><span class="w-2 h-2 bg-green-300 rounded-full mr-2"></span>Total Monthly: $<span id="total-monthly-bills">0</span></span>
                        </div>
                    </div>

                    <!-- Overview Cards - Matching existing card style -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <!-- Total Bills Card -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg transition-all fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Total Bills</p>
                                    <h3 class="text-3xl font-bold text-gray-900"><span id="total-bills-count">0</span></h3>
                                </div>
                                <div class="bg-indigo-50 p-3 rounded-lg">
                                    <i data-lucide="receipt" class="w-6 h-6 text-indigo-500"></i>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500">Active recurring bills</p>
                        </div>

                        <!-- Due This Week Card -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg transition-all fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Due This Week</p>
                                    <h3 class="text-3xl font-bold text-orange-600">$<span id="due-week-amount">0</span></h3>
                                </div>
                                <div class="bg-orange-50 p-3 rounded-lg">
                                    <i data-lucide="alert-circle" class="w-6 h-6 text-orange-500"></i>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500"><span id="due-week-bills">0</span> bills pending</p>
                        </div>

                        <!-- Paid This Month Card -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg transition-all fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Paid This Month</p>
                                    <h3 class="text-3xl font-bold text-green-600">$<span id="paid-month-amount">0</span></h3>
                                </div>
                                <div class="bg-green-50 p-3 rounded-lg">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500"><span id="paid-month-count">0</span> bills paid</p>
                        </div>

                        <!-- Overdue Card -->
                        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-lg transition-all fade-in">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium mb-1">Overdue</p>
                                    <h3 class="text-3xl font-bold text-red-600">$<span id="overdue-amount">0</span></h3>
                                </div>
                                <div class="bg-red-50 p-3 rounded-lg">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-500"></i>
                                </div>
                            </div>
                            <p class="text-sm text-gray-500"><span id="overdue-count">0</span> bills overdue</p>
                        </div>
                    </div>

                    <!-- Main Content Grid - Same layout as Expense/Income -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Add Bill Form - Matching Expense form style -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in sticky top-24">
                                <h2 class="text-xl font-bold text-gray-900 mb-4">Add Bill</h2>
                                <form id="bill-form">
                                    <div class="space-y-4">
                                        <!-- Bill Name -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Bill Name</label>
                                            <input type="text" id="bill-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Electric Bill" required>
                                        </div>

                                        <!-- Category -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                            <select id="bill-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                                <option value="">Select category</option>
                                                <option value="utilities">Utilities</option>
                                                <option value="rent">Rent/Mortgage</option>
                                                <option value="insurance">Insurance</option>
                                                <option value="subscriptions">Subscriptions</option>
                                                <option value="loans">Loans</option>
                                                <option value="credit-card">Credit Card</option>
                                                <option value="internet">Internet/Phone</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>

                                        <!-- Amount -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                                            <div class="relative">
                                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">$</span>
                                                <input type="number" id="bill-amount" class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0.00" step="0.01" min="0" required>
                                            </div>
                                        </div>

                                        <!-- Due Date -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                                            <input type="date" id="bill-due-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                                        </div>

                                        <!-- Frequency -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Frequency</label>
                                            <select id="bill-frequency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="monthly">Monthly</option>
                                                <option value="quarterly">Quarterly</option>
                                                <option value="yearly">Yearly</option>
                                                <option value="one-time">One-time</option>
                                            </select>
                                        </div>

                                        <!-- Reminder -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Remind Me</label>
                                            <select id="bill-reminder" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="0">On due date</option>
                                                <option value="1">1 day before</option>
                                                <option value="3">3 days before</option>
                                                <option value="7">1 week before</option>
                                            </select>
                                        </div>

                                        <!-- Notes -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                                            <textarea id="bill-notes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="2" placeholder="Add any additional notes"></textarea>
                                        </div>

                                        <!-- Buttons - Same style as Expense/Income -->
                                        <div class="flex items-center justify-center space-x-4 mt-4">
                                            <button type="submit" class="w-36 py-3 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-sm font-semibold shadow-sm hover:from-indigo-600 hover:to-purple-600 transition-all duration-300">
                                                Add Bill
                                            </button>
                                            <button type="button" id="reset-bill-form" class="w-36 py-2.5 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white text-base font-semibold shadow-sm hover:from-indigo-600 hover:to-purple-600 transition-all duration-300">
                                                Clear
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Bills List - Matching Expense/Income list style -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 fade-in flex flex-col h-[770px]">
                                <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white rounded-t-xl flex-shrink-0">
                                    <div class="flex items-center mb-4">
                                        <h2 class="text-xl font-bold text-gray-900">Your Bills</h2>
                                    </div>

                                    <!-- Category Filters -->
                                    <div id="bills-category-filters" class="flex gap-2 flex-wrap mb-4">
                                        <!-- Will be populated by JavaScript -->
                                    </div>

                                    <!-- Quick Filter + Delete All + Search + Sort -->
                                    <div class="flex flex-wrap items-center gap-2 mb-4">
                                        <div class="flex items-center gap-2">
                                            <label class="text-sm font-medium text-gray-700">Quick Filter:</label>
                                            <select id="bills-date-range-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="all">All Time</option>
                                                <option value="today">Today</option>
                                                <option value="week">This Week</option>
                                                <option value="month">This Month</option>
                                                <option value="year">This Year</option>
                                                <option value="custom">Custom Range</option>
                                            </select>
                                        </div>

                                        <!-- Custom Date Range (Hidden by default) -->
                                        <div id="custom-bills-date-range" class="flex items-center gap-2 hidden">
                                            <input type="date" id="bills-date-from" class="px-2 py-1 border border-gray-300 rounded text-sm">
                                            <span class="text-gray-500">to</span>
                                            <input type="date" id="bills-date-to" class="px-2 py-1 border border-gray-300 rounded text-sm">
                                            <button id="apply-bills-date-range" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">Apply</button>
                                            <button id="clear-bills-date-range" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">Clear</button>
                                        </div>

                                        <!-- Delete All Button -->
                                        <button id="delete-all-bills-btn" class="ml-auto flex items-center space-x-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition-colors duration-200">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            <span>Delete All</span>
                                        </button>
                                    </div>

                                    <!-- Search and Sort -->
                                    <div class="flex flex-wrap items-center gap-2">
                                        <div class="relative flex-1 min-w-[200px]">
                                            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                            <input type="text" id="search-bills" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500" placeholder="Search bills...">
                                        </div>
                                        <select id="sort-bills" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                            <option value="date-desc">Date (Newest)</option>
                                            <option value="date-asc">Date (Oldest)</option>
                                            <option value="amount-desc">Amount (High to Low)</option>
                                            <option value="amount-asc">Amount (Low to High)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Bills List Container - Scrollable like Expense/Income -->
                                <div id="bills-list-container" class="overflow-y-auto flex-1">
                                    <div id="bills-list" class="divide-y divide-gray-100">
                                        <!-- Bills will be populated by JavaScript -->
                                    </div>

                                    <!-- Empty State -->
                                    <div id="bills-empty-state" class="p-12 text-center hidden">
                                        <i data-lucide="receipt" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                                        <h3 class="text-lg font-medium text-gray-900 mb-2">No bills yet</h3>
                                        <p class="text-gray-500 mb-4">Start adding your bills to stay organized</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete All Bills Confirmation Modal (Narrower) -->
                <div id="delete-all-bills-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-xl w-96 mx-4 p-6">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                                <i data-lucide="trash-2" class="h-6 w-6 text-red-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Delete All Bills?</h3>
                            <p class="text-sm text-gray-500 mb-6">
                                This will permanently delete all <span id="delete-all-bills-count" class="font-semibold text-red-600">0</span> bills. 
                                This action cannot be undone.
                            </p>
                            <div class="flex space-x-3">
                                <button id="cancel-delete-all-bills" class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition">
                                    Cancel
                                </button>
                                <button id="confirm-delete-all-bills" class="flex-1 px-4 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition">
                                    Delete All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mark Paid Confirmation Modal -->
                <div id="mark-paid-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-xl w-96 p-6">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                                <i data-lucide="check-circle" class="h-6 w-6 text-green-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Mark Bill as Paid</h3>
                            <div class="text-left mb-4 p-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600 mb-2"><span class="font-semibold">Bill:</span> <span id="paid-bill-name"></span></p>
                                <p class="text-sm text-gray-600 mb-2"><span class="font-semibold">Amount:</span> <span id="paid-bill-amount" class="text-green-600 font-bold"></span></p>
                                <p class="text-sm text-gray-600"><span class="font-semibold">Due Date:</span> <span id="paid-bill-date"></span></p>
                                <p class="text-xs text-gray-500 mt-2">This will remove the bill from tracking. The expense has already been recorded.</p>
                            </div>
                        </div>
                        <div class="flex space-x-3">
                            <button id="cancel-mark-paid" class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium transition">
                                Cancel
                            </button>
                            <button id="confirm-mark-paid" class="flex-1 px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition">
                                Confirm Payment
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Insufficient Balance Modal for Bills -->
                <div id="insufficient-bill-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-xl w-96 p-6">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                                <i data-lucide="alert-circle" class="h-6 w-6 text-red-600"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900 mb-2">Insufficient Balance</h3>
                            <div class="text-left mb-4 p-4 bg-red-50 rounded-lg border border-red-200">
                                <p class="text-sm text-gray-700 mb-2">
                                    <span class="font-semibold">Bill Cost:</span> 
                                    <span id="insufficient-bill-cost" class="text-red-600 font-bold"></span>
                                </p>
                                <p class="text-sm text-gray-700 mb-2">
                                    <span class="font-semibold">Available Balance:</span> 
                                    <span id="insufficient-bill-balance" class="text-gray-900 font-bold"></span>
                                </p>
                                <p class="text-sm text-gray-700">
                                    <span class="font-semibold">Shortfall:</span> 
                                    <span id="insufficient-bill-shortfall" class="text-red-600 font-bold"></span>
                                </p>
                            </div>
                            <p class="text-xs text-gray-500 mb-4">
                                You don't have enough balance to add this bill. Please add more income or reduce the bill amount.
                            </p>
                            <button id="close-insufficient-bill" onclick="document.getElementById('insufficient-bill-modal').classList.add('hidden')" class="w-full px-4 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium transition">
                                Okay, Got It
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Delete Bill Modal -->
                <div id="delete-bill-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                    <div class="bg-white rounded-xl shadow-lg w-96 p-6 text-center">
                        <div class="flex justify-center mb-3">
                            <i data-lucide="trash-2" class="w-10 h-10 text-red-600"></i>
                        </div>
                        <h3 class="text-lg font-bold mb-2">Delete Bill</h3>
                        <p class="text-gray-500 mb-6">Are you sure you want to delete this bill? This action cannot be undone.</p>
                        <div class="flex justify-center gap-4">
                            <button id="cancel-delete-bill" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">Cancel</button>
                            <button id="confirm-delete-bill" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- <div id="reports" class="page-section">
                    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">Reports</h2>
                        <p class="text-gray-600">This is the reports page content. It would show detailed financial reports and analytics.</p>
                    </div>
                </div> -->

                <div id="reports" class="page-section">
                    <!-- Financial Reports Download Section -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-100 fade-in">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                                    <i data-lucide="bar-chart-3" class="w-6 h-6 text-indigo-600"></i>
                                    Financial Reports
                                </h2>
                                <p class="text-sm text-gray-600 mt-1">Download comprehensive financial reports in multiple formats</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- PDF Report -->
                            <div class="border border-gray-200 rounded-lg p-4 hover:border-indigo-500 hover:shadow-md transition-all duration-200">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-12 h-12 rounded-lg bg-red-100 flex items-center justify-center">
                                        <i data-lucide="file-text" class="w-6 h-6 text-red-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-900">PDF Report</h3>
                                        <p class="text-xs text-gray-500">Professional format</p>
                                    </div>
                                </div>
                                <button id="btn-download-pdf" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    Download PDF
                                </button>
                            </div>
                            
                            <!-- Excel Report -->
                            <div class="border border-gray-200 rounded-lg p-4 hover:border-indigo-500 hover:shadow-md transition-all duration-200">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-12 h-12 rounded-lg bg-green-100 flex items-center justify-center">
                                        <i data-lucide="file-spreadsheet" class="w-6 h-6 text-green-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-900">Excel Report</h3>
                                        <p class="text-xs text-gray-500">Spreadsheet format</p>
                                    </div>
                                </div>
                                <button id="btn-download-excel" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    Download Excel
                                </button>
                            </div>
                            
                            <!-- CSV Report -->
                            <div class="border border-gray-200 rounded-lg p-4 hover:border-indigo-500 hover:shadow-md transition-all duration-200">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center">
                                        <i data-lucide="file-down" class="w-6 h-6 text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-900">CSV Report</h3>
                                        <p class="text-xs text-gray-500">Universal format</p>
                                    </div>
                                </div>
                                <button id="btn-download-csv" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    Download CSV
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Reports Info (Optional) -->
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl shadow-sm p-6 border border-indigo-100 fade-in">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
                            <i data-lucide="info" class="w-5 h-5 text-indigo-600"></i>
                            Report Information
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-900">Comprehensive Data</p>
                                    <p class="text-gray-600 mt-1">All income, expenses, and savings included</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="filter" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-900">Smart Filtering</p>
                                    <p class="text-gray-600 mt-1">Automatically separates regular and savings expenses</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="calendar" class="w-5 h-5 text-purple-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-900">Date Stamped</p>
                                    <p class="text-gray-600 mt-1">Every report includes generation date</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="shield-check" class="w-5 h-5 text-orange-600"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-900">Privacy First</p>
                                    <p class="text-gray-600 mt-1">All data stays on your device</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="calendar" class="page-section">
                    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">Financial Calendar</h2>
                        <p class="text-gray-600">This is the financial calendar page content. It would show your financial events and deadlines.</p>
                    </div>
                </div>

                <div id="security" class="page-section">
                    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 fade-in">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">Security</h2>
                        <p class="text-gray-600">This is the security page content. It would show your account security settings.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Delete All Confirmation Modal -->
    <div id="delete-all-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl shadow-lg w-96 p-6 text-center relative transform transition-all">
            <div class="flex justify-center mb-4">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center">
                    <i data-lucide="alert-triangle" class="w-8 h-8 text-red-600"></i>
                </div>
            </div>
            <h3 class="text-lg font-bold mb-2" id="delete-all-modal-title">Delete All Expenses?</h3>
            <p class="text-gray-500 mb-6" id="delete-all-modal-message">Are you sure you want to delete all expenses? This will remove <span id="delete-all-count" class="font-semibold text-gray-900">0</span> items and cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-all" class="px-5 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">Cancel</button>
                <button id="confirm-delete-all" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete All</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Toggle sidebar on mobile
        const menuToggle = document.getElementById('menu-toggle');
        const closeSidebar = document.getElementById('close-sidebar');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        menuToggle.addEventListener('click', () => {
            sidebar.classList.add('open');
            sidebarOverlay.classList.remove('hidden');
        });

        closeSidebar.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.add('hidden');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.add('hidden');
        });

        // Navigation functionality
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const pageSections = document.querySelectorAll('.page-section');

        sidebarItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
            
                // Remove active class from all sidebar items
                sidebarItems.forEach(i => {
                    i.classList.remove('active', 'bg-indigo-50', 'text-indigo-700');
                    i.classList.add('hover:bg-gray-50', 'text-gray-700', 'hover:text-gray-900');
                });
            
                // Add active class to clicked item
                this.classList.add('active', 'bg-indigo-50', 'text-indigo-700');
                this.classList.remove('hover:bg-gray-50', 'text-gray-700', 'hover:text-gray-900');
            
                // Get the target page
                const targetPage = this.getAttribute('data-page');
                
                // Hide all page sections
                pageSections.forEach(section => {
                    section.classList.remove('active');
                });
            
                // Show the target page
                document.getElementById(targetPage).classList.add('active');
                
                //  SCROLL TO TOP - ADD THIS
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.scrollTo({
                        top: 0,
                        behavior: 'smooth' // Change to 'instant' for immediate scroll
                    });
                }
                
                // Close sidebar on mobile after selection
                if (window.innerWidth < 1024) {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.add('hidden');
                }
            });
        });

        // Initialize charts
        document.addEventListener('DOMContentLoaded', function() {

            // Dashboard Manager Class
            class DashboardManager {
                constructor(expenseManager, incomeManager, budgetManager, savingsManager, investmentManager, billsManager, categoryManager) {
                    this.expenseManager = expenseManager;
                    this.incomeManager = incomeManager;
                    this.budgetManager = budgetManager;
                    this.savingsManager = savingsManager;
                    this.investmentManager = investmentManager;
                    this.billsManager = billsManager;
                    this.categoryManager = categoryManager;
                    this.budgetViewExpanded = false;
                    this.transactionsViewExpanded = false;
                    this.billsViewExpanded = false;
                    
                    console.log(' DashboardManager: Initializing...');
                    this.init();
                }

                init() {
                    // Update immediately
                    this.updateDashboard();
                    console.log(' Dashboard initialized with real data');
                    
                    // Update dashboard when clicking on dashboard link
                    document.querySelectorAll('[data-page="dashboard"]').forEach(link => {
                        link.addEventListener('click', () => {
                            this.updateDashboard();
                        });
                    });
                    
                    // Setup toggles
                    this.setupBudgetToggle();
                    this.setupTransactionsToggle();
                    this.setupBillsToggle();
                }

                updateDashboard() {
                    console.log(' Updating dashboard...');
                    this.updateFinancialHealth();
                    this.updateStatsCards();
                    this.updateCashFlowChart();
                    this.updateCategoryChart();
                    this.updateBudgetProgress();
                    this.updateRecentTransactions();
                    this.updateUpcomingBills();
                    this.updateSavingsChart();
                    lucide.createIcons();
                    console.log(' Dashboard update complete!');
                }

                updateFinancialHealth() {
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();

                    // Calculate current month's income and expenses
                    const monthlyIncome = this.incomeManager.incomes
                        .filter(inc => {
                            const date = new Date(inc.date);
                            return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                        })
                        .reduce((sum, inc) => sum + inc.amount, 0);

                    const monthlyExpenses = this.expenseManager.expenses
                        .filter(exp => {
                            const date = new Date(exp.date);
                            return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                        })
                        .reduce((sum, exp) => sum + exp.amount, 0);

                    // Get net savings
                    const netSavings = this.savingsManager && this.savingsManager.goals 
                        ? this.savingsManager.goals.reduce((sum, goal) => sum + goal.current, 0) 
                        : 0;

                    // Calculate metrics
                    const spendingRatio = monthlyIncome > 0 ? (monthlyExpenses / monthlyIncome) * 100 : 0;
                    const savingsRatio = monthlyIncome > 0 ? (netSavings / monthlyIncome) * 100 : 0;

                    // Calculate health score (0-100)
                    let healthScore = 0;
                    
                    // Budget metric (40 points): spending < 70% of income is excellent
                    if (spendingRatio <= 50) {
                        healthScore += 40;
                    } else if (spendingRatio <= 70) {
                        healthScore += 30;
                    } else if (spendingRatio <= 90) {
                        healthScore += 15;
                    }
                    
                    // Savings metric (40 points): having savings is good
                    if (savingsRatio >= 20) {
                        healthScore += 40;
                    } else if (savingsRatio >= 10) {
                        healthScore += 30;
                    } else if (savingsRatio >= 5) {
                        healthScore += 20;
                    } else if (netSavings > 0) {
                        healthScore += 10;
                    }
                    
                    // Debt metric (20 points): No debt = full points (for now)
                    healthScore += 20;

                    // Update UI - Score
                    document.getElementById('health-score').textContent = Math.round(healthScore);

                    // Update UI - Message
                    const messageEl = document.getElementById('health-message');
                    if (healthScore >= 80) {
                        messageEl.textContent = 'Excellent! You are on track with your financial goals.';
                    } else if (healthScore >= 60) {
                        messageEl.textContent = 'Good job! Keep improving your financial health.';
                    } else if (healthScore >= 40) {
                        messageEl.textContent = 'Fair. Consider reducing expenses and building savings.';
                    } else {
                        messageEl.textContent = 'Needs attention. Focus on budgeting and saving.';
                    }

                    // Update UI - Budget indicator
                    const budgetIndicator = document.getElementById('budget-indicator');
                    const budgetText = document.getElementById('budget-text');
                    
                    if (spendingRatio <= 70) {
                        budgetIndicator.className = 'w-2 h-2 bg-green-300 rounded-full mr-2';
                        budgetText.textContent = 'Budget: On Track';
                    } else if (spendingRatio <= 90) {
                        budgetIndicator.className = 'w-2 h-2 bg-yellow-300 rounded-full mr-2';
                        budgetText.textContent = 'Budget: Watch Spending';
                    } else {
                        budgetIndicator.className = 'w-2 h-2 bg-red-300 rounded-full mr-2';
                        budgetText.textContent = 'Budget: Over Limit';
                    }

                    // Update UI - Savings indicator
                    const savingsIndicator = document.getElementById('savings-indicator');
                    const savingsText = document.getElementById('savings-text');
                    
                    if (savingsRatio >= 20) {
                        savingsIndicator.className = 'w-2 h-2 bg-green-300 rounded-full mr-2';
                        savingsText.textContent = `Savings: Excellent (${savingsRatio.toFixed(1)}%)`;
                    } else if (savingsRatio >= 10) {
                        savingsIndicator.className = 'w-2 h-2 bg-green-300 rounded-full mr-2';
                        savingsText.textContent = `Savings: Good (${savingsRatio.toFixed(1)}%)`;
                    } else if (netSavings > 0) {
                        savingsIndicator.className = 'w-2 h-2 bg-yellow-300 rounded-full mr-2';
                        savingsText.textContent = `Savings: Building (${savingsRatio.toFixed(1)}%)`;
                    } else {
                        savingsIndicator.className = 'w-2 h-2 bg-red-300 rounded-full mr-2';
                        savingsText.textContent = 'Savings: Start Saving';
                    }

                    console.log(' Financial health updated:', {
                        score: Math.round(healthScore),
                        spendingRatio: spendingRatio.toFixed(1) + '%',
                        savingsRatio: savingsRatio.toFixed(1) + '%'
                    });
                }

                updateStatsCards() {
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    
                    // Calculate Monthly Income
                    const monthlyIncome = this.incomeManager.incomes
                        .filter(inc => {
                            const date = new Date(inc.date);
                            return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                        })
                        .reduce((sum, inc) => sum + inc.amount, 0);
                    
                    //  Calculate Monthly Expenses (INCLUDE savings-spent for display)
                    const monthlyExpenses = this.expenseManager.expenses
                        .filter(exp => {
                            const date = new Date(exp.date);
                            return date.getMonth() === currentMonth && 
                                date.getFullYear() === currentYear;
                            //  NO FILTER - show all expenses
                        })
                        .reduce((sum, exp) => sum + exp.amount, 0);
                    
                    // Total Income
                    const totalIncome = this.incomeManager.incomes.reduce((sum, inc) => sum + inc.amount, 0);
                    
                    //  Total Expenses for DISPLAY (include all)
                    const totalExpensesDisplay = this.expenseManager.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                    
                    //  Total Expenses for BALANCE (exclude isSavingsSpent)
                    const totalExpensesForBalance = this.expenseManager.expenses
                        .filter(exp => !exp.isSavingsSpent)
                        .reduce((sum, exp) => sum + exp.amount, 0);
                    
                    // For BALANCE calculation: Include ALL goals (including spent)
                    const totalSavingsForBalance = this.savingsManager && this.savingsManager.goals 
                        ? this.savingsManager.goals.reduce((sum, g) => sum + (g.current || 0), 0)
                        : 0;
                    
                    //  NEW: Get reserved amount for unpaid bills
                    const reservedForBills = this.billsManager && typeof this.billsManager.getReservedAmount === 'function'
                        ? this.billsManager.getReservedAmount()
                        : 0;
                    
                    //  Balance = Income - (Expenses excluding savings-spent) - All Savings - Reserved Bills
                    const totalBalance = totalIncome - totalExpensesForBalance - totalSavingsForBalance - reservedForBills;
                    
                    // For NET SAVINGS display: Exclude spent goals
                    const netSavings = this.savingsManager && this.savingsManager.goals 
                        ? this.savingsManager.goals
                            .filter(g => !g.markedSpent)
                            .reduce((sum, g) => sum + (g.current || 0), 0)
                        : 0;
                    
                    // Calculate expense percentage of income
                    let expensePercentage = 0;
                    if (monthlyIncome > 0) {
                        expensePercentage = (monthlyExpenses / monthlyIncome) * 100;
                    } else if (monthlyExpenses > 0) {
                        expensePercentage = 100;
                    }
                    
                    // Determine color based on percentage
                    const expenseColor = expensePercentage < 50 ? 'text-green-500' : expensePercentage < 80 ? 'text-yellow-500' : 'text-red-500';
                    
                    // Update Total Balance
                    const balanceEl = document.getElementById('dashboard-total-balance');
                    if (balanceEl) {
                        balanceEl.textContent = '$' + totalBalance.toFixed(2);
                        this.updateChangeIndicator('dashboard-balance-change', 'Available Balance', 'wallet', 'text-gray-500');
                    }
                    
                    // Update Monthly Income
                    const incomeEl = document.getElementById('dashboard-monthly-income');
                    if (incomeEl) {
                        incomeEl.textContent = '$' + monthlyIncome.toFixed(2);
                        this.updateChangeIndicator('dashboard-income-change', 'Current Month', 'trending-up', 'text-gray-500');
                    }
                    
                    // Update Monthly Expenses with percentage (shows all expenses)
                    const expenseEl = document.getElementById('dashboard-monthly-expenses');
                    if (expenseEl) {
                        expenseEl.textContent = '$' + monthlyExpenses.toFixed(2);
                        this.updateChangeIndicator('dashboard-expenses-change', expensePercentage.toFixed(1) + '% Spent', 'trending-down', expenseColor);
                    }
                    
                    // Update Net Savings
                    const savingsEl = document.getElementById('dashboard-net-savings');
                    if (savingsEl) {
                        savingsEl.textContent = '$' + netSavings.toFixed(2);
                        this.updateChangeIndicator('dashboard-savings-change', 'Total Saved', 'piggy-bank', 'text-gray-500');
                    }
                    
                    console.log('Stats updated:', {
                        balance: totalBalance,
                        income: monthlyIncome,
                        expensesDisplay: monthlyExpenses,
                        expensesForBalance: totalExpensesForBalance,
                        netSavings: netSavings,
                        reservedForBills: reservedForBills,  //  Added to log
                        expensePercent: expensePercentage.toFixed(1) + '%'
                    });
                }

                updateChangeIndicator(elementId, text, icon, colorClass = 'text-gray-500') {
                    const element = document.getElementById(elementId);
                    if (!element) return;
                    
                    element.className = `text-sm font-medium flex items-center ${colorClass}`;
                    element.innerHTML = `
                        <i data-lucide="${icon}" class="w-4 h-4 mr-1"></i>${text}
                    `;
                    
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }

                updateBudgetProgress() {
                    const list = document.getElementById('dashboard-budget-list');
                    const empty = document.getElementById('dashboard-budget-empty');
                    const container = document.getElementById('dashboard-budget-container');
                    
                    if (!list || !empty) return;
                    
                    const expenseCategories = this.categoryManager.categories
                        .filter(cat => cat.type === 'expense' && cat.budget > 0);

                    if (expenseCategories.length === 0) {
                        container.classList.add('hidden');
                        empty.classList.remove('hidden');
                        return;
                    }

                    container.classList.remove('hidden');
                    empty.classList.add('hidden');

                    // Sort by budget (highest first)
                    const sortedCategories = expenseCategories.sort((a, b) => b.budget - a.budget);
                    
                    //  Show top 5 or all based on state
                    const categoriesToShow = this.budgetViewExpanded ? sortedCategories : sortedCategories.slice(0, 5);
                    
                    // Set container class based on state
                    container.className = this.budgetViewExpanded ? 'expanded' : 'collapsed';

                    list.innerHTML = categoriesToShow.map(cat => {
                        const spent = cat.spent || 0;
                        const budget = cat.budget || 0;
                        const percentage = budget > 0 ? Math.min(100, (spent / budget) * 100) : 0;
                        const remaining = budget - spent;
                        
                        // Determine progress bar color
                        let progressColor = cat.color;
                        if (percentage >= 90) {
                            progressColor = '#ef4444';
                        } else if (percentage >= 75) {
                            progressColor = '#f59e0b';
                        }
                        
                        return `
                            <li class="flex items-center justify-between py-2 border-b border-gray-100 hover:bg-gray-50 rounded px-2 transition-colors">
                                <div class="flex items-center space-x-3 flex-1">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background-color: ${cat.color}20">
                                        <i data-lucide="${cat.icon}" class="w-4 h-4" style="color: ${cat.color}"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center justify-between mb-1">
                                            <span class="font-medium text-gray-900 truncate">${cat.name}</span>
                                            <span class="text-xs ${remaining >= 0 ? 'text-gray-600' : 'text-red-600'} ml-2">
                                                $${spent.toFixed(0)} / $${budget.toFixed(0)}
                                            </span>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                <div class="h-full transition-all duration-300" style="width: ${percentage}%; background-color: ${progressColor}"></div>
                                            </div>
                                            <span class="text-xs font-medium ${percentage >= 90 ? 'text-red-600' : 'text-gray-500'} w-12 text-right">
                                                ${percentage.toFixed(0)}%
                                            </span>
                                        </div>
                                        ${remaining < 0 ? `<p class="text-xs text-red-600 mt-1">Over budget by $${Math.abs(remaining).toFixed(0)}</p>` : ''}
                                    </div>
                                </div>
                            </li>
                        `;
                    }).join('');
                    
                    lucide.createIcons();
                    console.log(` Budget progress updated - Showing ${categoriesToShow.length} of ${sortedCategories.length} categories`);
                }

                updateRecentTransactions() {
                    const list = document.getElementById('dashboard-recent-transactions');
                    const empty = document.getElementById('dashboard-transactions-empty');
                    const container = document.getElementById('dashboard-transactions-container');
                    
                    if (!list || !empty) return;

                    const allTransactions = [
                        ...this.expenseManager.expenses.map(exp => ({
                            ...exp,
                            type: 'expense',
                            category: this.categoryManager.categories.find(c => c.id === exp.categoryId)
                        })),
                        ...this.incomeManager.incomes.map(inc => ({
                            ...inc,
                            type: 'income',
                            category: this.categoryManager.categories.find(c => c.id === inc.categoryId)
                        }))
                    ];

                    if (allTransactions.length === 0) {
                        container.classList.add('hidden');
                        empty.classList.remove('hidden');
                        return;
                    }

                    container.classList.remove('hidden');
                    empty.classList.add('hidden');

                    // Sort by date (most recent first)
                    const sortedTransactions = allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Show top 5 or all based on state
                    const transactionsToShow = this.transactionsViewExpanded ? sortedTransactions : sortedTransactions.slice(0, 5);
                    
                    //  Update container class with smooth transition
                    container.classList.remove('collapsed', 'expanded');
                    // Force reflow for animation to work
                    void container.offsetWidth;
                    container.classList.add(this.transactionsViewExpanded ? 'expanded' : 'collapsed');

                    list.innerHTML = transactionsToShow.map(trans => {
                        const icon = trans.category ? trans.category.icon : (trans.type === 'income' ? 'dollar-sign' : 'shopping-cart');
                        const color = trans.category ? trans.category.color : (trans.type === 'income' ? '#10b981' : '#ef4444');
                        const bgColor = trans.type === 'income' ? 'bg-green-100' : 'bg-red-100';
                        const textColor = trans.type === 'income' ? 'text-green-600' : 'text-red-600';
                        
                        return `
                            <li class="flex items-center justify-between py-2 border-b border-gray-100 hover:bg-gray-50 rounded px-2 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 ${bgColor} rounded-full flex items-center justify-center">
                                        <i data-lucide="${icon}" class="w-4 h-4" style="color: ${color}"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium">${trans.description}</p>
                                        <p class="text-xs text-gray-500">${new Date(trans.date).toLocaleDateString()}</p>
                                    </div>
                                </div>
                                <span class="${textColor} font-medium">${trans.type === 'income' ? '+' : '-'}$${trans.amount.toFixed(2)}</span>
                            </li>
                        `;
                    }).join('');
                    
                    lucide.createIcons();
                    console.log(` Recent transactions updated - Showing ${transactionsToShow.length} of ${sortedTransactions.length} transactions`);
                }

                updateUpcomingBills() {
                    const list = document.getElementById('dashboard-upcoming-bills');
                    const empty = document.getElementById('dashboard-bills-empty');
                    const container = document.getElementById('dashboard-bills-container');
                    
                    if (!list || !empty || !this.billsManager) return;

                    if (this.billsManager.bills.length === 0) {
                        container.classList.add('hidden');
                        empty.classList.remove('hidden');
                        return;
                    }

                    container.classList.remove('hidden');
                    empty.classList.add('hidden');

                    const now = new Date();
                    const thirtyDaysLater = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);

                    const upcomingBills = this.billsManager.bills
                        .filter(bill => {
                            const dueDate = new Date(bill.dueDate);
                            return dueDate >= now && dueDate <= thirtyDaysLater;
                        })
                        .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

                    //  Show top 4 or all based on state
                    const billsToShow = this.billsViewExpanded ? upcomingBills : upcomingBills.slice(0, 4);
                    
                    // Update container class with smooth transition
                    container.classList.remove('collapsed', 'expanded');
                    void container.offsetWidth;
                    container.classList.add(this.billsViewExpanded ? 'expanded' : 'collapsed');

                    if (billsToShow.length === 0) {
                        list.innerHTML = '<li class="text-center py-4 text-gray-500">No bills due in the next 30 days</li>';
                        return;
                    }

                    const categoryIcons = {
                        'utilities': 'zap',
                        'rent': 'home',
                        'insurance': 'shield',
                        'subscriptions': 'tv',
                        'loans': 'credit-card',
                        'internet': 'wifi',
                        'other': 'receipt'
                    };

                    const categoryColors = {
                        'utilities': '#f59e0b',
                        'rent': '#6366f1',
                        'insurance': '#10b981',
                        'subscriptions': '#8b5cf6',
                        'loans': '#ef4444',
                        'internet': '#06b6d4',
                        'other': '#6b7280'
                    };

                    list.innerHTML = billsToShow.map(bill => {
                        const icon = categoryIcons[bill.category] || 'receipt';
                        const color = categoryColors[bill.category] || '#6b7280';
                        const daysUntilDue = Math.ceil((new Date(bill.dueDate) - now) / (1000 * 60 * 60 * 24));
                        const isUrgent = daysUntilDue <= 3;
                        
                        return `
                            <li class="flex items-center justify-between py-2 border-b border-gray-100 hover:bg-gray-50 rounded px-2 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background-color: ${color}20">
                                        <i data-lucide="${icon}" class="w-4 h-4" style="color: ${color}"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium ${isUrgent ? 'text-red-600' : ''}">${bill.name}</p>
                                        <p class="text-xs ${isUrgent ? 'text-red-500' : 'text-gray-500'}">
                                            Due ${new Date(bill.dueDate).toLocaleDateString()}${isUrgent ? ' (Urgent!)' : ''}
                                        </p>
                                    </div>
                                </div>
                                <span class="font-medium ${isUrgent ? 'text-red-600' : ''}">$${bill.amount.toFixed(2)}</span>
                            </li>
                        `;
                    }).join('');
                    
                    lucide.createIcons();
                    console.log(` Upcoming bills updated - Showing ${billsToShow.length} of ${upcomingBills.length} bills`);
                }

                updateCharts() {
                    if (window.cashFlowChart) this.updateCashFlowChart();
                    if (window.categoryChart) this.updateCategoryChart();
                    if (window.savingsChart) this.updateSavingsChart();
                }

                updateCashFlowChart() {
                    const canvas = document.getElementById('cashFlowChart');
                    if (!canvas) return;
                    
                    if (window.cashFlowChart) {
                        window.cashFlowChart.destroy();
                    }
                    
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const currentYear = new Date().getFullYear();
                    
                    // Calculate monthly income
                    const monthlyIncome = months.map((_, monthIndex) => {
                        return this.incomeManager.incomes
                            .filter(inc => {
                                const date = new Date(inc.date);
                                return date.getMonth() === monthIndex && date.getFullYear() === currentYear;
                            })
                            .reduce((sum, inc) => sum + inc.amount, 0);
                    });
                    
                    //  Calculate monthly expenses (INCLUDE all expenses for chart display)
                    const monthlyExpenses = months.map((_, monthIndex) => {
                        return this.expenseManager.expenses
                            .filter(exp => {
                                const date = new Date(exp.date);
                                return date.getMonth() === monthIndex && 
                                    date.getFullYear() === currentYear;
                                //  NO isSavingsSpent filter - show all expenses
                            })
                            .reduce((sum, exp) => sum + exp.amount, 0);
                    });
                    
                    console.log('Monthly Income:', monthlyIncome);
                    console.log('Monthly Expenses (all):', monthlyExpenses);
                    
                    const ctx = canvas.getContext('2d');
                    window.cashFlowChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [{
                                label: 'Income',
                                data: monthlyIncome,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.15)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 0,
                                pointHoverRadius: 8,
                                pointHoverBackgroundColor: '#10b981',
                                pointHoverBorderColor: '#fff',
                                pointHoverBorderWidth: 3
                            }, {
                                label: 'Expenses',
                                data: monthlyExpenses,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.15)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 0,
                                pointHoverRadius: 8,
                                pointHoverBackgroundColor: '#ef4444',
                                pointHoverBorderColor: '#fff',
                                pointHoverBorderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    align: 'center',
                                    labels: {
                                        usePointStyle: true,
                                        pointStyle: 'circle',
                                        padding: 20,
                                        font: {
                                            size: 13,
                                            weight: '600'
                                        },
                                        color: '#374151'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    padding: 16,
                                    cornerRadius: 12,
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    bodySpacing: 8,
                                    displayColors: true,
                                    boxWidth: 12,
                                    boxHeight: 12,
                                    boxPadding: 6,
                                    usePointStyle: true,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                        },
                                        footer: function(tooltipItems) {
                                            const income = tooltipItems[0].parsed.y;
                                            const expense = tooltipItems[1] ? tooltipItems[1].parsed.y : 0;
                                            const net = income - expense;
                                            return '\nNet: $' + net.toLocaleString('en-US', {minimumFractionDigits: 2});
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        drawBorder: false,
                                        color: '#f3f4f6',
                                        lineWidth: 1
                                    },
                                    ticks: {
                                        color: '#6b7280',
                                        font: {
                                            size: 11,
                                            weight: '500'
                                        },
                                        padding: 10,
                                        callback: function(value) {
                                            if (value >= 1000) {
                                                return '$' + (value / 1000).toFixed(0) + 'k';
                                            }
                                            return '$' + value;
                                        }
                                    },
                                    border: {
                                        display: false
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false,
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: '#6b7280',
                                        font: {
                                            size: 11,
                                            weight: '600'
                                        },
                                        padding: 8
                                    },
                                    border: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                    
                    console.log(' Cash flow chart updated - showing all expenses');
                }

                updateCategoryChart() {
                    const canvas = document.getElementById('categoryChart');
                    if (!canvas) return;
                    
                    if (window.categoryChart) {
                        window.categoryChart.destroy();
                    }
                    
                    // Get expense categories with real spending data
                    const expenseCategories = this.categoryManager.categories
                        .filter(c => c.type === 'expense')
                        .map(cat => {
                            const spent = this.expenseManager.expenses
                                .filter(exp => exp.categoryId === cat.id && !exp.isSavingsSpent)
                                .reduce((sum, exp) => sum + exp.amount, 0);
                            
                            return {
                                name: cat.name,
                                spent: spent,
                                color: cat.color
                            };
                        })
                        .filter(cat => cat.spent > 0)
                        .sort((a, b) => b.spent - a.spent);
                    
                    const ctx = canvas.getContext('2d');
                    window.categoryChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: expenseCategories.length > 0 
                                ? expenseCategories.map(c => c.name)
                                : ['No Expenses Yet'],
                            datasets: [{
                                data: expenseCategories.length > 0
                                    ? expenseCategories.map(c => c.spent)
                                    : [1],
                                backgroundColor: expenseCategories.length > 0
                                    ? expenseCategories.map(c => c.color)
                                    : ['#e5e7eb'],
                                borderWidth: 0,
                                hoverOffset: 15,
                                hoverBorderColor: '#fff',
                                hoverBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: true,
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    padding: 12,
                                    cornerRadius: 8,
                                    displayColors: false,
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].label;
                                        },
                                        label: function(context) {
                                            const value = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return context.label + ': $' + value.toFixed(2) + ' (' + percentage + '%)';
                                        }
                                    }
                                }
                            },
                            cutout: '70%'
                        }
                    });
                    
                    console.log(' Category chart updated');
                }

                updateSavingsChart() {
                    const canvas = document.getElementById('savingsChart');
                    if (!canvas) return;
                    
                    if (window.savingsChart) {
                        window.savingsChart.destroy();
                    }
                    
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const currentYear = new Date().getFullYear();
                    
                    //  Include active + completed goals, but EXCLUDE spent goals
                    const validGoals = this.savingsManager.goals.filter(g => !g.markedSpent);
                    
                    console.log('Goals for chart (active + completed, not spent):', validGoals);
                    console.log('Total current amount:', validGoals.reduce((sum, g) => sum + (g.current || 0), 0));
                    
                    // Calculate monthly savings deposits
                    const monthlySavings = months.map((_, monthIndex) => {
                        return validGoals.reduce((sum, g) => {
                            if (!g.deposits) return sum;
                            
                            const monthDeposits = g.deposits.filter(d => {
                                const dDate = new Date(d.date);
                                return dDate.getMonth() === monthIndex && 
                                    dDate.getFullYear() === currentYear;
                            }).reduce((s, d) => s + d.amount, 0);
                            
                            return sum + monthDeposits;
                        }, 0);
                    });
                    
                    console.log('Monthly Savings:', monthlySavings);
                    
                    // Create gradient
                    const ctx = canvas.getContext('2d');
                    const savingsGradient = ctx.createLinearGradient(0, 0, 0, 300);
                    savingsGradient.addColorStop(0, 'rgba(99, 102, 241, 0.8)');
                    savingsGradient.addColorStop(0.5, 'rgba(139, 92, 246, 0.6)');
                    savingsGradient.addColorStop(1, 'rgba(168, 85, 247, 0.4)');
                    
                    window.savingsChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: months,
                            datasets: [{
                                label: 'Monthly Savings',
                                data: monthlySavings,
                                backgroundColor: savingsGradient,
                                borderColor: 'rgba(99, 102, 241, 1)',
                                borderWidth: 2,
                                borderRadius: 8,
                                borderSkipped: false,
                                hoverBackgroundColor: 'rgba(99, 102, 241, 0.9)',
                                hoverBorderColor: 'rgba(99, 102, 241, 1)',
                                hoverBorderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 1000,
                                easing: 'easeInOutQuart'
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    padding: 12,
                                    cornerRadius: 8,
                                    displayColors: false,
                                    callbacks: {
                                        label: function(context) {
                                            return 'Saved: $' + context.parsed.y.toLocaleString();
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#6b7280',
                                        font: {
                                            size: 11
                                        },
                                        callback: function(value) {
                                            return '$' + value.toLocaleString();
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)',
                                        drawBorder: false
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#6b7280',
                                        font: {
                                            size: 11,
                                            weight: '500'
                                        }
                                    },
                                    grid: {
                                        display: false,
                                        drawBorder: false
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });
                    
                    console.log(' Savings chart updated - showing active + completed (excluding spent)');
                }

                setupBudgetToggle() {
                    const toggleBtn = document.getElementById('toggle-budget-view');
                    const toggleText = document.getElementById('budget-toggle-text');
                    const toggleIcon = document.getElementById('budget-toggle-icon');
                    
                    if (!toggleBtn) return;
                    
                    toggleBtn.addEventListener('click', () => {
                        // Toggle state
                        this.budgetViewExpanded = !this.budgetViewExpanded;
                        
                        // Update UI
                        if (this.budgetViewExpanded) {
                            toggleText.textContent = 'View Less';
                            toggleIcon.classList.add('expanded');
                        } else {
                            toggleText.textContent = 'View All';
                            toggleIcon.classList.remove('expanded');
                        }
                        
                        // Re-render budget progress
                        this.updateBudgetProgress();
                        
                        console.log(` Budget view ${this.budgetViewExpanded ? 'expanded' : 'collapsed'}`);
                    });
                }

                setupTransactionsToggle() {
                    const toggleBtn = document.getElementById('toggle-transactions-view');
                    const toggleText = document.getElementById('transactions-toggle-text');
                    const toggleIcon = document.getElementById('transactions-toggle-icon');
                    
                    if (!toggleBtn) return;
                    
                    toggleBtn.addEventListener('click', () => {
                        // Toggle state
                        this.transactionsViewExpanded = !this.transactionsViewExpanded;
                        
                        // Update UI
                        if (this.transactionsViewExpanded) {
                            toggleText.textContent = 'View Less';
                            toggleIcon.classList.add('expanded');
                        } else {
                            toggleText.textContent = 'View All';
                            toggleIcon.classList.remove('expanded');
                        }
                        
                        // Re-render transactions
                        this.updateRecentTransactions();
                        
                        console.log(` Transactions view ${this.transactionsViewExpanded ? 'expanded' : 'collapsed'}`);
                    });
                }

                setupBillsToggle() {
                    const toggleBtn = document.getElementById('toggle-bills-view');
                    const toggleText = document.getElementById('bills-toggle-text');
                    const toggleIcon = document.getElementById('bills-toggle-icon');
                    
                    if (!toggleBtn) return;
                    
                    toggleBtn.addEventListener('click', () => {
                        // Toggle state
                        this.billsViewExpanded = !this.billsViewExpanded;
                        
                        // Update UI
                        if (this.billsViewExpanded) {
                            toggleText.textContent = 'View Less';
                            toggleIcon.classList.add('expanded');
                        } else {
                            toggleText.textContent = 'View All';
                            toggleIcon.classList.remove('expanded');
                        }
                        
                        // Re-render bills
                        this.updateUpcomingBills();
                        
                        console.log(` Bills view ${this.billsViewExpanded ? 'expanded' : 'collapsed'}`);
                    });
                }
            }

            function setupDashboardAutoUpdate() {
                // Create references for auto-update
                const managers = {
                    expense: window.expenseManager,
                    income: window.incomeManager,
                    category: window.categoryManager,
                    savings: window.savingsManager,
                    investment: window.investmentManager,
                    bills: window.billManager  // Changed from BillsManager to billManager
                };

                // Only proceed if dashboard manager exists
                if (window.dashboardManager) {
                    window.dashboardManager.updateDashboard();
                }
            }

            // Call setup after a delay to ensure managers are ready
            setTimeout(setupDashboardAutoUpdate, 1200);

            // Categories Management System
            class CategoryManager {
                constructor() {
                    this.categories = this.loadCategories();
                    this.currentFilter = 'all';
                    this.editingCategory = null;
                    this.categoryToDelete = null;
                    this.init();
                }

                // Initialize default categories if none exist
                getDefaultCategories() {
                    return [
                        // Expense Categories
                        {
                            id: 'transport',
                            name: 'Transport',
                            description: 'Fuel, parking, public transport, maintenance',
                            type: 'expense',
                            icon: 'car',
                            color: '#3b82f6',
                            budget: 400,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'food-dining',
                            name: 'Food & Dining',
                            description: 'Groceries, restaurants, snacks, coffee',
                            type: 'expense',
                            icon: 'utensils',
                            color: '#f97316',
                            budget: 600,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'housing',
                            name: 'Housing',
                            description: 'Rent, utilities, maintenance',
                            type: 'expense',
                            icon: 'home',
                            color: '#4f46e5',
                            budget: 1200,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'entertainment',
                            name: 'Entertainment',
                            description: 'Movies, games, music, streaming subscriptions',
                            type: 'expense',
                            icon: 'tv',
                            color: '#8b5cf6',
                            budget: 300,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'shopping',
                            name: 'Shopping',
                            description: 'Clothing, personal items, online purchases',
                            type: 'expense',
                            icon: 'shopping-bag',
                            color: '#f59e0b',
                            budget: 400,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'healthcare',
                            name: 'Healthcare',
                            description: 'Medical visits, insurance, prescriptions',
                            type: 'expense',
                            icon: 'stethoscope',
                            color: '#ef4444',
                            budget: 300,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'education',
                            name: 'Education',
                            description: 'Books, tuition, online courses',
                            type: 'expense',
                            icon: 'graduation-cap',
                            color: '#10b981',
                            budget: 250,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'travel',
                            name: 'Travel',
                            description: 'Flights, hotels, trips, tours',
                            type: 'expense',
                            icon: 'plane',
                            color: '#06b6d4',
                            budget: 800,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'fitness',
                            name: 'Fitness',
                            description: 'Gym, yoga, sports, supplements',
                            type: 'expense',
                            icon: 'dumbbell',
                            color: '#14b8a6',
                            budget: 200,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'pet-care',
                            name: 'Pet Care',
                            description: 'Pet food, vet, grooming',
                            type: 'expense',
                            icon: 'paw-print',
                            color: '#ec4899',
                            budget: 150,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'gifts-donations',
                            name: 'Gifts & Donations',
                            description: 'Gifting, charity, donations',
                            type: 'expense',
                            icon: 'gift',
                            color: '#f472b6',
                            budget: 100,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'subscriptions',
                            name: 'Subscriptions',
                            description: 'Streaming, apps, memberships',
                            type: 'expense',
                            icon: 'credit-card',
                            color: '#9333ea',
                            budget: 150,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'other-expense',
                            name: 'Other',
                            description: 'Miscellaneous expenses and savings spent',
                            type: 'expense',
                            icon: 'more-horizontal', //  Valid Lucide icon for "other/misc"
                            color: '#8b5cf6',
                            budget: 0,
                            spent: 0,
                            transactions: 0
                        },

                        // Income Categories
                        {
                            id: 'salary',
                            name: 'Salary',
                            description: 'Primary job income, bonuses, and allowances',
                            type: 'income',
                            icon: 'wallet',
                            color: '#22c55e',
                            budget: 0,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'freelance',
                            name: 'Freelance Work',
                            description: 'Side projects, part-time gigs, commissions',
                            type: 'income',
                            icon: 'briefcase',
                            color: '#3b82f6',
                            budget: 0,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'investments',
                            name: 'Investments',
                            description: 'Dividends, crypto, and capital gains',
                            type: 'income',
                            icon: 'trending-up',
                            color: '#4f46e5',
                            budget: 0,
                            spent: 0,
                            transactions: 0
                        },
                        {
                            id: 'other-income',
                            name: 'Other',
                            description: 'Miscellaneous or irregular income',
                            type: 'income',
                            icon: 'piggy-bank',
                            color: '#f59e0b',
                            budget: 0,
                            spent: 0,
                            transactions: 0
                        }
                    ];
                }

                // Add income to category
                updateCategoryIncome(categoryId, amount) {
                    const cat = this.categories.find(c => c.id === categoryId);
                    if (!cat) return;
                    cat.income = (cat.income || 0) + amount;
                    this.saveCategories();
                }

                revertCategoryIncome(categoryId, amount) {
                    const cat = this.categories.find(c => c.id === categoryId);
                    if (!cat) return;
                    cat.income = (cat.income || 0) - amount;
                    this.saveCategories();
                }

                // Update category spent when expense is added
                updateCategorySpent(categoryId, amount) {
                    const cat = this.categories.find(c => c.id === categoryId);
                    if (!cat) return;
                    cat.spent = (cat.spent || 0) + amount;
                    cat.transactions = (cat.transactions || 0) + 1;
                    this.saveCategories();
                    this.renderCategories(); // re-render to update progress bars immediately
                }

                // Revert category spent when expense is deleted
                revertCategorySpent(categoryId, amount) {
                    const cat = this.categories.find(c => c.id === categoryId);
                    if (!cat) return;
                    cat.spent = Math.max(0, (cat.spent || 0) - amount);
                    cat.transactions = Math.max(0, (cat.transactions || 0) - 1);
                    this.saveCategories();
                    this.renderCategories(); // re-render to update progress bars immediately
                }

                // Load categories from localStorage or use defaults
                loadCategories() {
                    const saved = localStorage.getItem('financeflow_categories');
                    if (saved) {
                        return JSON.parse(saved);
                    }
                    const defaultCategories = this.getDefaultCategories();
                    this.saveCategories(defaultCategories);
                    return defaultCategories;
                }

                // Save categories to localStorage
                saveCategories(categories = this.categories) {
                    localStorage.setItem('financeflow_categories', JSON.stringify(categories));
                }

                // Initialize event listeners and render
                init() {
                    this.bindEvents();
                    this.renderCategories();
                    this.updateCounts();
                }

                // Bind all event listeners
                bindEvents() {
                    // Add category button
                    document.getElementById('add-category-btn').addEventListener('click', () => {
                        this.openModal();
                    });

                    // Modal close buttons
                    document.getElementById('close-modal').addEventListener('click', () => {
                        this.closeModal();
                    });

                    document.getElementById('cancel-btn').addEventListener('click', () => {
                        this.closeModal();
                    });

                    // Form submission
                    document.getElementById('category-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.saveCategory();
                    });

                    // Filter buttons
                    document.getElementById('filter-all').addEventListener('click', () => {
                        this.setFilter('all');
                    });

                    document.getElementById('filter-expense').addEventListener('click', () => {
                        this.setFilter('expense');
                    });

                    document.getElementById('filter-income').addEventListener('click', () => {
                        this.setFilter('income');
                    });

                    // Icon selector
                    document.querySelectorAll('.icon-option').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.selectIcon(btn.dataset.icon);
                        });
                    });

                    // Color selector
                    document.querySelectorAll('.color-option').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.selectColor(btn.dataset.color);
                        });
                    });

                    // Delete modal
                    document.getElementById('cancel-delete').addEventListener('click', () => {
                        this.closeDeleteModal();
                    });

                    document.getElementById('confirm-delete').addEventListener('click', () => {
                        this.confirmDelete();
                    });

                    // Close modals on overlay click
                    document.getElementById('category-modal').addEventListener('click', (e) => {
                        if (e.target.id === 'category-modal') {
                            this.closeModal();
                        }
                    });

                    document.getElementById('delete-modal').addEventListener('click', (e) => {
                        if (e.target.id === 'delete-modal') {
                            this.closeDeleteModal();
                        }
                    });

                    // Add event listener for empty state create button
                    const emptyStateBtn = document.querySelector('#empty-state button');
                    if (emptyStateBtn) {
                            emptyStateBtn.addEventListener('click', () => {
                            this.openModal();
                        });
                    }
                }                

                // Set filter and update UI
                setFilter(filter) {
                    this.currentFilter = filter;
                
                    // Update filter buttons
                    document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                        btn.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                        btn.classList.add('text-gray-600', 'hover:text-gray-900');
                    });

                    document.getElementById(`filter-${filter}`).classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                    document.getElementById(`filter-${filter}`).classList.remove('text-gray-600', 'hover:text-gray-900');

                    this.renderCategories();
                }

                // Render categories based on current filter
                renderCategories() {
                    const grid = document.getElementById('categories-grid');
                    const empty = document.getElementById('empty-state');
                    
                    let filtered = this.categories;
                    
                    // Apply filter
                    if (this.currentFilter !== 'all') {
                        filtered = filtered.filter(cat => cat.type === this.currentFilter);
                    }
                    
                    if (filtered.length === 0) {
                        grid.classList.add('hidden');
                        empty.classList.remove('hidden');
                        return;
                    }
                    
                    grid.classList.remove('hidden');
                    empty.classList.add('hidden');
                    
                    grid.innerHTML = filtered.map(category => {
                        const isIncome = category.type === 'income';
                        const amountToShow = isIncome ? (category.income || 0) : (category.spent || 0);
                        const thisMonthTransactions = category.transactions || 0;
                        
                        return `
                            <div class="group bg-white border border-gray-200 rounded-2xl p-6 hover:shadow-2xl hover:border-transparent transition-all duration-300 transform hover:-translate-y-1 relative overflow-hidden">
                                <!-- Subtle gradient background -->
                                <div class="absolute inset-0 bg-gradient-to-br from-gray-50 to-white opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                
                                <!-- Content -->
                                <div class="relative z-10">
                                    <!-- Header with icon and badge -->
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="w-14 h-14 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow duration-300" style="background: linear-gradient(135deg, ${category.color}20, ${category.color}40);">
                                            <i data-lucide="${category.icon}" class="w-7 h-7" style="color: ${category.color}"></i>
                                        </div>
                                        <span class="px-3 py-1.5 text-xs font-semibold rounded-full shadow-sm ${isIncome ? 'bg-gradient-to-r from-green-400 to-green-500 text-white' : 'bg-gradient-to-r from-red-400 to-red-500 text-white'}">
                                            ${isIncome ? 'Income' : 'Expense'}
                                        </span>
                                    </div>
                                    
                                    <!-- Title and description -->
                                    <h3 class="text-xl font-bold text-gray-900 mb-2 group-hover:text-indigo-600 transition-colors duration-300">${category.name}</h3>
                                    <p class="text-sm text-gray-500 mb-5 line-clamp-2">${category.description}</p>
                                    
                                    <!-- Stats section -->
                                    <div class="bg-gray-50 rounded-xl p-4 mb-4 group-hover:bg-white group-hover:shadow-inner transition-all duration-300">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <p class="text-xs text-gray-500 mb-1 font-medium">This Month</p>
                                                <p class="text-xl font-bold ${isIncome ? 'text-green-600' : 'text-indigo-600'}">$${amountToShow.toLocaleString()}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-xs text-gray-500 mb-1 font-medium">Transactions</p>
                                                <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 text-indigo-700 font-bold text-sm">
                                                    ${thisMonthTransactions}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action buttons -->
                                    <div class="flex items-center justify-end space-x-2 pt-3 border-t border-gray-100">
                                        <button data-edit="${category.id}" class="flex items-center justify-center w-9 h-9 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all duration-200 transform hover:scale-110" title="Edit category">
                                            <i data-lucide="edit" class="w-4 h-4"></i>
                                        </button>
                                        <button data-delete="${category.id}" class="flex items-center justify-center w-9 h-9 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all duration-200 transform hover:scale-110" title="Delete category">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Bind edit and delete buttons
                    this.categories.forEach(cat => {
                        const editBtn = document.querySelector(`[data-edit="${cat.id}"]`);
                        const deleteBtn = document.querySelector(`[data-delete="${cat.id}"]`);
                        
                        if (editBtn) {
                            editBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.editCategory(cat.id);
                            });
                        }
                        
                        if (deleteBtn) {
                            deleteBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.deleteCategory(cat.id);
                            });
                        }
                    });
                    
                    lucide.createIcons();
                }

                // Create category card
                createCategoryCard(category) {
                    const isIncome = category.type === 'income';
                    const amountToShow = isIncome ? (category.income || 0) : (category.spent || 0);
                    
                    // Calculate this month's activity
                    const thisMonthTransactions = category.transactions || 0;
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all group">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center transition-transform group-hover:scale-110" style="background-color: ${category.color}20;">
                                        <i data-lucide="${category.icon}" class="w-5 h-5" style="color: ${category.color};"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-gray-900">${category.name}</h3>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${isIncome ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                            ${isIncome ? 'Income' : 'Expense'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="text-sm text-gray-600 mb-4">${category.description}</p>
                            
                            <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">This Month</p>
                                    <p class="text-lg font-bold ${isIncome ? 'text-green-600' : 'text-gray-900'}">
                                        ${isIncome ? '+' : ''}$${amountToShow.toLocaleString()}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-500 mb-1">Transactions</p>
                                    <p class="text-lg font-bold text-gray-700">${thisMonthTransactions}</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between mt-4 pt-3 border-t border-gray-100">
                                <a href="#" data-page="${isIncome ? 'income' : 'expense'}" class="text-xs text-indigo-600 hover:text-indigo-700 font-medium flex items-center">
                                    View ${isIncome ? 'Incomes' : 'Expenses'}
                                    <i data-lucide="arrow-right" class="w-3 h-3 ml-1"></i>
                                </a>
                                <div class="flex space-x-1">
                                    <button data-edit="${category.id}" class="text-gray-400 hover:text-indigo-600 p-1.5 rounded hover:bg-indigo-50 transition-colors" title="Edit category">
                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                    </button>
                                    <button data-delete="${category.id}" class="text-gray-400 hover:text-red-600 p-1.5 rounded hover:bg-red-50 transition-colors" title="Delete category">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Update category counts
                updateCounts() {
                    const expenseCount = this.categories.filter(cat => cat.type === 'expense').length;
                    const incomeCount = this.categories.filter(cat => cat.type === 'income').length;
                    
                    document.getElementById('expense-count').textContent = expenseCount;
                    document.getElementById('income-count').textContent = incomeCount;
                }

                // Open modal for adding/editing
                openModal(category = null) {
                    this.editingCategory = category;
                    const modal = document.getElementById('category-modal');
                    const title = document.getElementById('modal-title');
                    const saveBtn = document.getElementById('save-btn');

                    if (category) {
                        title.textContent = 'Edit Category';
                        saveBtn.textContent = 'Update Category';
                        this.populateForm(category);
                    } else {
                        title.textContent = 'Add Category';
                        saveBtn.textContent = 'Save Category';
                        this.resetForm();
                    }

                    modal.classList.remove('hidden');
                }

                // Close modal
                closeModal() {
                    document.getElementById('category-modal').classList.add('hidden');
                    this.editingCategory = null;
                    this.resetForm();
                }

                // Populate form with category data
                populateForm(category) {
                    document.getElementById('category-name').value = category.name;
                    document.getElementById('category-description').value = category.description;
                    document.getElementById('category-type').value = category.type;
                    // REMOVED: document.getElementById('category-budget').value = category.budget || '';
                    
                    this.selectIcon(category.icon);
                    this.selectColor(category.color);
                }

                // Reset form
                resetForm() {
                    document.getElementById('category-form').reset();
                    this.selectIcon('home');
                    this.selectColor('#4f46e5');
                }

                // Select icon
                selectIcon(icon) {
                    document.querySelectorAll('.icon-option').forEach(btn => {
                        btn.classList.remove('selected', 'border-indigo-500', 'bg-indigo-50');
                    });

                    const selectedBtn = document.querySelector(`[data-icon="${icon}"]`);
                    if (selectedBtn) {
                        selectedBtn.classList.add('selected', 'border-indigo-500', 'bg-indigo-50');
                    }

                    document.getElementById('selected-icon').value = icon;
                }

                // Select color
                selectColor(color) {
                    document.querySelectorAll('.color-option').forEach(btn => {
                        btn.classList.remove('selected');
                        btn.style.borderColor = '#d1d5db';
                    });

                    const selectedBtn = document.querySelector(`[data-color="${color}"]`);
                    if (selectedBtn) {
                        selectedBtn.classList.add('selected');
                        selectedBtn.style.borderColor = color;
                        selectedBtn.style.borderWidth = '3px';
                    }

                    document.getElementById('selected-color').value = color;
                }

                // Save category
                saveCategory() {
                    const formData = {
                        name: document.getElementById('category-name').value.trim(),
                        description: document.getElementById('category-description').value.trim(),
                        type: document.getElementById('category-type').value,
                        icon: document.getElementById('selected-icon').value,
                        color: document.getElementById('selected-color').value
                        // REMOVED: budget: parseFloat(document.getElementById('category-budget').value) || 0
                    };

                    if (!formData.name) {
                        alert('Please enter a category name');
                        return;
                    }

                    if (this.editingCategory) {
                        // Update existing category (preserve budget if it exists)
                        const index = this.categories.findIndex(cat => cat.id === this.editingCategory.id);
                        if (index !== -1) {
                            this.categories[index] = {
                                ...this.editingCategory,
                                ...formData
                                // Keep existing budget, spent, and transactions
                            };
                        }
                    } else {
                        // Add new category
                        const newCategory = {
                            id: Date.now().toString(),
                            ...formData,
                            budget: 0,        // Default to 0
                            yearlyBudget: 0,  // Default to 0
                            spent: 0,
                            transactions: 0
                        };
                        this.categories.push(newCategory);
                    }

                    this.saveCategories();
                    this.renderCategories();
                    this.updateCounts();
                    this.closeModal();
                }

                // Edit category
                editCategory(categoryId) {
                    const category = this.categories.find(cat => cat.id === categoryId);
                    if (category) {
                        this.openModal(category);
                    }
                }

                // Delete category
                deleteCategory(categoryId) {
                    this.categoryToDelete = categoryId;
                    document.getElementById('delete-modal').classList.remove('hidden');
                }

                // Close delete modal
                closeDeleteModal() {
                    document.getElementById('delete-modal').classList.add('hidden');
                    this.categoryToDelete = null;
                }

                // Confirm delete
                confirmDelete() {
                    if (this.categoryToDelete) {
                        this.categories = this.categories.filter(cat => cat.id !== this.categoryToDelete);
                        this.saveCategories();
                        this.renderCategories();
                        this.updateCounts();
                        this.closeDeleteModal();
                    }
                }

                // Update category spending when a new expense is added
                updateCategoryIncome(categoryId, amount) {
                    const cat = this.categories.find(c => c.id === categoryId);
                    if (!cat) return;
                    cat.income = (cat.income || 0) + amount;
                    cat.transactions = (cat.transactions || 0) + 1;
                    this.saveCategories();
                    this.renderCategories(); // re-render immediately
                }

                revertCategoryIncome(categoryId, amount) {
                    const cat = this.categories.find(c => c.id === categoryId);
                    if (!cat) return;
                    cat.income = Math.max(0, (cat.income || 0) - amount);
                    cat.transactions = Math.max(0, (cat.transactions || 0) - 1);
                    this.saveCategories();
                    this.renderCategories(); // re-render immediately
                }
            }

            class ExpenseManager {
                constructor(categoryManager) {
                    this.categoryManager = categoryManager;
                    this.expenses = JSON.parse(localStorage.getItem('financeflow_expenses')) || [];
                    this.selectedCategories = new Set();
                    this.currentDateRangeFilter = 'all';
                    this.customDateFrom = null;
                    this.customDateTo = null;
                    this.expenseToDeleteId = null;
                    this.init();
                }

                init() {
                    this.populateCategories();
                    this.renderCategoryFilters();
                    this.renderExpenses();
                    this.updateSummary();

                    document.getElementById('expense-form').addEventListener('submit', e => this.addExpense(e));
                    document.getElementById('reset-expense-form').addEventListener('click', () => this.resetForm());
                    
                    // Date range filter
                    document.getElementById('date-range-filter').addEventListener('change', e => {
                        this.currentDateRangeFilter = e.target.value;
                        
                        // Show/hide custom date range
                        const customRange = document.getElementById('custom-date-range');
                        if (e.target.value === 'custom') {
                            customRange.classList.remove('hidden');
                        } else {
                            customRange.classList.add('hidden');
                            this.customDateFrom = null;
                            this.customDateTo = null;
                            this.renderExpenses();
                        }
                    });
                    
                    // Custom date range buttons
                    document.getElementById('apply-expense-date-range').addEventListener('click', () => {
                        this.customDateFrom = document.getElementById('expense-date-from').value;
                        this.customDateTo = document.getElementById('expense-date-to').value;
                        if (this.customDateFrom && this.customDateTo) {
                            this.renderExpenses();
                        } else {
                            alert('Please select both From and To dates');
                        }
                    });
                    
                    document.getElementById('clear-expense-date-range').addEventListener('click', () => {
                        document.getElementById('expense-date-from').value = '';
                        document.getElementById('expense-date-to').value = '';
                        this.customDateFrom = null;
                        this.customDateTo = null;
                        this.renderExpenses();
                    });
                    
                    // Delete All button
                    document.getElementById('delete-all-expenses-btn').addEventListener('click', () => this.showDeleteAllModal());
                    
                    document.getElementById('search-expenses').addEventListener('input', () => this.renderExpenses());
                    document.getElementById('sort-expenses').addEventListener('change', () => this.renderExpenses());

                    // Delete button event delegation
                    document.getElementById('expenses-list').addEventListener('click', (e) => {
                        const btn = e.target.closest('.delete-expense-btn');
                        if (btn) {
                            this.expenseToDeleteId = btn.dataset.id;
                            this.showDeleteModal();
                        }
                    });

                    document.getElementById('cancel-delete-expense').addEventListener('click', () => this.hideDeleteModal());
                    document.getElementById('confirm-delete-expense').addEventListener('click', () => this.confirmDeleteExpense());
                }

                showDeleteModal() {
                    document.getElementById('delete-expense-modal').classList.remove('hidden');
                }

                hideDeleteModal() {
                    document.getElementById('delete-expense-modal').classList.add('hidden');
                    this.expenseToDeleteId = null;
                }

                confirmDeleteExpense() {
                    if (!this.expenseToDeleteId) return;

                    const deletedExpense = this.expenses.find(e => e.id === this.expenseToDeleteId);

                    if (!deletedExpense) {
                        console.warn('confirmDeleteExpense: expense not found for id', this.expenseToDeleteId);
                        this.hideDeleteModal();
                        return;
                    }

                    const amount = Number(deletedExpense.amount) || 0;
                    const categoryId = deletedExpense.categoryId;

                    if (this.categoryManager && typeof this.categoryManager.revertCategorySpent === 'function') {
                        this.categoryManager.revertCategorySpent(categoryId, amount);
                    } else {
                        console.warn('confirmDeleteExpense: categoryManager.revertCategorySpent not available');
                    }

                    this.expenses = this.expenses.filter(e => e.id !== this.expenseToDeleteId);

                    localStorage.setItem('financeflow_expenses', JSON.stringify(this.expenses));
                    this.renderExpenses();
                    this.updateSummary();
                    this.hideDeleteModal();
                }

                // Fix 1: Add "Other" option to the category dropdown
                populateCategories() {
                    const select = document.getElementById('expense-category');
                    const options = this.categoryManager.categories
                        .filter(c => c.type === 'expense')
                        .map(c => `<option value="${c.id}">${c.name}</option>`)
                        .join('');
                    
                    //  Add "Other" option at the end
                    select.innerHTML = `
                        <option value="">Select category</option>
                        ${options}
                    `;
                }

                // Fix 2: Show only expense categories in the filter
                renderCategoryFilters() {
                    const container = document.getElementById('category-filters');
                    container.innerHTML = '';
                    
                    // Filter only expense categories
                    const expenseCategories = this.categoryManager.categories.filter(cat => cat.type === 'expense');
                    
                    // "All Categories" button first
                    const allBtn = document.createElement('button');
                    allBtn.textContent = 'All Categories';
                    allBtn.className = this.selectedCategories.size === 0
                        ? 'px-3 py-1 bg-indigo-600 text-white rounded text-sm font-medium'
                        : 'px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm font-medium hover:bg-gray-200';
                    
                    allBtn.addEventListener('click', () => {
                        this.selectedCategories.clear();
                        this.renderCategoryFilters();
                        this.renderExpenses();
                    });
                    
                    container.appendChild(allBtn);
                    
                    // Add expense category buttons
                    expenseCategories.forEach(cat => {
                        const btn = document.createElement('button');
                        btn.textContent = cat.name;
                        btn.className = this.selectedCategories.has(cat.id)
                            ? 'px-3 py-1 bg-indigo-600 text-white rounded text-sm font-medium'
                            : 'px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm font-medium hover:bg-gray-200';
                        
                        btn.addEventListener('click', () => {
                            if (this.selectedCategories.has(cat.id)) {
                                this.selectedCategories.delete(cat.id);
                            } else {
                                this.selectedCategories.add(cat.id);
                            }
                            this.renderCategoryFilters();
                            this.renderExpenses();
                        });
                        
                        container.appendChild(btn);
                    });
                }

                addExpense(e) {
                    e.preventDefault();

                    const amount = parseFloat(document.getElementById('expense-amount').value);
                    const categoryId = document.getElementById('expense-category').value;
                    const description = document.getElementById('expense-description').value.trim();
                    const date = document.getElementById('expense-date').value;
                    const payment = document.getElementById('expense-payment').value;
                    const notes = document.getElementById('expense-notes').value.trim();
                    
                    if (!amount || !categoryId || !description || !date) return;

                    //  CHECK BALANCE BEFORE ADDING EXPENSE
                    // Get income manager from window
                    const incomeManager = window.incomeManager;
                    const savingsManager = window.savingsManager;
                    const billsManager = window.billsManager;
                    
                    if (incomeManager) {
                        const totalIncome = incomeManager.incomes.reduce((sum, i) => sum + i.amount, 0);
                        const totalExpenses = this.expenses.reduce((sum, e) => sum + e.amount, 0);
                        
                        // Calculate reserved amounts
                        const totalSavings = savingsManager && savingsManager.goals 
                            ? savingsManager.goals.reduce((sum, g) => sum + (g.current || 0), 0)
                            : 0;
                        
                        const reservedForBills = billsManager && typeof billsManager.getReservedAmount === 'function'
                            ? billsManager.getReservedAmount()
                            : 0;
                        
                        const currentBalance = totalIncome - totalExpenses - totalSavings - reservedForBills;

                        console.log('Balance check - Available:', currentBalance, 'Required:', amount);

                        if (currentBalance < amount) {
                            console.log('Insufficient balance! Blocking expense creation.');
                            this.showInsufficientBalanceModal(amount, currentBalance);
                            return;  // STOP - Don't create the expense
                        }
                    }

                    //  If balance check passed, create expense
                    const newExp = { 
                        id: Date.now().toString(), 
                        amount, 
                        categoryId, 
                        description, 
                        date, 
                        payment, 
                        notes 
                    };

                    this.expenses.push(newExp);
                    this.categoryManager.updateCategorySpent(categoryId, amount);
                    this.expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                    localStorage.setItem('financeflow_expenses', JSON.stringify(this.expenses));
                    document.getElementById('sort-expenses').value = 'date-desc';
                    this.renderExpenses();
                    this.updateSummary();
                    this.resetForm();
                }

                //  Add this new method to show insufficient balance modal
                showInsufficientBalanceModal(expenseCost, availableBalance) {
                    const shortfall = expenseCost - availableBalance;

                    document.getElementById('insufficient-expense-cost').textContent = `$${expenseCost.toFixed(2)}`;
                    document.getElementById('insufficient-expense-balance').textContent = `$${availableBalance.toFixed(2)}`;
                    document.getElementById('insufficient-expense-shortfall').textContent = `$${shortfall.toFixed(2)}`;

                    document.getElementById('insufficient-expense-modal').classList.remove('hidden');
                    lucide.createIcons();
                }

                hideInsufficientExpenseModal() {
                    document.getElementById('insufficient-expense-modal').classList.add('hidden');
                }

                resetForm() {
                    document.getElementById('expense-form').reset();
                }

                renderExpenses() {
                    const list = document.getElementById('expenses-list');
                    const empty = document.getElementById('expenses-empty-state');
                    const search = document.getElementById('search-expenses').value.toLowerCase();
                    const sort = document.getElementById('sort-expenses').value;
                    const now = new Date();

                    let filtered = [...this.expenses];
                    if (this.selectedCategories.size > 0) filtered = filtered.filter(e => this.selectedCategories.has(e.categoryId));

                    filtered = filtered.filter(e => {
                        const d = new Date(e.date);
                        
                        // Custom date range
                        if (this.currentDateRangeFilter === 'custom' && this.customDateFrom && this.customDateTo) {
                            const fromDate = new Date(this.customDateFrom);
                            const toDate = new Date(this.customDateTo);
                            toDate.setHours(23, 59, 59, 999);
                            return d >= fromDate && d <= toDate;
                        }
                        
                        // Today
                        if (this.currentDateRangeFilter === 'today') {
                            return d.toDateString() === now.toDateString();
                        }
                        
                        // Week
                        if (this.currentDateRangeFilter === 'week') {
                            const oneWeekAgo = new Date();
                            oneWeekAgo.setDate(now.getDate() - 7);
                            return d >= oneWeekAgo && d <= now;
                        }
                        
                        // Month
                        if (this.currentDateRangeFilter === 'month') {
                            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                        }
                        
                        // Year
                        if (this.currentDateRangeFilter === 'year') {
                            return d.getFullYear() === now.getFullYear();
                        }
                        
                        return true;
                    });

                    if (search) filtered = filtered.filter(e => e.description.toLowerCase().includes(search));

                    filtered.sort((a, b) => {
                        if (sort === 'date-desc') return new Date(b.date) - new Date(a.date);
                        if (sort === 'date-asc') return new Date(a.date) - new Date(b.date);
                        if (sort === 'amount-desc') return b.amount - a.amount;
                        if (sort === 'amount-asc') return a.amount - b.amount;
                    });

                    if (filtered.length === 0) {
                        list.innerHTML = '';
                        empty.classList.remove('hidden');
                        return;
                    }
                    empty.classList.add('hidden');

                    list.innerHTML = filtered.map(e => {
                        const cat = this.categoryManager.categories.find(c => c.id === e.categoryId);
                        const color = cat ? cat.color : '#6b7280';
                        const icon = cat ? cat.icon : 'help-circle';
                        return `
                            <div class="flex items-center justify-between p-4 hover:bg-gray-50 transition">
                                <div class="flex items-center space-x-3">
                                    <div class="w-9 h-9 rounded-full flex items-center justify-center" style="background-color:${color}20;">
                                        <i data-lucide="${icon}" class="w-4 h-4" style="color:${color};"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">${e.description}</p>
                                        <p class="text-xs text-gray-500">
                                            ${new Date(e.date).toLocaleDateString()}  ${e.payment}
                                            ${cat ? `  <span style="color:${color}; font-weight:500;">${cat.name}</span>` : ''}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 text-right">
                                    <p class="font-semibold text-red-600">-$${e.amount.toFixed(2)}</p>
                                    <button class="delete-expense-btn text-gray-400 hover:text-red-600" data-id="${e.id}">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    lucide.createIcons();
                }

                updateSummary() {
                    const total = this.expenses.reduce((sum, e) => sum + e.amount, 0);
                    document.getElementById('total-expenses').textContent = total.toFixed(2);
                    document.getElementById('total-transactions').textContent = this.expenses.length;
                }

                showDeleteAllModal() {
                    if (this.expenses.length === 0) {
                        alert('No expenses to delete');
                        return;
                    }
                    
                    document.getElementById('delete-all-modal-title').textContent = 'Delete All Expenses?';
                    document.getElementById('delete-all-modal-message').innerHTML = `Are you sure you want to delete all expenses? This will remove <span id="delete-all-count" class="font-semibold text-gray-900">${this.expenses.length}</span> items and cannot be undone.`;
                    document.getElementById('delete-all-modal').classList.remove('hidden');
                    
                    const confirmBtn = document.getElementById('confirm-delete-all');
                    const cancelBtn = document.getElementById('cancel-delete-all');
                    
                    const handleConfirm = () => {
                        this.deleteAllExpenses();
                        confirmBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', handleCancel);
                    };
                    
                    const handleCancel = () => {
                        document.getElementById('delete-all-modal').classList.add('hidden');
                        confirmBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', handleCancel);
                    };
                    
                    confirmBtn.addEventListener('click', handleConfirm);
                    cancelBtn.addEventListener('click', handleCancel);
                    
                    lucide.createIcons();
                }

                deleteAllExpenses() {
                    this.expenses.forEach(expense => {
                        const amount = Number(expense.amount) || 0;
                        const categoryId = expense.categoryId;
                        if (this.categoryManager && typeof this.categoryManager.revertCategorySpent === 'function') {
                            this.categoryManager.revertCategorySpent(categoryId, amount);
                        }
                    });
                    
                    this.expenses = [];
                    localStorage.setItem('financeflow_expenses', JSON.stringify(this.expenses));
                    
                    const listContainer = document.getElementById('expenses-list');
                    listContainer.style.opacity = '0';
                    listContainer.style.transform = 'scale(0.95)';
                    
                    setTimeout(() => {
                        this.renderExpenses();
                        this.updateSummary();
                        listContainer.style.transition = 'all 0.3s ease';
                        listContainer.style.opacity = '1';
                        listContainer.style.transform = 'scale(1)';
                    }, 200);
                    
                    document.getElementById('delete-all-modal').classList.add('hidden');
                }
            }

            class IncomeManager {
                constructor(categoryManager) {
                    this.categoryManager = categoryManager;
                    this.incomes = JSON.parse(localStorage.getItem('financeflow_incomes')) || [];
                    this.selectedCategories = new Set();
                    this.currentDateRangeFilter = 'all';
                    this.customDateFrom = null;
                    this.customDateTo = null;
                    this.incomeToDeleteId = null;
                    this.init();
                }

                init() {
                    this.populateCategories();
                    this.renderCategoryFilters();
                    this.renderIncomes();
                    this.updateSummary();

                    document.getElementById('income-form').addEventListener('submit', e => this.addIncome(e));
                    document.getElementById('reset-income-form').addEventListener('click', () => this.resetForm());
                    
                    // Date range filter
                    document.getElementById('income-date-range-filter').addEventListener('change', e => {
                        this.currentDateRangeFilter = e.target.value;
                        
                        const customRange = document.getElementById('income-custom-date-range');
                        if (e.target.value === 'custom') {
                            customRange.classList.remove('hidden');
                        } else {
                            customRange.classList.add('hidden');
                            this.customDateFrom = null;
                            this.customDateTo = null;
                            this.renderIncomes();
                        }
                    });
                    
                    // Custom date range buttons
                    document.getElementById('apply-income-date-range').addEventListener('click', () => {
                        this.customDateFrom = document.getElementById('income-date-from').value;
                        this.customDateTo = document.getElementById('income-date-to').value;
                        if (this.customDateFrom && this.customDateTo) {
                            this.renderIncomes();
                        } else {
                            alert('Please select both From and To dates');
                        }
                    });
                    
                    document.getElementById('clear-income-date-range').addEventListener('click', () => {
                        document.getElementById('income-date-from').value = '';
                        document.getElementById('income-date-to').value = '';
                        this.customDateFrom = null;
                        this.customDateTo = null;
                        this.renderIncomes();
                    });
                    
                    // Delete All button
                    document.getElementById('delete-all-income-btn').addEventListener('click', () => this.showDeleteAllModal());
                    
                    document.getElementById('search-income').addEventListener('input', () => this.renderIncomes());
                    document.getElementById('sort-income').addEventListener('change', () => this.renderIncomes());

                    document.getElementById('income-list').addEventListener('click', (e) => {
                        const btn = e.target.closest('.delete-income-btn');
                        if (btn) {
                            this.incomeToDeleteId = btn.dataset.id;
                            this.showDeleteModal();
                        }
                    });

                    document.getElementById('cancel-delete-income').addEventListener('click', () => this.hideDeleteModal());
                    document.getElementById('confirm-delete-income').addEventListener('click', () => this.confirmDeleteIncome());
                }

                populateCategories() {
                    const select = document.getElementById('income-category');

                    const options = this.categoryManager.categories
                        .filter(c => c.type === 'income')
                        .map(c => `<option value="${c.id}">${c.name}</option>`)
                        .join('');

                    select.innerHTML = `<option value="">Select category</option>${options}`;
                }

                renderCategoryFilters() {
                    const container = document.getElementById('income-category-filters');
                    container.innerHTML = '';
                    this.categoryManager.categories.forEach(cat => {
                        if (cat.type !== 'income') return;
                        const btn = document.createElement('button');
                        btn.textContent = cat.name;
                        btn.className = this.selectedCategories.has(cat.id)
                            ? 'px-3 py-1 bg-indigo-600 text-white rounded text-sm font-medium'
                            : 'px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm font-medium hover:bg-gray-200';
                        btn.addEventListener('click', () => {
                            if (this.selectedCategories.has(cat.id)) this.selectedCategories.delete(cat.id);
                            else this.selectedCategories.add(cat.id);
                            this.renderCategoryFilters();
                            this.renderIncomes();
                        });
                        container.appendChild(btn);
                    });

                    const allBtn = document.createElement('button');
                    allBtn.textContent = 'All Categories';
                    allBtn.className = this.selectedCategories.size === 0
                        ? 'px-3 py-1 bg-indigo-600 text-white rounded text-sm font-medium'
                        : 'px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm font-medium hover:bg-gray-200';
                    allBtn.addEventListener('click', () => {
                        this.selectedCategories.clear();
                        this.renderCategoryFilters();
                        this.renderIncomes();
                    });
                    container.insertBefore(allBtn, container.firstChild);
                }

                addIncome(e) {
                    e.preventDefault();
                    const amount = parseFloat(document.getElementById('income-amount').value);
                    const categoryId = document.getElementById('income-category').value;
                    const description = document.getElementById('income-description').value.trim();
                    const date = document.getElementById('income-date').value;
                    const payment = document.getElementById('income-payment').value;
                    const notes = document.getElementById('income-notes').value.trim();
                    if (!amount || !categoryId || !description || !date) return;

                    const newIncome = {
                        id: Date.now().toString(),
                        amount,
                        categoryId: categoryId,
                        description,
                        date,
                        payment,
                        notes
                    };
                    this.incomes.push(newIncome);

                    localStorage.setItem('financeflow_incomes', JSON.stringify(this.incomes));

                    if (this.categoryManager && typeof this.categoryManager.updateCategoryIncome === 'function') {
                        this.categoryManager.updateCategoryIncome(categoryId, amount);
                    }

                    this.renderIncomes();
                    this.updateSummary();
                    this.resetForm();
                }

                resetForm() {
                    document.getElementById('income-form').reset();
                }

                renderIncomes() {
                    const list = document.getElementById('income-list');
                    const empty = document.getElementById('income-empty-state');
                    const search = document.getElementById('search-income').value.toLowerCase();
                    const sort = document.getElementById('sort-income').value;
                    const now = new Date();

                    let filtered = [...this.incomes];
                    if (this.selectedCategories.size > 0) filtered = filtered.filter(e => this.selectedCategories.has(e.categoryId));

                    filtered = filtered.filter(e => {
                        const d = new Date(e.date);
                        
                        // Custom date range
                        if (this.currentDateRangeFilter === 'custom' && this.customDateFrom && this.customDateTo) {
                            const fromDate = new Date(this.customDateFrom);
                            const toDate = new Date(this.customDateTo);
                            toDate.setHours(23, 59, 59, 999);
                            return d >= fromDate && d <= toDate;
                        }
                        
                        // Today
                        if (this.currentDateRangeFilter === 'today') {
                            return d.toDateString() === now.toDateString();
                        }
                        
                        // Week
                        if (this.currentDateRangeFilter === 'week') {
                            const oneWeekAgo = new Date();
                            oneWeekAgo.setDate(now.getDate() - 7);
                            return d >= oneWeekAgo && d <= now;
                        }
                        
                        // Month
                        if (this.currentDateRangeFilter === 'month') {
                            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                        }
                        
                        // Year
                        if (this.currentDateRangeFilter === 'year') {
                            return d.getFullYear() === now.getFullYear();
                        }
                        
                        return true;
                    });

                    if (search) filtered = filtered.filter(e => e.description.toLowerCase().includes(search));

                    filtered.sort((a, b) => {
                        if (sort === 'date-desc') return new Date(b.date) - new Date(a.date);
                        if (sort === 'date-asc') return new Date(a.date) - new Date(b.date);
                        if (sort === 'amount-desc') return b.amount - a.amount;
                        if (sort === 'amount-asc') return a.amount - b.amount;
                    });

                    if (filtered.length === 0) {
                        list.innerHTML = '';
                        empty.classList.remove('hidden');
                        return;
                    }
                    empty.classList.add('hidden');

                    list.innerHTML = filtered.map(income => {
                        const cat = this.categoryManager.categories.find(c => c.id === income.categoryId);
                        const color = cat ? cat.color : '#6b7280';
                        const icon = cat ? cat.icon : 'dollar-sign';
                        return `
                            <div class="flex items-center justify-between p-4 hover:bg-gray-50 transition">
                                <div class="flex items-center space-x-3">
                                    <div class="w-9 h-9 rounded-full flex items-center justify-center" style="background-color:${color}20;">
                                        <i data-lucide="${icon}" class="w-4 h-4" style="color:${color};"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">${income.description}</p>
                                        <p class="text-xs text-gray-500">
                                            ${new Date(income.date).toLocaleDateString()}  ${income.payment}
                                            ${cat ? `  <span style="color:${color}; font-weight:500;">${cat.name}</span>` : ''}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 text-right">
                                    <p class="font-semibold text-green-600">+$${income.amount.toFixed(2)}</p>
                                    <button class="delete-income-btn text-gray-400 hover:text-red-600" data-id="${income.id}">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    lucide.createIcons();
                }

                updateSummary() {
                    const total = this.incomes.reduce((sum, e) => sum + e.amount, 0);
                    document.getElementById('total-income').textContent = total.toFixed(2);
                    document.getElementById('total-income-transactions').textContent = this.incomes.length;
                }

                showDeleteModal() {
                    document.getElementById('delete-income-modal').classList.remove('hidden');
                }

                hideDeleteModal() {
                    document.getElementById('delete-income-modal').classList.add('hidden');
                    this.incomeToDeleteId = null;
                }

                confirmDeleteIncome() {
                    if (!this.incomeToDeleteId) return;

                    const deletedIncome = this.incomes.find(i => i.id === this.incomeToDeleteId);

                    if (!deletedIncome) {
                        console.warn('confirmDeleteIncome: income not found for id', this.incomeToDeleteId);
                        this.hideDeleteModal();
                        return;
                    }

                    const amount = Number(deletedIncome.amount) || 0;
                    const categoryId = deletedIncome.categoryId;

                    if (this.categoryManager && typeof this.categoryManager.revertCategoryIncome === 'function') {
                        this.categoryManager.revertCategoryIncome(categoryId, amount);
                    } else {
                        console.warn('confirmDeleteIncome: categoryManager.revertCategoryIncome not available');
                    }

                    this.incomes = this.incomes.filter(i => i.id !== this.incomeToDeleteId);

                    localStorage.setItem('financeflow_incomes', JSON.stringify(this.incomes));
                    this.renderIncomes();
                    this.updateSummary();
                    this.hideDeleteModal();
                }

                showDeleteAllModal() {
                    if (this.incomes.length === 0) {
                        alert('No income to delete');
                        return;
                    }
                    
                    document.getElementById('delete-all-modal-title').textContent = 'Delete All Income?';
                    document.getElementById('delete-all-modal-message').innerHTML = `Are you sure you want to delete all income entries? This will remove <span id="delete-all-count" class="font-semibold text-gray-900">${this.incomes.length}</span> items and cannot be undone.`;
                    document.getElementById('delete-all-modal').classList.remove('hidden');
                    
                    const confirmBtn = document.getElementById('confirm-delete-all');
                    const cancelBtn = document.getElementById('cancel-delete-all');
                    
                    const handleConfirm = () => {
                        this.deleteAllIncome();
                        confirmBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', handleCancel);
                    };
                    
                    const handleCancel = () => {
                        document.getElementById('delete-all-modal').classList.add('hidden');
                        confirmBtn.removeEventListener('click', handleConfirm);
                        cancelBtn.removeEventListener('click', handleCancel);
                    };
                    
                    confirmBtn.addEventListener('click', handleConfirm);
                    cancelBtn.addEventListener('click', handleCancel);
                    
                    lucide.createIcons();
                }

                deleteAllIncome() {
                    this.incomes.forEach(income => {
                        const amount = Number(income.amount) || 0;
                        const categoryId = income.categoryId;
                        if (this.categoryManager && typeof this.categoryManager.revertCategoryIncome === 'function') {
                            this.categoryManager.revertCategoryIncome(categoryId, amount);
                        }
                    });
                    
                    this.incomes = [];
                    localStorage.setItem('financeflow_incomes', JSON.stringify(this.incomes));
                    
                    const listContainer = document.getElementById('income-list');
                    listContainer.style.opacity = '0';
                    listContainer.style.transform = 'scale(0.95)';
                    
                    setTimeout(() => {
                        this.renderIncomes();
                        this.updateSummary();
                        listContainer.style.transition = 'all 0.3s ease';
                        listContainer.style.opacity = '1';
                        listContainer.style.transform = 'scale(1)';
                    }, 200);
                    
                    document.getElementById('delete-all-modal').classList.add('hidden');
                }
            }

            // Budget Manager Class
            class BudgetManager {
                constructor(categoryManager, expenseManager) {
                    this.categoryManager = categoryManager;
                    this.expenseManager = expenseManager;
                    this.currentTab = 'monthly';
                    this.currentFilter = 'all';
                    this.editingCategory = null;
                    this.editingType = 'monthly';
                    this.init();
                }

                init() {
                    this.loadBudgets();
                    this.renderBudgets();
                    this.updateOverview();
                    this.bindEvents();
                }

                loadBudgets() {
                    // Budgets are stored in categories, so we just need to ensure yearlyBudget field exists
                    this.categoryManager.categories.forEach(cat => {
                        if (!cat.yearlyBudget) cat.yearlyBudget = 0;
                        if (!cat.yearlySpent) cat.yearlySpent = 0;
                    });
                }

                bindEvents() {
                    // Tab switching
                    document.getElementById('monthly-tab').addEventListener('click', () => this.switchTab('monthly'));
                    document.getElementById('yearly-tab').addEventListener('click', () => this.switchTab('yearly'));

                    // Filter
                    document.getElementById('monthly-budget-filter').addEventListener('change', (e) => {
                        this.currentFilter = e.target.value;
                        this.renderBudgets();
                    });

                    // Modal
                    document.getElementById('close-budget-modal').addEventListener('click', () => this.closeModal());
                    document.getElementById('cancel-budget-btn').addEventListener('click', () => this.closeModal());
                    document.getElementById('reset-budget-btn').addEventListener('click', () => this.resetBudget());
                    document.getElementById('budget-form').addEventListener('submit', (e) => this.saveBudget(e));

                    // Update when switching to budget page
                    document.querySelectorAll('[data-page="budget"]').forEach(link => {
                        link.addEventListener('click', () => {
                            setTimeout(() => {
                                this.renderBudgets();
                                this.updateOverview();
                            }, 100);
                        });
                    });
                }

                switchTab(tab) {
                    this.currentTab = tab;
                    
                    // Update tab buttons
                    document.getElementById('monthly-tab').className = tab === 'monthly'
                        ? 'px-6 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm'
                        : 'px-6 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
                    
                    document.getElementById('yearly-tab').className = tab === 'yearly'
                        ? 'px-6 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm'
                        : 'px-6 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';

                    // Toggle sections
                    document.getElementById('monthly-budget-section').classList.toggle('hidden', tab !== 'monthly');
                    document.getElementById('yearly-budget-section').classList.toggle('hidden', tab !== 'yearly');
                    
                    this.renderBudgets();
                }

                renderBudgets() {
                    if (this.currentTab === 'monthly') {
                        this.renderMonthlyBudgets();
                    } else {
                        this.renderYearlyBudgets();
                    }
                }

                renderMonthlyBudgets() {
                    const list = document.getElementById('monthly-budget-list');
                    const empty = document.getElementById('monthly-budget-empty-state');
                    
                    let categories = this.categoryManager.categories.filter(cat => cat.type === 'expense');
                    
                    if (categories.length === 0) {
                        list.classList.add('hidden');
                        empty.classList.remove('hidden');
                        return;
                    }

                    // Apply filter
                    if (this.currentFilter !== 'all') {
                        categories = categories.filter(cat => {
                            if (this.currentFilter === 'no-budget') return !cat.budget || cat.budget === 0;
                            if (!cat.budget || cat.budget === 0) return false;
                            
                            const percentage = (cat.spent / cat.budget) * 100;
                            if (this.currentFilter === 'on-track') return percentage < 70;
                            if (this.currentFilter === 'warning') return percentage >= 70 && percentage < 100;
                            if (this.currentFilter === 'over') return percentage >= 100;
                            return true;
                        });
                    }
                    
                    if (categories.length === 0) {
                        list.innerHTML = '<p class="text-center text-gray-500 py-8">No categories match the selected filter</p>';
                        return;
                    }
                    
                    list.classList.remove('hidden');
                    empty.classList.add('hidden');
                    
                    list.innerHTML = categories.map(cat => this.createMonthlyBudgetCard(cat)).join('');
                    
                    // Bind edit buttons
                    categories.forEach(cat => {
                        const editBtn = document.querySelector(`[data-edit-monthly="${cat.id}"]`);
                        if (editBtn) {
                            editBtn.addEventListener('click', () => this.openModal(cat, 'monthly'));
                        }
                    });
                    
                    lucide.createIcons();
                }

                renderYearlyBudgets() {
                    const list = document.getElementById('yearly-budget-list');
                    const empty = document.getElementById('yearly-budget-empty-state');
                    
                    const categories = this.categoryManager.categories.filter(cat => cat.type === 'expense');
                    
                    if (categories.length === 0) {
                        list.classList.add('hidden');
                        empty.classList.remove('hidden');
                        return;
                    }
                    
                    list.classList.remove('hidden');
                    empty.classList.add('hidden');
                    
                    list.innerHTML = categories.map(cat => this.createYearlyBudgetCard(cat)).join('');
                    
                    // Bind edit buttons
                    categories.forEach(cat => {
                        const editBtn = document.querySelector(`[data-edit-yearly="${cat.id}"]`);
                        if (editBtn) {
                            editBtn.addEventListener('click', () => this.openModal(cat, 'yearly'));
                        }
                    });
                    
                    lucide.createIcons();
                }

                createMonthlyBudgetCard(category) {
                    const spent = category.spent || 0;
                    const budget = category.budget || 0;
                    const remaining = budget - spent;
                    const percentage = budget > 0 ? Math.round((spent / budget) * 100) : 0;
                    
                    let statusColor = 'gray';
                    let statusText = 'No Budget';
                    let progressColor = '#9ca3af';
                    
                    if (budget > 0) {
                        statusColor = 'green';
                        statusText = 'On Track';
                        progressColor = category.color;
                        
                        if (percentage >= 100) {
                            statusColor = 'red';
                            statusText = 'Over Budget';
                            progressColor = '#ef4444';
                        } else if (percentage >= 70) {
                            statusColor = 'yellow';
                            statusText = 'Warning';
                            progressColor = '#f59e0b';
                        }
                    }
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-5 hover:shadow-md transition-all">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3 flex-1">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color: ${category.color}20;">
                                        <i data-lucide="${category.icon}" class="w-5 h-5" style="color: ${category.color};"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between">
                                            <h3 class="font-semibold text-gray-900">${category.name}</h3>
                                            <button data-edit-monthly="${category.id}" class="px-3 py-1 text-sm border border-indigo-300 text-indigo-600 rounded-lg hover:bg-indigo-50 transition-colors">
                                                ${budget > 0 ? 'Edit' : 'Set'} Budget
                                            </button>
                                        </div>
                                        <p class="text-sm text-gray-500">${category.transactions} transactions this month</p>
                                    </div>
                                </div>
                            </div>
                            
                            ${budget > 0 ? `
                            <div class="mb-3">
                                <div class="flex items-center justify-between text-sm mb-2">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-gray-700">Spent: <span class="font-semibold text-red-600">$${spent.toFixed(2)}</span></span>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-700">
                                            ${statusText}
                                        </span>
                                    </div>
                                    <span class="text-gray-700">Budget: <span class="font-semibold">$${budget.toFixed(2)}</span></span>
                                </div>
                                
                                <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full transition-all duration-300" style="width: ${Math.min(percentage, 100)}%; background-color: ${progressColor};"></div>
                                </div>
                                
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-xs text-gray-500">$0</span>
                                    <span class="text-sm font-semibold text-gray-700">${percentage}%  $${Math.abs(remaining).toFixed(2)} ${remaining >= 0 ? 'left' : 'over'}</span>
                                    <span class="text-xs text-gray-500">$${budget.toFixed(2)}</span>
                                </div>
                            </div>
                            ` : `
                            <div class="text-center py-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-500">No budget set for this category</p>
                            </div>
                            `}
                        </div>
                    `;
                }

                createYearlyBudgetCard(category) {
                    const yearlySpent = this.calculateYearlySpent(category.id);
                    const yearlyBudget = category.yearlyBudget || 0;
                    const remaining = yearlyBudget - yearlySpent;
                    const percentage = yearlyBudget > 0 ? Math.round((yearlySpent / yearlyBudget) * 100) : 0;
                    
                    let statusColor = 'gray';
                    let statusText = 'No Budget';
                    let progressColor = '#9ca3af';
                    
                    if (yearlyBudget > 0) {
                        statusColor = 'green';
                        statusText = 'On Track';
                        progressColor = category.color;
                        
                        if (percentage >= 100) {
                            statusColor = 'red';
                            statusText = 'Over Budget';
                            progressColor = '#ef4444';
                        } else if (percentage >= 70) {
                            statusColor = 'yellow';
                            statusText = 'Warning';
                            progressColor = '#f59e0b';
                        }
                    }
                    
                    return `
                        <div class="border border-gray-200 rounded-lg p-5 hover:shadow-md transition-all">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3 flex-1">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background-color: ${category.color}20;">
                                        <i data-lucide="${category.icon}" class="w-5 h-5" style="color: ${category.color};"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between">
                                            <h3 class="font-semibold text-gray-900">${category.name}</h3>
                                            <button data-edit-yearly="${category.id}" class="px-3 py-1 text-sm border border-purple-300 text-purple-600 rounded-lg hover:bg-purple-50 transition-colors">
                                                ${yearlyBudget > 0 ? 'Edit' : 'Set'} Yearly Budget
                                            </button>
                                        </div>
                                        <p class="text-sm text-gray-500">Year-to-date spending</p>
                                    </div>
                                </div>
                            </div>
                            
                            ${yearlyBudget > 0 ? `
                            <div class="mb-3">
                                <div class="flex items-center justify-between text-sm mb-2">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-gray-700">YTD Spent: <span class="font-semibold text-red-600">$${yearlySpent.toFixed(2)}</span></span>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-700">
                                            ${statusText}
                                        </span>
                                    </div>
                                    <span class="text-gray-700">Budget: <span class="font-semibold">$${yearlyBudget.toFixed(2)}</span></span>
                                </div>
                                
                                <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full transition-all duration-300" style="width: ${Math.min(percentage, 100)}%; background-color: ${progressColor};"></div>
                                </div>
                                
                                <div class="flex items-center justify-between mt-2">
                                    <span class="text-xs text-gray-500">$0</span>
                                    <span class="text-sm font-semibold text-gray-700">${percentage}%  $${Math.abs(remaining).toFixed(2)} ${remaining >= 0 ? 'left' : 'over'}</span>
                                    <span class="text-xs text-gray-500">$${yearlyBudget.toFixed(2)}</span>
                                </div>
                            </div>
                            ` : `
                            <div class="text-center py-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-500">No yearly budget set for this category</p>
                                <p class="text-xs text-gray-400 mt-1">YTD Spent: $${yearlySpent.toFixed(2)}</p>
                            </div>
                            `}
                        </div>
                    `;
                }

                calculateYearlySpent(categoryId) {
                    const currentYear = new Date().getFullYear();
                    const yearlyExpenses = this.expenseManager.expenses.filter(exp => {
                        const expYear = new Date(exp.date).getFullYear();
                        return exp.categoryId === categoryId && expYear === currentYear;
                    });
                    return yearlyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                }

                openModal(category, type) {
                    this.editingCategory = category;
                    this.editingType = type;
                    
                    const modal = document.getElementById('budget-modal');
                    const iconDiv = document.getElementById('budget-modal-icon');
                    const budgetTypeText = type === 'monthly' ? 'Monthly Budget' : 'Yearly Budget';
                    
                    document.getElementById('budget-modal-title').textContent = `Set ${budgetTypeText}`;
                    document.getElementById('budget-modal-category-name').textContent = category.name;
                    document.getElementById('budget-modal-budget-type').textContent = budgetTypeText;
                    
                    iconDiv.style.backgroundColor = `${category.color}20`;
                    iconDiv.innerHTML = `<i data-lucide="${category.icon}" class="w-5 h-5" style="color: ${category.color};"></i>`;
                    
                    const currentBudget = type === 'monthly' ? (category.budget || 0) : (category.yearlyBudget || 0);
                    const currentSpent = type === 'monthly' ? (category.spent || 0) : this.calculateYearlySpent(category.id);
                    
                    document.getElementById('budget-amount').value = currentBudget > 0 ? currentBudget : '';
                    document.getElementById('budget-modal-current-spent').textContent = currentSpent.toFixed(2);
                    
                    modal.classList.remove('hidden');
                    lucide.createIcons();
                }

                closeModal() {
                    document.getElementById('budget-modal').classList.add('hidden');
                    this.editingCategory = null;
                    document.getElementById('budget-form').reset();
                }

                saveBudget(e) {
                    e.preventDefault();
                    
                    const amount = parseFloat(document.getElementById('budget-amount').value);
                    if (!amount || amount <= 0) {
                        alert('Please enter a valid budget amount');
                        return;
                    }
                    
                    const categoryIndex = this.categoryManager.categories.findIndex(c => c.id === this.editingCategory.id);
                    if (categoryIndex === -1) return;
                    
                    if (this.editingType === 'monthly') {
                        this.categoryManager.categories[categoryIndex].budget = amount;
                    } else {
                        this.categoryManager.categories[categoryIndex].yearlyBudget = amount;
                    }
                    
                    this.categoryManager.saveCategories();
                    this.renderBudgets();
                    this.updateOverview();
                    this.closeModal();
                }

                resetBudget() {
                    if (!confirm('Are you sure you want to reset this budget to $0?')) return;
                    
                    const categoryIndex = this.categoryManager.categories.findIndex(c => c.id === this.editingCategory.id);
                    if (categoryIndex === -1) return;
                    
                    if (this.editingType === 'monthly') {
                        this.categoryManager.categories[categoryIndex].budget = 0;
                    } else {
                        this.categoryManager.categories[categoryIndex].yearlyBudget = 0;
                    }
                    
                    this.categoryManager.saveCategories();
                    this.renderBudgets();
                    this.updateOverview();
                    this.closeModal();
                }

                updateOverview() {
                    const expenseCategories = this.categoryManager.categories.filter(cat => cat.type === 'expense');
                    const currentYear = new Date().getFullYear();
                    
                    // Monthly calculations
                    const totalMonthlyBudget = expenseCategories.reduce((sum, cat) => sum + (cat.budget || 0), 0);
                    const totalMonthlySpent = expenseCategories.reduce((sum, cat) => sum + (cat.spent || 0), 0);
                    const totalMonthlyRemaining = totalMonthlyBudget - totalMonthlySpent;
                    const monthlyPercentage = totalMonthlyBudget > 0 ? Math.round((totalMonthlySpent / totalMonthlyBudget) * 100) : 0;
                    
                    // Yearly calculations
                    const totalYearlyBudget = expenseCategories.reduce((sum, cat) => sum + (cat.yearlyBudget || 0), 0);
                    const totalYearlySpent = expenseCategories.reduce((sum, cat) => sum + this.calculateYearlySpent(cat.id), 0);
                    const yearlyPercentage = totalYearlyBudget > 0 ? Math.round((totalYearlySpent / totalYearlyBudget) * 100) : 0;
                    
                    // Update header
                    document.getElementById('budget-total-monthly').textContent = totalMonthlyBudget.toFixed(2);
                    document.getElementById('budget-spent-monthly').textContent = totalMonthlySpent.toFixed(2);
                    document.getElementById('budget-remaining-monthly').textContent = totalMonthlyRemaining.toFixed(2);
                    
                    // Update overview cards
                    document.getElementById('budget-overview-monthly').textContent = totalMonthlyBudget.toLocaleString();
                    document.getElementById('budget-overview-spent-monthly').textContent = totalMonthlySpent.toFixed(2);
                    document.getElementById('budget-spent-percentage-monthly').textContent = `${monthlyPercentage}% of monthly budget used`;
                    
                    document.getElementById('budget-overview-yearly').textContent = totalYearlyBudget.toLocaleString();
                    document.getElementById('budget-overview-spent-yearly').textContent = totalYearlySpent.toFixed(2);
                    document.getElementById('budget-spent-percentage-yearly').textContent = `${yearlyPercentage}% of yearly budget`;
                }
            }

            // Savings Manager
            class SavingsManager {
                constructor(expenseManager, incomeManager) {
                    this.expenseManager = expenseManager;
                    this.incomeManager = incomeManager;
                    this.categoryManager = categoryManager;
                    this.goals = JSON.parse(localStorage.getItem('financeflow_savings')) || [];
                    this.currentFilter = 'all';
                    this.currentSort = 'progress-desc';
                    this.editingGoal = null;
                    this.goalToDelete = null;
                    this.selectedIcon = 'target';
                    this.init();
                }

                init() {
                    this.renderGoals();
                    this.updateOverview();
                    this.generateInsights();
                    this.bindEvents();
                }

                bindEvents() {
                    document.getElementById('add-savings-goal-btn').addEventListener('click', () => this.openGoalModal());
                    document.getElementById('empty-add-goal-btn').addEventListener('click', () => this.openGoalModal());
                    document.getElementById('close-savings-modal').addEventListener('click', () => this.closeGoalModal());
                    document.getElementById('cancel-savings-btn').addEventListener('click', () => this.closeGoalModal());
                    document.getElementById('savings-goal-form').addEventListener('submit', (e) => this.saveGoal(e));
                    
                    document.getElementById('savings-filter').addEventListener('change', (e) => {
                        this.currentFilter = e.target.value;
                        this.renderGoals();
                    });
                    
                    document.getElementById('savings-sort').addEventListener('change', (e) => {
                        this.currentSort = e.target.value;
                        this.renderGoals();
                    });
                    
                    document.querySelectorAll('.goal-icon-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.selectIcon(btn.dataset.icon);
                        });
                    });
                    
                    document.getElementById('close-deposit-modal').addEventListener('click', () => this.closeDepositModal());
                    document.getElementById('cancel-deposit-btn').addEventListener('click', () => this.closeDepositModal());
                    document.getElementById('quick-deposit-form').addEventListener('submit', (e) => this.saveDeposit(e));
                    
                    document.getElementById('cancel-delete-goal').addEventListener('click', () => this.closeDeleteModal());
                    document.getElementById('confirm-delete-goal').addEventListener('click', () => this.confirmDelete());
                    
                    document.getElementById('deposit-date').valueAsDate = new Date();
                }

                selectIcon(icon) {
                    document.querySelectorAll('.goal-icon-btn').forEach(btn => {
                        btn.className = btn.dataset.icon === icon
                            ? 'goal-icon-btn p-3 border-2 border-indigo-500 rounded-lg bg-indigo-50'
                            : 'goal-icon-btn p-3 border-2 border-gray-200 rounded-lg hover:border-indigo-500';
                    });
                    this.selectedIcon = icon;
                    document.getElementById('savings-goal-icon').value = icon;
                }

                openGoalModal(goal = null) {
                    this.editingGoal = goal;
                    const modal = document.getElementById('savings-goal-modal');
                    
                    if (goal) {
                        document.getElementById('savings-modal-title').textContent = 'Edit Goal';
                        document.getElementById('savings-goal-name').value = goal.name;
                        document.getElementById('savings-goal-target').value = goal.target;
                        document.getElementById('savings-goal-current').value = goal.current;
                        document.getElementById('savings-goal-deadline').value = goal.deadline || '';
                        document.getElementById('savings-goal-category').value = goal.category || 'other';
                        this.selectIcon(goal.icon);
                        document.getElementById('current-amount-field').classList.remove('hidden');
                    } else {
                        document.getElementById('savings-modal-title').textContent = 'Create Savings Goal';
                        document.getElementById('savings-goal-form').reset();
                        this.selectIcon('target');
                        document.getElementById('current-amount-field').classList.add('hidden');
                    }
                    
                    modal.classList.remove('hidden');
                    lucide.createIcons();
                }

                closeGoalModal() {
                    document.getElementById('savings-goal-modal').classList.add('hidden');
                    this.editingGoal = null;
                }

                saveGoal(e) {
                    e.preventDefault();
                    
                    const goalData = {
                        name: document.getElementById('savings-goal-name').value.trim(),
                        target: parseFloat(document.getElementById('savings-goal-target').value),
                        deadline: document.getElementById('savings-goal-deadline').value,
                        category: document.getElementById('savings-goal-category').value,
                        icon: document.getElementById('savings-goal-icon').value
                    };
                    
                    if (this.editingGoal) {
                        const index = this.goals.findIndex(g => g.id === this.editingGoal.id);
                        this.goals[index] = {
                            ...this.editingGoal,
                            ...goalData,
                            current: parseFloat(document.getElementById('savings-goal-current').value) || this.editingGoal.current
                        };
                    } else {
                        const newGoal = {
                            id: Date.now().toString(),
                            ...goalData,
                            current: 0,
                            deposits: [],
                            createdAt: new Date().toISOString()
                        };
                        this.goals.push(newGoal);
                    }
                    
                    this.saveToStorage();
                    this.renderGoals();
                    this.updateOverview();
                    this.generateInsights();
                    
                    // Update charts if they exist
                    if (window.updateSavingsCharts) {
                        window.updateSavingsCharts();
                    }
                    
                    this.closeGoalModal();
                }

                renderGoals() {
                    const grid = document.getElementById('savings-goals-grid');
                    const empty = document.getElementById('savings-empty-state');
                    
                    let filtered = [...this.goals];
                    
                    //  Updated filter logic with "spent" option
                    if (this.currentFilter === 'active') {
                        filtered = filtered.filter(g => g.current < g.target && !g.markedSpent);
                    } else if (this.currentFilter === 'completed') {
                        filtered = filtered.filter(g => g.current >= g.target && !g.markedSpent);
                    } else if (this.currentFilter === 'spent') {
                        filtered = filtered.filter(g => g.markedSpent === true);
                    }
                    
                    filtered.sort((a, b) => {
                        const aProgress = (a.current / a.target) * 100;
                        const bProgress = (b.current / b.target) * 100;
                        
                        if (this.currentSort === 'progress-desc') return bProgress - aProgress;
                        if (this.currentSort === 'progress-asc') return aProgress - bProgress;
                        if (this.currentSort === 'amount-desc') return b.current - a.current;
                        if (this.currentSort === 'deadline-asc') {
                            if (!a.deadline) return 1;
                            if (!b.deadline) return -1;
                            return new Date(a.deadline) - new Date(b.deadline);
                        }
                        return 0;
                    });
                    
                    if (filtered.length === 0) {
                        grid.classList.add('hidden');
                        empty.classList.remove('hidden');
                        return;
                    }
                    
                    grid.classList.remove('hidden');
                    empty.classList.add('hidden');
                    
                    grid.innerHTML = filtered.map(goal => this.createGoalCard(goal)).join('');
                    
                    filtered.forEach(goal => {
                        const depositBtn = document.querySelector(`[data-deposit="${goal.id}"]`);
                        const editBtn = document.querySelector(`[data-edit="${goal.id}"]`);
                        const deleteBtn = document.querySelector(`[data-delete="${goal.id}"]`);
                        const markSpentBtn = document.querySelector(`[data-mark-spent="${goal.id}"]`);
                        
                        if (depositBtn) depositBtn.addEventListener('click', () => this.openDepositModal(goal));
                        if (editBtn) editBtn.addEventListener('click', () => this.openGoalModal(goal));
                        if (deleteBtn) deleteBtn.addEventListener('click', () => this.openDeleteModal(goal));
                        if (markSpentBtn) markSpentBtn.addEventListener('click', () => this.markGoalAsSpent(goal));
                    });
                    
                    lucide.createIcons();
                }

                markGoalAsSpent(goal) {
                    const goalIndex = this.goals.findIndex(g => g.id === goal.id);
                    if (goalIndex === -1) return;
                    
                    // Store the spent amount
                    const spentAmount = goal.current;
                    
                    // Mark as spent
                    this.goals[goalIndex].markedSpent = true;
                    this.goals[goalIndex].spentDate = new Date().toISOString();
                    this.goals[goalIndex].spentAmount = spentAmount;
                    
                    //  Auto-create expense (for tracking only, won't affect balance)
                    this.createSavingsSpentExpense(spentAmount, new Date().toISOString().split('T')[0], goal.name);
                    
                    this.saveToStorage();
                    this.renderGoals();
                    this.updateOverview();
                    this.generateInsights();
                    
                    if (window.updateSavingsCharts) {
                        window.updateSavingsCharts();
                    }
                    
                    // Update dashboard
                    if (window.dashboardManager && window.dashboardManager.updateDashboard) {
                        window.dashboardManager.updateDashboard();
                    }
                    
                    console.log(` Goal "${goal.name}" marked as spent: $${spentAmount.toFixed(2)}`);
                }

                createSavingsSpentExpense(amount, date, goalName) {
                    if (!this.expenseManager || !this.categoryManager) {
                        console.error('ExpenseManager or CategoryManager not available');
                        return;
                    }
                    
                    // Find "Other" expense category (don't create, just find)
                    const expenseCategory = this.categoryManager.categories.find(c => 
                        c.type === 'expense' && c.id === 'other-expense'
                    );
                    
                    if (!expenseCategory) {
                        console.error('Other expense category not found');
                        return;
                    }
                    
                    // Create expense
                    const expense = {
                        id: Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9),
                        amount: amount,
                        categoryId: 'other-expense',
                        description: `${goalName}`,
                        date: date,
                        payment: 'other',
                        notes: `Spent from savings goal: ${goalName}`,
                        isSavingsSpent: true
                    };
                    
                    // Add expense
                    this.expenseManager.expenses.push(expense);
                    localStorage.setItem('financeflow_expenses', JSON.stringify(this.expenseManager.expenses));
                    
                    // Update category
                    if (this.categoryManager && typeof this.categoryManager.updateCategorySpent === 'function') {
                        this.categoryManager.updateCategorySpent('other-expense', amount);
                    }
                    
                    // Update UI
                    if (this.expenseManager.renderExpenses) {
                        this.expenseManager.renderExpenses();
                    }
                    if (this.expenseManager.updateSummary) {
                        this.expenseManager.updateSummary();
                    }
                    
                    console.log(` Expense created: $${amount.toFixed(2)} in "Other" expense category`);
                }

                createGoalCard(goal) {
                    const progress = Math.min(100, (goal.current / goal.target) * 100);
                    const remaining = goal.target - goal.current;
                    const isCompleted = goal.current >= goal.target;
                    
                    const categoryColors = {
                        'emergency': '#ef4444',
                        'travel': '#06b6d4',
                        'purchase': '#8b5cf6',
                        'education': '#f59e0b',
                        'home': '#4f46e5',
                        'other': '#6b7280'
                    };
                    const color = categoryColors[goal.category] || '#6b7280';
                    
                    let deadlineInfo = '';
                    if (goal.deadline && !isCompleted) {
                        const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));
                        if (daysLeft < 0) {
                            deadlineInfo = `<span class="text-xs text-red-600 font-medium">Past deadline</span>`;
                        } else if (daysLeft < 30) {
                            deadlineInfo = `<span class="text-xs text-orange-600 font-medium">${daysLeft} days left</span>`;
                        } else {
                            deadlineInfo = `<span class="text-xs text-gray-500">Due: ${new Date(goal.deadline).toLocaleDateString()}</span>`;
                        }
                    }
                    
                    return `
                        <div class="bg-white rounded-xl shadow-sm ${isCompleted ? 'border-2 border-green-200 bg-green-50' : 'border border-gray-100'} p-5 hover:shadow-lg transition-all relative overflow-hidden">
                            ${isCompleted ? `<div class="absolute top-0 right-0 bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-bl-lg">COMPLETED</div>` : ''}
                            
                            ${isCompleted && !goal.markedSpent ? `
                                <div data-mark-spent="${goal.id}" class="absolute bottom-0 right-0 bg-orange-500 hover:bg-orange-600 text-white text-xs font-bold px-3 py-1 rounded-tl-lg cursor-pointer transition-colors">
                                    MARK SPENT
                                </div>
                            ` : goal.markedSpent ? `
                                <div class="absolute bottom-0 right-0 bg-gray-400 text-white text-xs font-bold px-3 py-1 rounded-tl-lg">
                                     SPENT
                                </div>
                            ` : ''}
                            
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background-color: ${color}20">
                                        <i data-lucide="${goal.icon}" class="w-6 h-6" style="color: ${color}"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-900 text-lg">${goal.name}</h3>
                                        <p class="text-xs text-gray-500">${goal.category}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-1">
                                    <button data-edit="${goal.id}" class="text-gray-400 hover:text-indigo-600 p-1.5 rounded transition">
                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                    </button>
                                    <button data-delete="${goal.id}" class="text-gray-400 hover:text-red-600 p-1.5 rounded transition">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="flex items-end justify-between mb-2">
                                <div>
                                    <p class="text-3xl font-bold" style="color: ${color}">$${goal.current.toFixed(0)}</p>
                                    <p class="text-sm text-gray-500">of $${goal.target.toFixed(0)} goal</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-bold text-gray-900">${progress.toFixed(0)}%</p>
                                    ${deadlineInfo}
                                </div>
                            </div>
                            
                            <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full rounded-full transition-all duration-500" style="width: ${progress}%; background: linear-gradient(90deg, ${color}, ${color}dd)"></div>
                            </div>
                            
                            ${goal.markedSpent ? `
                                <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <p class="text-sm text-gray-700 font-medium text-center">
                                         Marked as spent on ${new Date(goal.spentDate).toLocaleDateString()}
                                    </p>
                                    <p class="text-xs text-gray-500 text-center mt-1">
                                        Amount: $${goal.spentAmount.toFixed(2)}  Added as an expense in expenses
                                    </p>
                                </div>
                            ` : !isCompleted ? `
                                <p class="text-sm text-gray-600 mt-3">
                                    <span class="font-semibold">${remaining > 0 ? `$${remaining.toFixed(2)} to go!` : 'Goal reached!'}</span>
                                </p>
                                <button data-deposit="${goal.id}" class="w-full py-2.5 rounded-lg font-semibold transition mt-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white hover:from-indigo-600 hover:to-purple-600">
                                    <i data-lucide="plus-circle" class="w-4 h-4 inline mr-2"></i>Add Deposit
                                </button>
                            ` : `
                                <div class="mt-3 p-3 bg-green-50 rounded-lg border border-green-200">
                                    <p class="text-sm text-green-700 font-medium text-center">
                                         Goal Completed!
                                    </p>
                                    <p class="text-xs text-green-600 text-center mt-1">
                                        Click "MARK SPENT" below when you're ready to use this money
                                    </p>
                                </div>
                            `}
                        </div>
                    `;
                }

                createSavingsExpense(amount, date, goalName) {
                    // Find or create "Savings" category in expenses
                    let savingsCategory = this.expenseManager.categoryManager.categories.find(
                        c => c.type === 'expense' && c.name === 'Savings'
                    );
                    
                    // If no Savings category, use "Other" expense category
                    if (!savingsCategory) {
                        savingsCategory = this.expenseManager.categoryManager.categories.find(
                            c => c.type === 'expense' && c.name === 'Other'
                        );
                    }
                    
                    if (!savingsCategory) {
                        console.error('No expense category available for savings transfer');
                        return;
                    }
                    
                    // Create expense object
                    const savingsExpense = {
                        id: Date.now().toString() + '-savings',
                        description: `Savings Transfer: ${goalName}`,
                        amount: amount,
                        categoryId: savingsCategory.id,
                        date: date,
                        paymentMethod: 'other',
                        notes: `Auto-generated: Money moved to ${goalName} savings goal`,
                        createdAt: new Date().toISOString(),
                        isSavingsTransfer: true  //  Mark it as savings transfer
                    };
                    
                    // Add to expenses
                    this.expenseManager.expenses.push(savingsExpense);
                    localStorage.setItem('financeflow-expenses', JSON.stringify(this.expenseManager.expenses));
                    
                    // Update category spent
                    savingsCategory.spent += amount;
                    this.expenseManager.categoryManager.saveToStorage();
                    
                    // Update expense manager UI if on expense page
                    if (typeof this.expenseManager.renderExpenses === 'function') {
                        this.expenseManager.renderExpenses();
                        this.expenseManager.updateSummary();
                    }
                    
                    console.log(` Auto-created savings transfer expense: $${amount.toFixed(2)}`);
                }

                openDepositModal(goal) {
                    document.getElementById('deposit-goal-id').value = goal.id;
                    document.getElementById('deposit-goal-name').textContent = goal.name;
                    document.getElementById('deposit-current').textContent = goal.current.toFixed(2);
                    document.getElementById('deposit-target').textContent = goal.target.toFixed(2);
                    document.getElementById('quick-deposit-form').reset();
                    document.getElementById('deposit-date').valueAsDate = new Date();
                    document.getElementById('quick-deposit-modal').classList.remove('hidden');
                    lucide.createIcons();
                }

                closeDepositModal() {
                    document.getElementById('quick-deposit-modal').classList.add('hidden');
                }

                saveDeposit(e) {
                    e.preventDefault();
                    
                    const goalId = document.getElementById('deposit-goal-id').value;
                    const amount = parseFloat(document.getElementById('deposit-amount').value);
                    const date = document.getElementById('deposit-date').value;
                    
                    const goal = this.goals.find(g => g.id === goalId);
                    if (!goal) return;
                    
                    // Add deposit to goal
                    goal.deposits.push({
                        amount,
                        date,
                        timestamp: new Date().toISOString()
                    });
                    goal.current += amount;
                                        
                    this.saveToStorage();
                    this.renderGoals();
                    this.updateOverview();
                    this.generateInsights();
                    
                    if (window.updateSavingsCharts) {
                        window.updateSavingsCharts();
                    }
                    
                    this.closeDepositModal();
                }

                openDeleteModal(goal) {
                    this.goalToDelete = goal;
                    document.getElementById('delete-goal-modal').classList.remove('hidden');
                    lucide.createIcons();
                }

                closeDeleteModal() {
                    document.getElementById('delete-goal-modal').classList.add('hidden');
                    this.goalToDelete = null;
                }

                confirmDelete() {
                    if (!this.goalToDelete) return;
                    this.goals = this.goals.filter(g => g.id !== this.goalToDelete.id);
                    this.saveToStorage();
                    this.renderGoals();
                    this.updateOverview();
                    this.generateInsights();
                    
                    // Update charts if they exist
                    if (window.updateSavingsCharts) {
                        window.updateSavingsCharts();
                    }
                    
                    this.closeDeleteModal();
                }

                updateOverview() {
                    // Exclude spent goals from Total Saved
                    const totalSaved = this.goals
                        .filter(g => !g.markedSpent)
                        .reduce((sum, g) => sum + g.current, 0);
                    
                    // Active goals should NOT be completed AND NOT marked spent
                    const activeGoals = this.goals.filter(g => g.current < g.target && !g.markedSpent).length;
                    
                    const now = new Date();
                    
                    // This Month should only count deposits to NON-spent goals
                    const thisMonth = this.goals
                        .filter(g => !g.markedSpent)
                        .reduce((sum, g) => {
                            const monthDeposits = g.deposits.filter(d => {
                                const dDate = new Date(d.date);
                                return dDate.getMonth() === now.getMonth() && 
                                    dDate.getFullYear() === now.getFullYear();
                            }).reduce((s, d) => s + d.amount, 0);
                            
                            return sum + monthDeposits;
                        }, 0);
                    
                    //  NEW CALCULATION: Savings rate = (sum of current / sum of targets) * 100
                    const activeGoalsOnly = this.goals.filter(g => !g.markedSpent); // Only non-spent goals
                    const totalCurrentSaved = activeGoalsOnly.reduce((sum, g) => sum + g.current, 0);
                    const totalTargetAmount = activeGoalsOnly.reduce((sum, g) => sum + g.target, 0);
                    const savingsRate = totalTargetAmount > 0 ? Math.round((totalCurrentSaved / totalTargetAmount) * 100) : 0;
                    
                    // Update UI elements
                    document.getElementById('banner-total-saved').textContent = totalSaved.toFixed(0);
                    document.getElementById('banner-active-goals').textContent = activeGoals;
                    document.getElementById('banner-month-saved').textContent = thisMonth.toFixed(0);
                    document.getElementById('banner-savings-rate').textContent = savingsRate;
                }

                generateInsights() {
                    const insights = [];
                    const totalSaved = this.goals.reduce((sum, g) => sum + g.current, 0);
                    const avgProgress = this.goals.length > 0 ? this.goals.reduce((sum, g) => sum + Math.min(100, (g.current / g.target) * 100), 0) / this.goals.length : 0;
                    
                    if (avgProgress >= 75) {
                        insights.push(' Amazing! You\'re averaging 75%+ progress across your goals!');
                    } else if (avgProgress >= 50) {
                        insights.push(' Great work! You\'re over halfway to your goals on average.');
                    } else if (this.goals.length > 0) {
                        insights.push(' Keep going! Every deposit brings you closer to your dreams.');
                    }
                    
                    const nearDeadline = this.goals.filter(g => {
                        if (!g.deadline || g.current >= g.target) return false;
                        const daysLeft = (new Date(g.deadline) - new Date()) / (1000 * 60 * 60 * 24);
                        return daysLeft <= 30 && daysLeft > 0;
                    });
                    
                    if (nearDeadline.length > 0) {
                        insights.push(` ${nearDeadline.length} goal(s) have deadlines within 30 days!`);
                    }
                    
                    const topGoal = [...this.goals].sort((a, b) => (b.current / b.target) - (a.current / a.target))[0];
                    if (topGoal) {
                        const progress = Math.round((topGoal.current / topGoal.target) * 100);
                        insights.push(` Top Goal: ${topGoal.name} (${progress}% complete)`);
                    }
                    
                    const content = document.getElementById('insights-content');
                    content.innerHTML = insights.length > 0 
                        ? insights.map(i => `<p> ${i}</p>`).join('')
                        : '<p> Start adding goals to see personalized insights!</p>';
                }

                saveToStorage() {
                    localStorage.setItem('financeflow_savings', JSON.stringify(this.goals));
                }
            }

            // Investment Manager
            class InvestmentManager {
                constructor() {
                    this.investments = JSON.parse(localStorage.getItem('financeflow_investments')) || [];
                    this.selectedTypes = new Set();
                    this.currentDateRangeFilter = 'all';
                    this.customDateFrom = null;
                    this.customDateTo = null;
                    this.investmentToDelete = null;
                    this.investmentToUpdate = null;
                    this.investmentToSell = null; //  NEW
                    this.init();
                }

                init() {
                    this.renderTypeFilters();
                    this.renderInvestments();
                    this.updateOverview();
                    this.bindEvents();
                }

                bindEvents() {
                    document.getElementById('investment-form').addEventListener('submit', (e) => this.addInvestment(e));
                    document.getElementById('reset-investment-form').addEventListener('click', () => this.resetForm());
                    
                    // Date range filter
                    document.getElementById('investment-date-range-filter').addEventListener('change', (e) => {
                        this.currentDateRangeFilter = e.target.value;
                        const customRange = document.getElementById('custom-investment-date-range');
                        if (e.target.value === 'custom') {
                            customRange.classList.remove('hidden');
                        } else {
                            customRange.classList.add('hidden');
                            this.customDateFrom = null;
                            this.customDateTo = null;
                            this.renderInvestments();
                        }
                    });

                    // Custom date range buttons
                    document.getElementById('apply-investment-date-range').addEventListener('click', () => {
                        this.customDateFrom = document.getElementById('investment-date-from').value;
                        this.customDateTo = document.getElementById('investment-date-to').value;
                        if (this.customDateFrom && this.customDateTo) {
                            this.renderInvestments();
                        } else {
                            alert('Please select both From and To dates');
                        }
                    });

                    document.getElementById('clear-investment-date-range').addEventListener('click', () => {
                        document.getElementById('investment-date-from').value = '';
                        document.getElementById('investment-date-to').value = '';
                        this.customDateFrom = null;
                        this.customDateTo = null;
                        this.renderInvestments();
                    });

                    // Delete All button - Show modal
                    document.getElementById('delete-all-investments-btn').addEventListener('click', () => {
                        if (this.investments.length === 0) {
                            alert('No investments to delete');
                            return;
                        }
                        this.showDeleteAllModal();
                    });

                    // Delete All Modal events
                    document.getElementById('cancel-delete-all-investments').addEventListener('click', () => this.hideDeleteAllModal());
                    document.getElementById('confirm-delete-all-investments').addEventListener('click', () => this.confirmDeleteAll());

                    document.getElementById('search-investments').addEventListener('input', () => this.renderInvestments());
                    document.getElementById('sort-investments').addEventListener('change', () => this.renderInvestments());

                    // Modal events
                    document.getElementById('close-update-modal').addEventListener('click', () => this.hideUpdateModal());
                    document.getElementById('cancel-update').addEventListener('click', () => this.hideUpdateModal());
                    document.getElementById('update-price-form').addEventListener('submit', (e) => this.confirmUpdate(e));
                    
                    document.getElementById('cancel-delete-investment').addEventListener('click', () => this.hideDeleteModal());
                    document.getElementById('confirm-delete-investment').addEventListener('click', () => this.confirmDelete());
                    
                    //  NEW - Mark Sold Modal events
                    document.getElementById('cancel-mark-sold').addEventListener('click', () => this.hideMarkSoldModal());
                    document.getElementById('confirm-mark-sold').addEventListener('click', () => this.confirmMarkSold());
                    document.getElementById('close-insufficient-balance').addEventListener('click', () => this.hideInsufficientBalanceModal());
                }

                renderTypeFilters() {
                    const container = document.getElementById('investment-category-filters');
                    if (!container) return;
                    
                    container.innerHTML = '';

                    const types = [
                        { id: 'stocks', name: 'Stocks' },
                        { id: 'crypto', name: 'Crypto' },
                        { id: 'mutual-funds', name: 'Mutual Funds' },
                        { id: 'real-estate', name: 'Real Estate' },
                        { id: 'bonds', name: 'Bonds' },
                        { id: 'other', name: 'Other' }
                    ];

                    // All button
                    const allBtn = document.createElement('button');
                    allBtn.textContent = 'All Types';
                    allBtn.className = this.selectedTypes.size === 0
                        ? 'px-3 py-1 bg-amber-600 text-white rounded text-sm font-medium'
                        : 'px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm font-medium hover:bg-gray-200';
                    allBtn.addEventListener('click', () => {
                        this.selectedTypes.clear();
                        this.renderTypeFilters();
                        this.renderInvestments();
                    });
                    container.appendChild(allBtn);

                    // Type buttons
                    types.forEach(type => {
                        const btn = document.createElement('button');
                        btn.textContent = type.name;
                        btn.className = this.selectedTypes.has(type.id)
                            ? 'px-3 py-1 bg-amber-600 text-white rounded text-sm font-medium'
                            : 'px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm font-medium hover:bg-gray-200';
                        btn.addEventListener('click', () => {
                            if (this.selectedTypes.has(type.id)) {
                                this.selectedTypes.delete(type.id);
                            } else {
                                this.selectedTypes.add(type.id);
                            }
                            this.renderTypeFilters();
                            this.renderInvestments();
                        });
                        container.appendChild(btn);
                    });
                }

                addInvestment(e) {
                    e.preventDefault();

                    const quantity = parseFloat(document.getElementById('investment-quantity').value);
                    const purchasePrice = parseFloat(document.getElementById('investment-purchase-price').value);
                    const totalCost = quantity * purchasePrice;
                    
                    //  Calculate current balance FIRST
                    const totalIncome = window.incomeManager ? window.incomeManager.incomes.reduce((sum, i) => sum + i.amount, 0) : 0;
                    const totalExpenses = window.expenseManager ? window.expenseManager.expenses.reduce((sum, e) => sum + e.amount, 0) : 0;
                    const currentBalance = totalIncome - totalExpenses;
                    
                    console.log(' Balance check - Available:', currentBalance, 'Required:', totalCost);
                    
                    //  CHECK BALANCE - STOP IMMEDIATELY if insufficient
                    if (currentBalance < totalCost) {
                        console.log(' Insufficient balance! Blocking purchase.');
                        this.showInsufficientBalanceModal(totalCost, currentBalance);
                        return; //  CRITICAL: STOP HERE - Don't create anything
                    }

                    //  Only execute if balance check passed
                    console.log(' Balance sufficient. Creating investment...');
                    
                    const newInvestment = {
                        id: Date.now().toString(),
                        name: document.getElementById('investment-name').value.trim(),
                        type: document.getElementById('investment-type').value,
                        purchaseDate: document.getElementById('investment-purchase-date').value,
                        quantity: quantity,
                        purchasePrice: purchasePrice,
                        currentPrice: purchasePrice,
                        totalInvested: totalCost,
                        currentValue: totalCost,
                        notes: document.getElementById('investment-notes').value.trim(),
                        priceHistory: [{
                            date: new Date().toISOString(),
                            price: purchasePrice
                        }],
                        createdAt: new Date().toISOString()
                    };

                    this.investments.push(newInvestment);
                    this.saveInvestments();
                    
                    // Create expense
                    this.createInvestmentPurchaseExpense(newInvestment);
                    
                    this.renderInvestments();
                    this.updateOverview();
                    
                    if (window.updateInvestmentCharts) {
                        window.updateInvestmentCharts();
                    }
                    
                    this.resetForm();
                    
                    console.log(' Investment created successfully');
                }

                //  Show insufficient balance modal
                showInsufficientBalanceModal(investmentCost, availableBalance) {
                    const shortfall = investmentCost - availableBalance;
                    
                    document.getElementById('insufficient-investment-cost').textContent = `$${investmentCost.toFixed(2)}`;
                    document.getElementById('insufficient-available-balance').textContent = `$${availableBalance.toFixed(2)}`;
                    document.getElementById('insufficient-shortfall').textContent = `$${shortfall.toFixed(2)}`;
                    
                    document.getElementById('insufficient-balance-modal').classList.remove('hidden');
                    lucide.createIcons();
                }

                //  Hide insufficient balance modal
                hideInsufficientBalanceModal() {
                    document.getElementById('insufficient-balance-modal').classList.add('hidden');
                }

                //  Create expense for investment purchase
                createInvestmentPurchaseExpense(investment) {
                    if (!window.expenseManager) {
                        console.error('ExpenseManager not available');
                        return;
                    }
                    
                    // Get categoryManager through expenseManager
                    const categoryMgr = window.expenseManager.categoryManager;
                    
                    if (!categoryMgr) {
                        console.error('CategoryManager not accessible');
                        return;
                    }
                    
                    // Find expense categories
                    const expenseCategories = categoryMgr.categories.filter(c => c.type === 'expense');
                    
                    // Try to find "Investment" or "Other" expense category
                    let expenseCategory = expenseCategories.find(c => 
                        c.id.toLowerCase().includes('invest') || 
                        c.name.toLowerCase().includes('invest')
                    );
                    
                    if (!expenseCategory) {
                        expenseCategory = expenseCategories.find(c => 
                            c.id.toLowerCase().includes('other') || 
                            c.name.toLowerCase() === 'other'
                        );
                    }
                    
                    // Fallback to first expense category
                    if (!expenseCategory && expenseCategories.length > 0) {
                        expenseCategory = expenseCategories[0];
                    }
                    
                    if (!expenseCategory) {
                        console.error('No expense category available');
                        return;
                    }
                    
                    console.log(' Using expense category:', expenseCategory.name, expenseCategory.id);
                    
                    // Create expense entry
                    const purchaseExpense = {
                        id: Date.now().toString() + '-inv',
                        amount: investment.totalInvested,
                        categoryId: expenseCategory.id,
                        description: `${investment.name}`,
                        date: investment.purchaseDate,
                        payment: 'other',
                        notes: `Purchased ${investment.quantity} units at $${investment.purchasePrice.toFixed(2)} per unit. Total: $${investment.totalInvested.toFixed(2)}`,
                        isInvestmentPurchase: true // Flag to identify this expense
                    };
                    
                    console.log(' Creating expense:', purchaseExpense);
                    
                    // Add to expense manager
                    window.expenseManager.expenses.push(purchaseExpense);
                    localStorage.setItem('financeflow_expenses', JSON.stringify(window.expenseManager.expenses));
                    
                    // Update category spent
                    if (typeof categoryMgr.updateCategorySpent === 'function') {
                        categoryMgr.updateCategorySpent(expenseCategory.id, investment.totalInvested);
                    }
                    
                    // Update expense UI
                    if (typeof window.expenseManager.renderExpenses === 'function') {
                        window.expenseManager.renderExpenses();
                    }
                    if (typeof window.expenseManager.updateSummary === 'function') {
                        window.expenseManager.updateSummary();
                    }
                    
                    // Update dashboard
                    if (window.dashboardManager && typeof window.dashboardManager.updateDashboard === 'function') {
                        window.dashboardManager.updateDashboard();
                    }
                    
                    console.log(' Expense created: $' + investment.totalInvested.toFixed(2));
                }

                resetForm() {
                    document.getElementById('investment-form').reset();
                }

                renderInvestments() {
                    const list = document.getElementById('investments-list');
                    const empty = document.getElementById('investments-empty-state');
                    const searchInput = document.getElementById('search-investments');
                    const sortSelect = document.getElementById('sort-investments');
                    
                    if (!list || !empty || !searchInput || !sortSelect) return;
                    
                    const search = searchInput.value.toLowerCase();
                    const sort = sortSelect.value;
                    const now = new Date();

                    let filtered = [...this.investments];

                    // Type filter
                    if (this.selectedTypes.size > 0) {
                        filtered = filtered.filter(inv => this.selectedTypes.has(inv.type));
                    }

                    // Date filter
                    filtered = filtered.filter(inv => {
                        const d = new Date(inv.purchaseDate);

                        // Custom date range
                        if (this.currentDateRangeFilter === 'custom' && this.customDateFrom && this.customDateTo) {
                            const fromDate = new Date(this.customDateFrom);
                            const toDate = new Date(this.customDateTo);
                            toDate.setHours(23, 59, 59, 999);
                            return d >= fromDate && d <= toDate;
                        }

                        // Today
                        if (this.currentDateRangeFilter === 'today') {
                            return d.toDateString() === now.toDateString();
                        }

                        // Week
                        if (this.currentDateRangeFilter === 'week') {
                            const oneWeekAgo = new Date();
                            oneWeekAgo.setDate(now.getDate() - 7);
                            return d >= oneWeekAgo && d <= now;
                        }

                        // Month
                        if (this.currentDateRangeFilter === 'month') {
                            return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                        }

                        // Year
                        if (this.currentDateRangeFilter === 'year') {
                            return d.getFullYear() === now.getFullYear();
                        }

                        return true;
                    });

                    // Search filter
                    if (search) {
                        filtered = filtered.filter(inv => 
                            inv.name.toLowerCase().includes(search) || 
                            inv.type.toLowerCase().includes(search) ||
                            (inv.notes && inv.notes.toLowerCase().includes(search))
                        );
                    }

                    // Sort
                    filtered.sort((a, b) => {
                        if (sort === 'date-desc') return new Date(b.purchaseDate) - new Date(a.purchaseDate);
                        if (sort === 'date-asc') return new Date(a.purchaseDate) - new Date(b.purchaseDate);
                        if (sort === 'amount-desc') return b.currentValue - a.currentValue;
                        if (sort === 'amount-asc') return a.currentValue - b.currentValue;
                        return 0;
                    });

                    if (filtered.length === 0) {
                        list.innerHTML = '';
                        empty.classList.remove('hidden');
                        return;
                    }

                    empty.classList.add('hidden');
                    list.innerHTML = filtered.map(investment => this.createInvestmentCard(investment)).join('');

                    // Bind action buttons
                    filtered.forEach(investment => {
                        const markSoldBtn = document.querySelector(`[data-mark-sold="${investment.id}"]`); //  NEW
                        const updateBtn = document.querySelector(`[data-update="${investment.id}"]`);
                        const deleteBtn = document.querySelector(`[data-delete-investment="${investment.id}"]`);
                        
                        if (markSoldBtn) markSoldBtn.addEventListener('click', () => this.showMarkSoldModal(investment)); //  NEW
                        if (updateBtn) updateBtn.addEventListener('click', () => this.showUpdateModal(investment));
                        if (deleteBtn) deleteBtn.addEventListener('click', () => this.showDeleteModal(investment));
                    });

                    lucide.createIcons();
                }

                createInvestmentCard(investment) {
                    const returns = investment.currentValue - investment.totalInvested;
                    const returnPercent = ((returns / investment.totalInvested) * 100).toFixed(2);
                    const isProfit = returns >= 0;

                    const typeIcons = {
                        'stocks': 'trending-up',
                        'crypto': 'bitcoin',
                        'mutual-funds': 'briefcase',
                        'real-estate': 'home',
                        'bonds': 'coins',
                        'other': 'bar-chart'
                    };

                    const typeColors = {
                        'stocks': '#3b82f6',
                        'crypto': '#f59e0b',
                        'mutual-funds': '#8b5cf6',
                        'real-estate': '#10b981',
                        'bonds': '#06b6d4',
                        'other': '#6b7280'
                    };

                    const icon = typeIcons[investment.type] || 'trending-up';
                    const color = typeColors[investment.type] || '#6b7280';

                    return `
                        <div class="flex items-center justify-between p-4 hover:bg-gray-50 transition">
                            <div class="flex items-center space-x-3 flex-1">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background-color:${color}20;">
                                    <i data-lucide="${icon}" class="w-5 h-5" style="color:${color};"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1">
                                        <p class="font-medium text-gray-900">${investment.name}</p>
                                        <span class="px-2 py-0.5 rounded-full text-xs font-medium ${isProfit ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                            ${isProfit ? '' : ''} ${isProfit ? '+' : ''}${returnPercent}%
                                        </span>
                                    </div>
                                    <p class="text-xs text-gray-500">
                                        ${investment.quantity} units  ${new Date(investment.purchaseDate).toLocaleDateString()}
                                        <span class="font-medium" style="color:${color};">  ${investment.type}</span>
                                    </p>
                                    ${investment.notes ? `<p class="text-xs text-gray-500 mt-1">${investment.notes}</p>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center space-x-3 text-right">
                                <div>
                                    <p class="text-sm text-gray-600">Value</p>
                                    <p class="font-semibold text-gray-900 text-lg">$${investment.currentValue.toFixed(2)}</p>
                                    <p class="text-xs ${isProfit ? 'text-green-600' : 'text-red-600'}">${isProfit ? '+' : ''}$${returns.toFixed(2)}</p>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <button data-mark-sold="${investment.id}" class="px-3 py-1 bg-green-500 text-white rounded-lg text-xs font-medium hover:bg-green-600 transition flex items-center gap-1" title="Mark as Sold">
                                            <i data-lucide="dollar-sign" class="w-3 h-3"></i>
                                            Mark Sold
                                        </button>
                                        <button data-update="${investment.id}" class="px-2 py-1 text-gray-600 hover:text-amber-600 transition" title="Edit investment">
                                            <i data-lucide="edit" class="w-4 h-4"></i>
                                        </button>
                                        <button data-delete-investment="${investment.id}" class="text-gray-400 hover:text-red-600" title="Delete">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                showUpdateModal(investment) {
                    this.investmentToUpdate = investment;
                    document.getElementById('update-investment-id').value = investment.id;
                    document.getElementById('update-investment-name').textContent = investment.name;
                    document.getElementById('update-new-price').value = investment.currentPrice;
                    document.getElementById('update-price-modal').classList.remove('hidden');
                    lucide.createIcons();
                }

                hideUpdateModal() {
                    document.getElementById('update-price-modal').classList.add('hidden');
                    this.investmentToUpdate = null;
                }

                confirmUpdate(e) {
                    e.preventDefault();
                    
                    if (!this.investmentToUpdate) return;

                    const newPrice = parseFloat(document.getElementById('update-new-price').value);
                    
                    this.investmentToUpdate.currentPrice = newPrice;
                    this.investmentToUpdate.currentValue = this.investmentToUpdate.quantity * newPrice;
                    this.investmentToUpdate.priceHistory.push({
                        date: new Date().toISOString(),
                        price: newPrice
                    });

                    this.saveInvestments();
                    this.renderInvestments();
                    this.updateOverview();
                    
                    if (window.updateInvestmentCharts) {
                        window.updateInvestmentCharts();
                    }
                    
                    this.hideUpdateModal();
                }

                showDeleteModal(investment) {
                    this.investmentToDelete = investment;
                    document.getElementById('delete-investment-modal').classList.remove('hidden');
                    lucide.createIcons();
                }

                hideDeleteModal() {
                    document.getElementById('delete-investment-modal').classList.add('hidden');
                    this.investmentToDelete = null;
                }

                confirmDelete() {
                    if (!this.investmentToDelete) return;

                    this.investments = this.investments.filter(inv => inv.id !== this.investmentToDelete.id);
                    this.saveInvestments();
                    this.renderInvestments();
                    this.updateOverview();
                    
                    if (window.updateInvestmentCharts) {
                        window.updateInvestmentCharts();
                    }
                    
                    this.hideDeleteModal();
                }

                //  NEW - Mark Sold Modal Methods
                showMarkSoldModal(investment) {
                    this.investmentToSell = investment;
                    const returns = investment.currentValue - investment.totalInvested;
                    const returnPercent = ((returns / investment.totalInvested) * 100).toFixed(2);
                    const isProfit = returns >= 0;
                    
                    document.getElementById('sold-investment-name').textContent = investment.name;
                    document.getElementById('sold-investment-value').textContent = `$${investment.currentValue.toFixed(2)}`;
                    
                    const returnsEl = document.getElementById('sold-investment-returns');
                    returnsEl.textContent = `${isProfit ? '+' : ''}$${returns.toFixed(2)} (${isProfit ? '+' : ''}${returnPercent}%)`;
                    returnsEl.className = `text-sm font-bold ${isProfit ? 'text-green-600' : 'text-red-600'}`;
                    
                    document.getElementById('mark-sold-modal').classList.remove('hidden');
                    lucide.createIcons();
                }

                hideMarkSoldModal() {
                    document.getElementById('mark-sold-modal').classList.add('hidden');
                    this.investmentToSell = null;
                }

                confirmMarkSold() {
                    if (!this.investmentToSell) return;
                    
                    const investment = this.investmentToSell;
                    const returns = investment.currentValue - investment.totalInvested;
                    
                    //  Directly access incomeManager's categoryManager (it's passed in constructor)
                    const categoryMgr = window.incomeManager ? window.incomeManager.categoryManager : null;
                    
                    if (!categoryMgr) {
                        console.error('CategoryManager not accessible via incomeManager');
                        // Fallback: Just use hardcoded categoryId
                        const saleIncome = {
                            id: Date.now().toString(),
                            amount: investment.currentValue,
                            categoryId: 'salary',  // Use salary as fallback (it exists)
                            description: `${investment.name}`,
                            date: new Date().toISOString().split('T')[0],
                            payment: 'cash',
                            notes: `Sold ${investment.quantity} units at $${investment.currentPrice.toFixed(2)} per unit. Original investment: $${investment.totalInvested.toFixed(2)}. ${returns >= 0 ? 'Profit' : 'Loss'}: $${Math.abs(returns).toFixed(2)}`
                        };
                        
                        window.incomeManager.incomes.push(saleIncome);
                        localStorage.setItem('financeflow_incomes', JSON.stringify(window.incomeManager.incomes));
                        window.incomeManager.renderIncomes();
                        window.incomeManager.updateSummary();
                        
                        this.finalizeSale(investment, returns);
                        return;
                    }
                    
                    // Find income category
                    const incomeCategories = categoryMgr.categories.filter(c => c.type === 'income');
                    
                    let incomeCategory = incomeCategories.find(c => 
                        c.id.toLowerCase().includes('invest') || 
                        c.name.toLowerCase().includes('invest')
                    );
                    
                    if (!incomeCategory) {
                        incomeCategory = incomeCategories.find(c => 
                            c.id.toLowerCase() === 'other' || 
                            c.name.toLowerCase() === 'other'
                        );
                    }
                    
                    if (!incomeCategory && incomeCategories.length > 0) {
                        incomeCategory = incomeCategories[0];
                    }
                    
                    // If still no category, use salary as fallback
                    const categoryId = incomeCategory ? incomeCategory.id : 'salary';
                    
                    console.log(' Using income category:', categoryId);
                    
                    // Create income entry
                    const saleIncome = {
                        id: Date.now().toString(),
                        amount: investment.currentValue,
                        categoryId: categoryId,
                        description: `${investment.name}`,
                        date: new Date().toISOString().split('T')[0],
                        payment: 'cash',
                        notes: `Sold ${investment.quantity} units at $${investment.currentPrice.toFixed(2)} per unit. Original investment: $${investment.totalInvested.toFixed(2)}. ${returns >= 0 ? 'Profit' : 'Loss'}: $${Math.abs(returns).toFixed(2)}`
                    };
                    
                    console.log(' Creating income:', saleIncome);
                    
                    // Add to income manager
                    window.incomeManager.incomes.push(saleIncome);
                    localStorage.setItem('financeflow_incomes', JSON.stringify(window.incomeManager.incomes));
                    
                    // Update category income
                    if (incomeCategory && typeof categoryMgr.updateCategoryIncome === 'function') {
                        categoryMgr.updateCategoryIncome(categoryId, investment.currentValue);
                    }
                    
                    // Update income UI
                    window.incomeManager.renderIncomes();
                    window.incomeManager.updateSummary();
                    
                    console.log(' Income created: $' + investment.currentValue.toFixed(2));
                    
                    this.finalizeSale(investment, returns);
                }

                finalizeSale(investment, returns) {
                    // Remove investment
                    this.investments = this.investments.filter(inv => inv.id !== investment.id);
                    this.saveInvestments();
                    
                    // Hide modal
                    this.hideMarkSoldModal();
                    
                    // Update investment UI
                    this.renderInvestments();
                    this.updateOverview();
                    
                    // Update charts
                    if (window.updateInvestmentCharts) {
                        try { window.updateInvestmentCharts(); } catch(e) {}
                    }
                    
                    // Update dashboard
                    if (window.dashboardManager && typeof window.dashboardManager.updateDashboard === 'function') {
                        window.dashboardManager.updateDashboard();
                    }
                    
                    console.log(' Investment sold successfully:', investment.name);
                }

                updateOverview() {
                    const portfolioValue = this.investments.reduce((sum, inv) => sum + inv.currentValue, 0);
                    const totalInvested = this.investments.reduce((sum, inv) => sum + inv.totalInvested, 0);
                    const totalReturns = portfolioValue - totalInvested;
                    const returnPercent = totalInvested > 0 ? ((totalReturns / totalInvested) * 100).toFixed(2) : 0;
                    const isProfit = totalReturns >= 0;

                    // Banner
                    document.getElementById('banner-portfolio-value').textContent = portfolioValue.toFixed(0);
                    document.getElementById('banner-invested').textContent = totalInvested.toFixed(0);
                    document.getElementById('banner-returns-percent').textContent = `${isProfit ? '+' : ''}${returnPercent}`;

                    // Cards
                    document.getElementById('portfolio-value').textContent = portfolioValue.toFixed(2);
                    document.getElementById('total-invested').textContent = totalInvested.toFixed(2);
                    
                    const returnsAmountEl = document.getElementById('total-returns-amount');
                    returnsAmountEl.textContent = `${isProfit ? '+' : ''}$${totalReturns.toFixed(2)}`;
                    returnsAmountEl.className = `text-3xl font-bold ${isProfit ? 'text-green-600' : 'text-red-600'}`;
                    
                    const returnsPercentEl = document.getElementById('total-returns-percent');
                    returnsPercentEl.textContent = `${isProfit ? '+' : ''}${returnPercent}% ${isProfit ? 'gain' : 'loss'}`;
                    returnsPercentEl.className = `text-sm ${isProfit ? 'text-green-600' : 'text-red-600'}`;

                    // Best performer
                    if (this.investments.length > 0) {
                        const sorted = [...this.investments].sort((a, b) => {
                            const aReturn = ((a.currentValue - a.totalInvested) / a.totalInvested) * 100;
                            const bReturn = ((b.currentValue - b.totalInvested) / b.totalInvested) * 100;
                            return bReturn - aReturn;
                        });
                        
                        const best = sorted[0];
                        const bestReturn = ((best.currentValue - best.totalInvested) / best.totalInvested) * 100;
                        
                        document.getElementById('best-performer-name').textContent = best.name;
                        document.getElementById('best-performer-return').textContent = `${bestReturn >= 0 ? '+' : ''}${bestReturn.toFixed(2)}% return`;
                    } else {
                        document.getElementById('best-performer-name').textContent = '-';
                        document.getElementById('best-performer-return').textContent = 'No investments yet';
                    }
                }

                saveInvestments() {
                    localStorage.setItem('financeflow_investments', JSON.stringify(this.investments));
                }

                showDeleteAllModal() {
                    document.getElementById('delete-all-investments-count').textContent = this.investments.length;
                    document.getElementById('delete-all-investments-modal').classList.remove('hidden');
                    lucide.createIcons();
                }

                hideDeleteAllModal() {
                    document.getElementById('delete-all-investments-modal').classList.add('hidden');
                }

                confirmDeleteAll() {
                    this.investments = [];
                    this.saveInvestments();
                    this.renderInvestments();
                    this.updateOverview();
                    if (window.updateInvestmentCharts) {
                        window.updateInvestmentCharts();
                    }
                    this.hideDeleteAllModal();
                }
            }

            // Bills Manager Class
            class BillsManager {
                constructor(expenseManager, incomeManager, categoryManager) {
                    this.expenseManager = expenseManager;
                    this.incomeManager = incomeManager;
                    this.categoryManager = categoryManager;
                    this.bills = JSON.parse(localStorage.getItem('financeflow:bills')) || [];
                    this.billToDelete = null;
                    this.billToMarkPaid = null;
                    this.init();
                }

                init() {
                    this.renderBills();
                    this.updateOverview();
                    this.bindEvents();
                }

                bindEvents() {
                    // Form submission
                    document.getElementById('bill-form').addEventListener('submit', (e) => this.addBill(e));
                    document.getElementById('reset-bill-form').addEventListener('click', () => this.resetForm());

                    // Mark Paid Modal events
                    document.getElementById('cancel-mark-paid').addEventListener('click', () => this.hideMarkPaidModal());
                    document.getElementById('confirm-mark-paid').addEventListener('click', () => this.confirmMarkPaid());
                    
                    // Delete modal events
                    document.getElementById('cancel-delete-bill').addEventListener('click', () => this.hideDeleteModal());
                    document.getElementById('confirm-delete-bill').addEventListener('click', () => this.confirmDelete());
                }

                addBill(e) {
                    e.preventDefault();

                    const amount = parseFloat(document.getElementById('bill-amount').value);

                    //  Check if balance is sufficient (but DON'T create expense yet)
                    const totalIncome = this.incomeManager ? this.incomeManager.incomes.reduce((sum, i) => sum + i.amount, 0) : 0;
                    const totalExpenses = this.expenseManager ? this.expenseManager.expenses.reduce((sum, e) => sum + e.amount, 0) : 0;
                    
                    // Calculate reserved amount (unpaid bills)
                    const reservedForBills = this.bills
                        .filter(b => !b.isPaid)
                        .reduce((sum, b) => sum + b.amount, 0);
                    
                    const currentBalance = totalIncome - totalExpenses - reservedForBills;

                    console.log('Balance check - Available:', currentBalance, 'Required:', amount);

                    if (currentBalance < amount) {
                        console.log('Insufficient balance! Blocking bill creation.');
                        this.showInsufficientBalanceModal(amount, currentBalance);
                        return;
                    }

                    //  Create bill (NO expense created yet)
                    const newBill = {
                        id: Date.now().toString(),
                        name: document.getElementById('bill-name').value.trim(),
                        category: document.getElementById('bill-category').value,
                        amount: amount,
                        dueDate: document.getElementById('bill-due-date').value,
                        frequency: document.getElementById('bill-frequency').value,
                        notes: document.getElementById('bill-notes').value.trim(),
                        isPaid: false,  // Not paid yet
                        paidDate: null,  // Will be set when marked as paid
                        createdAt: new Date().toISOString()
                    };

                    this.bills.push(newBill);
                    this.saveBills();

                    this.renderBills();
                    this.updateOverview();
                    this.updateDashboard();
                    this.resetForm();
                    
                    console.log(' Bill created (amount reserved, no expense yet)');
                }

                //  Show mark as paid modal
                showMarkPaidModal(bill) {
                    this.billToMarkPaid = bill;

                    document.getElementById('paid-bill-name').textContent = bill.name;
                    document.getElementById('paid-bill-amount').textContent = `$${bill.amount.toFixed(2)}`;
                    document.getElementById('paid-bill-date').textContent = new Date(bill.dueDate).toLocaleDateString();

                    document.getElementById('mark-paid-modal').classList.remove('hidden');
                    lucide.createIcons();
                }

                hideMarkPaidModal() {
                    document.getElementById('mark-paid-modal').classList.add('hidden');
                    this.billToMarkPaid = null;
                }

                //  When marked as paid: CREATE expense and mark bill as paid
                confirmMarkPaid() {
                    if (!this.billToMarkPaid) return;

                    const bill = this.billToMarkPaid;

                    // Mark bill as paid
                    bill.isPaid = true;
                    bill.paidDate = new Date().toISOString();

                    // NOW create the expense
                    this.createBillExpense(bill);

                    this.saveBills();
                    this.renderBills();
                    this.updateOverview();
                    this.hideMarkPaidModal();

                    console.log(' Bill marked as paid and expense created');
                }

                //  Create expense when bill is marked as paid
                createBillExpense(bill) {
                    if (!this.expenseManager || !this.categoryManager) {
                        console.error('ExpenseManager or CategoryManager not available');
                        return;
                    }

                    // Find expense categories
                    const expenseCategories = this.categoryManager.categories.filter(c => c.type === 'expense');

                    // Try to find 'Utilities' or 'Bills' or 'Other' category
                    let expenseCategory = expenseCategories.find(c => 
                        c.id.toLowerCase().includes('utilit') || 
                        c.name.toLowerCase().includes('utilit') ||
                        c.id.toLowerCase().includes('bills') ||
                        c.name.toLowerCase().includes('bills')
                    );

                    if (!expenseCategory) {
                        expenseCategory = expenseCategories.find(c => 
                            c.id.toLowerCase().includes('other') || 
                            c.name.toLowerCase() === 'other'
                        );
                    }

                    if (!expenseCategory && expenseCategories.length > 0) {
                        expenseCategory = expenseCategories[0];
                    }

                    if (!expenseCategory) {
                        console.error('No expense category available');
                        return;
                    }

                    console.log('Using expense category:', expenseCategory.name, expenseCategory.id);

                    // Create expense entry
                    const billExpense = {
                        id: Date.now().toString() + '-bill',
                        amount: bill.amount,
                        categoryId: expenseCategory.id,
                        description: `${bill.name} - Paid`,
                        date: bill.paidDate || new Date().toISOString(),
                        payment: 'other',
                        notes: `Bill payment: ${bill.frequency}. ${bill.notes}`,
                        isBillExpense: true,
                        billId: bill.id
                    };

                    // Add to expense manager
                    this.expenseManager.expenses.push(billExpense);
                    localStorage.setItem('financeflow:expenses', JSON.stringify(this.expenseManager.expenses));

                    // Update category spent
                    if (typeof this.categoryManager.updateCategorySpent === 'function') {
                        this.categoryManager.updateCategorySpent(expenseCategory.id, bill.amount);
                    }

                    // Update expense UI
                    if (typeof this.expenseManager.renderExpenses === 'function') {
                        this.expenseManager.renderExpenses();
                    }
                    if (typeof this.expenseManager.updateSummary === 'function') {
                        this.expenseManager.updateSummary();
                    }

                    this.updateDashboard();

                    console.log(' Expense created:', bill.amount.toFixed(2));
                }

                showInsufficientBalanceModal(billCost, availableBalance) {
                    const shortfall = billCost - availableBalance;

                    document.getElementById('insufficient-bill-cost').textContent = `$${billCost.toFixed(2)}`;
                    document.getElementById('insufficient-bill-balance').textContent = `$${availableBalance.toFixed(2)}`;
                    document.getElementById('insufficient-bill-shortfall').textContent = `$${shortfall.toFixed(2)}`;

                    document.getElementById('insufficient-bill-modal').classList.remove('hidden');
                    lucide.createIcons();
                }

                hideInsufficientBalanceModal() {
                    document.getElementById('insufficient-bill-modal').classList.add('hidden');
                }

                createBillCard(bill) {
                    const dueDate = new Date(bill.dueDate);
                    const today = new Date();
                    const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                    let statusClass = '';
                    let statusText = '';
                    let actionButton = '';

                    if (bill.isPaid) {
                        // Paid bills
                        statusClass = 'bg-green-100 text-green-700';
                        statusText = 'Paid';
                        const paidDate = new Date(bill.paidDate);
                        actionButton = `<span class="text-xs text-gray-500">Paid on ${paidDate.toLocaleDateString()}</span>`;
                    } else {
                        // Unpaid bills
                        if (daysUntilDue < 0) {
                            statusClass = 'bg-red-100 text-red-700';
                            statusText = 'Overdue';
                        } else if (daysUntilDue <= 7) {
                            statusClass = 'bg-orange-100 text-orange-700';
                            statusText = `Due in ${daysUntilDue} days`;
                        } else {
                            statusClass = 'bg-blue-100 text-blue-700';
                            statusText = `Due ${dueDate.toLocaleDateString()}`;
                        }

                        actionButton = `
                            <button data-mark-paid="${bill.id}" class="px-3 py-1 bg-green-500 text-white rounded-lg text-xs font-medium hover:bg-green-600 transition" title="Mark as Paid">
                                <i data-lucide="check-circle" class="w-3 h-3 inline"></i> Mark Paid
                            </button>
                        `;
                    }

                    const categoryIcons = {
                        'utilities': 'zap',
                        'rent': 'home',
                        'insurance': 'shield',
                        'subscriptions': 'tv',
                        'loans': 'credit-card',
                        'internet': 'wifi',
                        'other': 'receipt'
                    };

                    const icon = categoryIcons[bill.category] || 'receipt';

                    return `
                        <div class="flex items-center justify-between p-4 hover:bg-gray-50 transition">
                            <div class="flex items-center space-x-3 flex-1">
                                <div class="w-10 h-10 ${bill.isPaid ? 'bg-green-50' : 'bg-indigo-50'} rounded-lg flex items-center justify-center">
                                    <i data-lucide="${icon}" class="w-5 h-5 ${bill.isPaid ? 'text-green-600' : 'text-indigo-600'}"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-900">${bill.name}</p>
                                    <p class="text-xs text-gray-500">${bill.category}  ${bill.frequency}</p>
                                    ${bill.notes ? `<p class="text-xs text-gray-400 mt-1">${bill.notes}</p>` : ''}
                                </div>
                            </div>

                            <div class="flex items-center space-x-4">
                                <div class="text-right">
                                    <p class="font-semibold text-gray-900">$${bill.amount.toFixed(2)}</p>
                                    <span class="px-2 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                        ${statusText}
                                    </span>
                                </div>

                                <div class="flex items-center space-x-2">
                                    ${actionButton}
                                    <button data-delete-bill="${bill.id}" class="text-gray-400 hover:text-red-600" title="Delete">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                renderBills() {
                    const list = document.getElementById('bills-list');
                    const empty = document.getElementById('bills-empty-state');

                    if (!list || !empty) return;

                    if (this.bills.length === 0) {
                        list.innerHTML = '';
                        empty.classList.remove('hidden');
                        return;
                    }

                    empty.classList.add('hidden');

                    // Sort: Unpaid first, then paid
                    const sortedBills = [...this.bills].sort((a, b) => {
                        if (a.isPaid === b.isPaid) return 0;
                        return a.isPaid ? 1 : -1;
                    });

                    list.innerHTML = sortedBills.map(bill => this.createBillCard(bill)).join('');

                    // Bind action buttons
                    this.bills.forEach(bill => {
                        const markPaidBtn = document.querySelector(`[data-mark-paid="${bill.id}"]`);
                        const deleteBtn = document.querySelector(`[data-delete-bill="${bill.id}"]`);

                        if (markPaidBtn) {
                            markPaidBtn.addEventListener('click', () => this.showMarkPaidModal(bill));
                        }

                        if (deleteBtn) {
                            deleteBtn.addEventListener('click', () => this.showDeleteModal(bill));
                        }
                    });

                    lucide.createIcons();
                }

                showDeleteModal(bill) {
                    this.billToDelete = bill;
                    document.getElementById('delete-bill-modal').classList.remove('hidden');
                    lucide.createIcons();
                }

                hideDeleteModal() {
                    document.getElementById('delete-bill-modal').classList.add('hidden');
                    this.billToDelete = null;
                }

                confirmDelete() {
                    if (!this.billToDelete) return;

                    const bill = this.billToDelete;

                    // Remove bill
                    this.bills = this.bills.filter(b => b.id !== bill.id);
                    this.saveBills();

                    // If bill was paid, remove the associated expense
                    if (bill.isPaid && this.expenseManager) {
                        this.expenseManager.expenses = this.expenseManager.expenses.filter(
                            e => e.billId !== bill.id
                        );
                        localStorage.setItem('financeflow:expenses', JSON.stringify(this.expenseManager.expenses));
                        
                        if (this.expenseManager.renderExpenses) {
                            this.expenseManager.renderExpenses();
                        }
                    }

                    this.renderBills();
                    this.updateOverview();
                    this.updateDashboard();
                    this.hideDeleteModal();
                }

                updateOverview() {
                    const totalBills = this.bills.length;
                    const unpaidBills = this.bills.filter(b => !b.isPaid);
                    const paidBills = this.bills.filter(b => b.isPaid);
                    
                    const totalMonthly = unpaidBills.reduce((sum, b) => sum + b.amount, 0);

                    document.getElementById('total-bills-count').textContent = unpaidBills.length;
                    document.getElementById('total-monthly-bills').textContent = `$${totalMonthly.toFixed(2)}`;

                    // Calculate due this week (unpaid only)
                    const today = new Date();
                    const oneWeekLater = new Date(today.getTime() + (7 * 24 * 60 * 60 * 1000));

                    const dueThisWeek = unpaidBills.filter(b => {
                        const dueDate = new Date(b.dueDate);
                        return dueDate >= today && dueDate <= oneWeekLater;
                    });

                    document.getElementById('due-this-week-count').textContent = dueThisWeek.length;
                    document.getElementById('due-week-amount').textContent = `$${dueThisWeek.reduce((sum, b) => sum + b.amount, 0).toFixed(2)}`;
                }

                //  Calculate reserved amount for dashboard
                getReservedAmount() {
                    return this.bills
                        .filter(b => !b.isPaid)
                        .reduce((sum, b) => sum + b.amount, 0);
                }

                saveBills() {
                    localStorage.setItem('financeflow:bills', JSON.stringify(this.bills));
                }

                resetForm() {
                    document.getElementById('bill-form').reset();
                }

                updateDashboard() {
                    if (window.dashboardManager && typeof window.dashboardManager.updateDashboard === 'function') {
                        window.dashboardManager.updateDashboard();
                    }
                }
            }

            // Helper function to wait for dashboard
            function waitForDashboard() {
                return new Promise((resolve, reject) => {
                    if (window.dashboardManager) {
                        resolve(window.dashboardManager);
                        return;
                    }
                    
                    let attempts = 0;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        if (window.dashboardManager) {
                            clearInterval(checkInterval);
                            resolve(window.dashboardManager);
                        } else if (attempts > 30) { // 3 seconds max wait
                            clearInterval(checkInterval);
                            reject('Dashboard not ready. Please refresh and try again.');
                        }
                    }, 100);
                });
            }

            // ==================== REPORT DOWNLOAD FUNCTIONS ====================

            // PDF Report Download
            document.getElementById('btn-download-pdf')?.addEventListener('click', function() {
                try {
                    // Check if jsPDF loaded
                    if (!window.jspdf) {
                        alert('PDF library not loaded. Please refresh the page.');
                        console.error('jsPDF not found. Make sure script tags are in <head>');
                        return;
                    }
                    
                    const mgr = window.dashboardManager;
                    if (!mgr) {
                        alert('Please wait for dashboard to load...');
                        return;
                    }
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    const now = new Date();
                    const reportDate = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    
                    // Header
                    doc.setFontSize(22);
                    doc.setTextColor(79, 70, 229);
                    doc.text('FinanceFlow', 14, 20);
                    
                    doc.setFontSize(16);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Financial Report', 14, 28);
                    
                    doc.setFontSize(10);
                    doc.setTextColor(107, 114, 128);
                    doc.text(`Generated on ${reportDate}`, 14, 35);
                    
                    // Draw line
                    doc.setDrawColor(229, 231, 235);
                    doc.line(14, 38, 196, 38);
                    
                    // Calculate totals
                    const totalIncome = mgr.incomeManager.incomes.reduce((sum, i) => sum + i.amount, 0);
                    const regularExpenses = mgr.expenseManager.expenses
                        .filter(e => !e.isSavingsSpent)
                        .reduce((sum, e) => sum + e.amount, 0);
                    const savingsSpentTotal = mgr.expenseManager.expenses
                        .filter(e => e.isSavingsSpent)
                        .reduce((sum, e) => sum + e.amount, 0);
                    const totalExpenses = regularExpenses + savingsSpentTotal;
                    const totalSavings = mgr.savingsManager.goals
                        .filter(g => !g.markedSpent)
                        .reduce((sum, g) => sum + (g.current || 0), 0);
                    const balance = totalIncome - regularExpenses - totalSavings;
                    
                    // Summary Section
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Financial Summary', 14, 48);
                    
                    // Summary Table
                    doc.autoTable({
                        startY: 52,
                        head: [['Metric', 'Amount']],
                        body: [
                            ['Total Income', `$${totalIncome.toFixed(2)}`],
                            ['Regular Expenses', `$${regularExpenses.toFixed(2)}`],
                            ['Savings Spent', `$${savingsSpentTotal.toFixed(2)}`],
                            ['Total Expenses', `$${totalExpenses.toFixed(2)}`],
                            ['Total Savings', `$${totalSavings.toFixed(2)}`],
                            ['Available Balance', `$${balance.toFixed(2)}`]
                        ],
                        theme: 'striped',
                        headStyles: { 
                            fillColor: [79, 70, 229],
                            fontSize: 11,
                            fontStyle: 'bold'
                        },
                        bodyStyles: {
                            fontSize: 10
                        },
                        columnStyles: {
                            0: { fontStyle: 'bold', cellWidth: 80 },
                            1: { halign: 'right' }
                        }
                    });
                    
                    // Income Transactions
                    let currentY = doc.lastAutoTable.finalY + 10;
                    doc.setFontSize(14);
                    doc.text('Income Transactions', 14, currentY);
                    
                    const incomeData = mgr.incomeManager.incomes.map(inc => {
                        const cat = mgr.categoryManager.categories.find(c => c.id === inc.categoryId);
                        return [
                            new Date(inc.date).toLocaleDateString(),
                            inc.description,
                            cat ? cat.name : 'Unknown',
                            `$${inc.amount.toFixed(2)}`
                        ];
                    });
                    
                    doc.autoTable({
                        startY: currentY + 4,
                        head: [['Date', 'Description', 'Category', 'Amount']],
                        body: incomeData.length > 0 ? incomeData : [['No income records', '', '', '']],
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [16, 185, 129],
                            fontSize: 10
                        },
                        bodyStyles: {
                            fontSize: 9
                        },
                        columnStyles: {
                            0: { cellWidth: 28 },
                            1: { cellWidth: 70 },
                            2: { cellWidth: 40 },
                            3: { halign: 'right', cellWidth: 30 }
                        }
                    });
                    
                    // Expense Transactions
                    currentY = doc.lastAutoTable.finalY + 10;
                    
                    if (currentY > 250) {
                        doc.addPage();
                        currentY = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.text('Expense Transactions', 14, currentY);
                    
                    const expenseData = mgr.expenseManager.expenses.map(exp => {
                        const cat = mgr.categoryManager.categories.find(c => c.id === exp.categoryId);
                        const type = exp.isSavingsSpent ? 'Savings Spent' : 'Regular';
                        return [
                            new Date(exp.date).toLocaleDateString(),
                            exp.description,
                            cat ? cat.name : 'Unknown',
                            `$${exp.amount.toFixed(2)}`,
                            type
                        ];
                    });
                    
                    doc.autoTable({
                        startY: currentY + 4,
                        head: [['Date', 'Description', 'Category', 'Amount', 'Type']],
                        body: expenseData.length > 0 ? expenseData : [['No expense records', '', '', '', '']],
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [239, 68, 68],
                            fontSize: 10
                        },
                        bodyStyles: {
                            fontSize: 9
                        },
                        columnStyles: {
                            0: { cellWidth: 25 },
                            1: { cellWidth: 60 },
                            2: { cellWidth: 35 },
                            3: { halign: 'right', cellWidth: 25 },
                            4: { cellWidth: 30 }
                        },
                        didParseCell: function(data) {
                            if (data.section === 'body' && data.row.index < mgr.expenseManager.expenses.length) {
                                const rowData = mgr.expenseManager.expenses[data.row.index];
                                if (rowData && rowData.isSavingsSpent) {
                                    data.cell.styles.fillColor = [254, 243, 199];
                                }
                            }
                        }
                    });
                    
                    // Savings Goals
                    currentY = doc.lastAutoTable.finalY + 10;
                    
                    if (currentY > 250) {
                        doc.addPage();
                        currentY = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.text('Savings Goals', 14, currentY);
                    
                    const savingsData = mgr.savingsManager.goals
                        .filter(g => !g.markedSpent)
                        .map(goal => {
                            const progress = ((goal.current / goal.target) * 100).toFixed(1);
                            const status = goal.current >= goal.target ? 'Completed' : 'Active';
                            return [
                                goal.name,
                                `$${goal.target.toFixed(2)}`,
                                `$${goal.current.toFixed(2)}`,
                                `${progress}%`,
                                status
                            ];
                        });
                    
                    doc.autoTable({
                        startY: currentY + 4,
                        head: [['Goal', 'Target', 'Current', 'Progress', 'Status']],
                        body: savingsData.length > 0 ? savingsData : [['No savings goals', '', '', '', '']],
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [139, 92, 246],
                            fontSize: 10
                        },
                        bodyStyles: {
                            fontSize: 9
                        }
                    });
                    
                    // Footer
                    const pageCount = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setTextColor(156, 163, 175);
                        doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                        doc.text('Generated by FinanceFlow', 14, 290);
                    }
                    
                    // Save
                    const fileName = `FinanceFlow_Report_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.pdf`;
                    doc.save(fileName);
                    
                    console.log(' PDF Report downloaded:', fileName);
                    
                } catch (error) {
                    console.error('PDF Error:', error);
                    alert('Error generating PDF: ' + error.message);
                }
            });

            // Excel Report Download  
            document.getElementById('btn-download-excel')?.addEventListener('click', function() {
                try {
                    const mgr = window.dashboardManager;
                    if (!mgr) {
                        alert('Please wait for dashboard to load...');
                        return;
                    }
                    
                    const now = new Date();
                    const fileName = `FinanceFlow_Report_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.xls`;
                    
                    const totalIncome = mgr.incomeManager.incomes.reduce((sum, i) => sum + i.amount, 0);
                    const regularExpenses = mgr.expenseManager.expenses.filter(e => !e.isSavingsSpent).reduce((sum, e) => sum + e.amount, 0);
                    const savingsSpentTotal = mgr.expenseManager.expenses.filter(e => e.isSavingsSpent).reduce((sum, e) => sum + e.amount, 0);
                    const totalExpenses = regularExpenses + savingsSpentTotal;
                    const totalSavings = mgr.savingsManager.goals.filter(g => !g.markedSpent).reduce((sum, g) => sum + (g.current || 0), 0);
                    const balance = totalIncome - regularExpenses - totalSavings;
                    
                    let html = `
                        <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel">
                        <head><meta charset="UTF-8"><style>table{border-collapse:collapse;}th,td{border:1px solid #000;padding:8px;}</style></head>
                        <body>
                        <h2>FinanceFlow Financial Report</h2>
                        <p><b>Generated:</b> ${now.toLocaleDateString()}</p>
                        
                        <h3>Summary</h3>
                        <table>
                            <tr><td><b>Total Income</b></td><td>$${totalIncome.toFixed(2)}</td></tr>
                            <tr><td><b>Regular Expenses</b></td><td>$${regularExpenses.toFixed(2)}</td></tr>
                            <tr style="background-color:#fef3c7;"><td><b>Savings Spent</b></td><td>$${savingsSpentTotal.toFixed(2)}</td></tr>
                            <tr><td><b>Total Expenses</b></td><td>$${totalExpenses.toFixed(2)}</td></tr>
                            <tr><td><b>Total Savings</b></td><td>$${totalSavings.toFixed(2)}</td></tr>
                            <tr><td><b>Available Balance</b></td><td>$${balance.toFixed(2)}</td></tr>
                        </table><br>
                        
                        <h3>Income Transactions</h3>
                        <table><thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th></tr></thead><tbody>
                    `;
                    
                    mgr.incomeManager.incomes.forEach(inc => {
                        const cat = mgr.categoryManager.categories.find(c => c.id === inc.categoryId);
                        html += `<tr>
                            <td>${new Date(inc.date).toLocaleDateString()}</td>
                            <td>${inc.description}</td>
                            <td>${cat ? cat.name : 'Unknown'}</td>
                            <td>$${inc.amount.toFixed(2)}</td>
                        </tr>`;
                    });
                    
                    html += `</tbody></table><br><h3>Expense Transactions</h3><table><thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th>Type</th></tr></thead><tbody>`;
                    
                    mgr.expenseManager.expenses.forEach(exp => {
                        const cat = mgr.categoryManager.categories.find(c => c.id === exp.categoryId);
                        const type = exp.isSavingsSpent ? 'Savings Spent' : 'Regular';
                        const rowStyle = exp.isSavingsSpent ? 'background-color:#fef3c7;' : '';
                        html += `<tr style="${rowStyle}">
                            <td>${new Date(exp.date).toLocaleDateString()}</td>
                            <td>${exp.description}</td>
                            <td>${cat ? cat.name : 'Unknown'}</td>
                            <td>$${exp.amount.toFixed(2)}</td>
                            <td>${type}</td>
                        </tr>`;
                    });
                    
                    html += `</tbody></table><br><h3>Savings Goals</h3><table><thead><tr><th>Goal</th><th>Target</th><th>Current</th><th>Progress</th><th>Status</th></tr></thead><tbody>`;
                    
                    mgr.savingsManager.goals.filter(g => !g.markedSpent).forEach(goal => {
                        const progress = ((goal.current / goal.target) * 100).toFixed(1);
                        const status = goal.current >= goal.target ? 'Completed' : 'Active';
                        html += `<tr>
                            <td>${goal.name}</td>
                            <td>$${goal.target.toFixed(2)}</td>
                            <td>$${goal.current.toFixed(2)}</td>
                            <td>${progress}%</td>
                            <td>${status}</td>
                        </tr>`;
                    });
                    
                    html += `</tbody></table></body></html>`;
                    
                    const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(' Excel Report downloaded:', fileName);
                    
                } catch (error) {
                    console.error('Excel Error:', error);
                    alert('Error generating Excel: ' + error.message);
                }
            });

            // CSV Report Download
            document.getElementById('btn-download-csv')?.addEventListener('click', function() {
                try {
                    const mgr = window.dashboardManager;
                    if (!mgr) {
                        alert('Please wait for dashboard to load...');
                        return;
                    }
                    
                    const now = new Date();
                    const fileName = `FinanceFlow_Report_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.csv`;
                    
                    // Calculate totals
                    const totalIncome = mgr.incomeManager.incomes.reduce((sum, i) => sum + i.amount, 0);
                    const regularExpenses = mgr.expenseManager.expenses.filter(e => !e.isSavingsSpent).reduce((sum, e) => sum + e.amount, 0);
                    const savingsSpentTotal = mgr.expenseManager.expenses.filter(e => e.isSavingsSpent).reduce((sum, e) => sum + e.amount, 0);
                    const totalExpenses = regularExpenses + savingsSpentTotal;
                    const totalSavings = mgr.savingsManager.goals.filter(g => !g.markedSpent).reduce((sum, g) => sum + (g.current || 0), 0);
                    const balance = totalIncome - regularExpenses - totalSavings;
                    
                    let csv = 'FinanceFlow Financial Report\n';
                    csv += `Generated on,${now.toLocaleDateString()}\n\n`;
                    
                    csv += 'FINANCIAL SUMMARY\n';
                    csv += `Total Income,$${totalIncome.toFixed(2)}\n`;
                    csv += `Regular Expenses,$${regularExpenses.toFixed(2)}\n`;
                    csv += `Savings Spent,$${savingsSpentTotal.toFixed(2)}\n`;
                    csv += `Total Expenses,$${totalExpenses.toFixed(2)}\n`;
                    csv += `Total Savings,$${totalSavings.toFixed(2)}\n`;
                    csv += `Available Balance,$${balance.toFixed(2)}\n\n`;
                    
                    csv += 'INCOME TRANSACTIONS\n';
                    csv += 'Date,Description,Category,Amount\n';
                    mgr.incomeManager.incomes.forEach(inc => {
                        const cat = mgr.categoryManager.categories.find(c => c.id === inc.categoryId);
                        csv += `${new Date(inc.date).toLocaleDateString()},"${inc.description}",${cat ? cat.name : 'Unknown'},$${inc.amount.toFixed(2)}\n`;
                    });
                    
                    csv += '\nEXPENSE TRANSACTIONS\n';
                    csv += 'Date,Description,Category,Amount,Type\n';
                    mgr.expenseManager.expenses.forEach(exp => {
                        const cat = mgr.categoryManager.categories.find(c => c.id === exp.categoryId);
                        const type = exp.isSavingsSpent ? 'Savings Spent' : 'Regular';
                        csv += `${new Date(exp.date).toLocaleDateString()},"${exp.description}",${cat ? cat.name : 'Unknown'},$${exp.amount.toFixed(2)},${type}\n`;
                    });
                    
                    csv += '\nSAVINGS GOALS\n';
                    csv += 'Goal Name,Target,Current,Progress,Status\n';
                    mgr.savingsManager.goals.filter(g => !g.markedSpent).forEach(goal => {
                        const progress = ((goal.current / goal.target) * 100).toFixed(1);
                        const status = goal.current >= goal.target ? 'Completed' : 'Active';
                        csv += `"${goal.name}",$${goal.target.toFixed(2)},$${goal.current.toFixed(2)},${progress}%,${status}\n`;
                    });
                    
                    // Download
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(' CSV Report downloaded:', fileName);
                    
                } catch (error) {
                    console.error('CSV Error:', error);
                    alert('Error generating CSV: ' + error.message);
                }
            });

            console.log(' Report download buttons initialized');

            console.log(' Report download buttons initialized');

            // ============================================
            // INITIALIZE ALL MANAGERS
            // ============================================
            const categoryManager = new CategoryManager();
            const expenseManager = new ExpenseManager(categoryManager);
            window.expenseManager = expenseManager;
            const incomeManager = new IncomeManager(categoryManager);
            window.incomeManager = incomeManager;
            const budgetManager = new BudgetManager(categoryManager, expenseManager);

            // Initialize Savings Manager
            window.savingsManager = new SavingsManager(expenseManager, incomeManager, categoryManager);
            console.log("Savings Manager initialized");

            // Initialize Investment Manager
            window.investmentManager = new InvestmentManager();
            console.log("Investment Manager initialized");

            // Initialize Bills Manager
            window.billsManager = new BillsManager(expenseManager, incomeManager, categoryManager);
            console.log("Bills Manager initialized");

            // Initialize Dashboard Manager - THIS MAKES DASHBOARD LIVE!
            window.dashboardManager = null;
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    window.dashboardManager = new DashboardManager(
                        expenseManager,
                        incomeManager,
                        budgetManager,
                        window.savingsManager,
                        window.investmentManager,
                        window.billManager,
                        categoryManager
                    );
                    console.log("Dashboard Manager initialized - Dashboard is now LIVE!");
                });
            });

            // Auto-refresh dashboard when data changes
            const originalExpenseRender = ExpenseManager.prototype.renderExpenses;
            const originalIncomeRender = IncomeManager.prototype.renderIncomes;

            ExpenseManager.prototype.renderExpenses = function() {
                originalExpenseRender.call(this);
                if (window.dashboardManager) {
                    requestAnimationFrame(() => window.dashboardManager.updateDashboard());
                }
            };

            IncomeManager.prototype.renderIncomes = function() {
                originalIncomeRender.call(this);
                if (window.dashboardManager) {
                    requestAnimationFrame(() => window.dashboardManager.updateDashboard());
                }
            };

            ExpenseManager.prototype.renderExpenses = function() {
                originalExpenseRender.call(this);
                if (window.dashboardManager) {
                    window.dashboardManager.updateDashboard();
                }
            };

            IncomeManager.prototype.renderIncomes = function() {
                originalIncomeRender.call(this);
                if (window.dashboardManager) {
                    window.dashboardManager.updateDashboard();
                }
            };

            // ==================== SIMPLE CALENDAR ====================

            let currentDate = new Date();
            let selectedDate = new Date();

            // DOM elements
            const calendarToggle = document.getElementById('calendar-toggle');
            const calendarDropdown = document.getElementById('calendar-dropdown');
            const currentDateSpan = document.getElementById('current-date');
            const calendarMonthYear = document.getElementById('calendar-month-year');
            const calendarGrid = document.getElementById('calendar-grid');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const prevYearBtn = document.getElementById('prev-year');
            const nextYearBtn = document.getElementById('next-year');

            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];

            // ==================== REAL-TIME CLOCK ====================
            function updateLiveClock() {
                const now = new Date();
                const timeElement = document.getElementById('live-time');
                const dateElement = document.getElementById('live-date');
                
                if (timeElement) {
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    const seconds = now.getSeconds().toString().padStart(2, '0');
                    timeElement.textContent = `${hours}:${minutes}:${seconds}`;
                }
                
                if (dateElement) {
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    dateElement.textContent = now.toLocaleDateString('en-US', options);
                }
            }

            setInterval(updateLiveClock, 1000);
            updateLiveClock();

            // ==================== UPDATE HEADER DATE ====================
            function updateCurrentDateDisplay() {
                const options = { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                };
                currentDateSpan.textContent = selectedDate.toLocaleDateString('en-US', options);
            }

            // ==================== GENERATE CALENDAR ====================
            function generateCalendar(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                
                calendarMonthYear.textContent = `${monthNames[month]} ${year}`;
                calendarGrid.innerHTML = '';
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();
                
                // Empty cells
                for (let i = 0; i < startingDayOfWeek; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'h-10';
                    calendarGrid.appendChild(emptyCell);
                }
                
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('button');
                    const cellDate = new Date(year, month, day);
                    
                    dayCell.className = 'calendar-day h-10 w-10 text-sm rounded-lg flex items-center justify-center relative font-medium';
                    dayCell.textContent = day;
                
                    // Today styling
                    if (cellDate.toDateString() === today.toDateString()) {
                        dayCell.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700', 'font-bold');
                    } else {
                        dayCell.classList.add('hover:bg-indigo-50', 'text-gray-700');
                    }
                
                    // Selected date styling
                    if (cellDate.toDateString() === selectedDate.toDateString()) {
                        dayCell.classList.add('selected', 'ring-2', 'ring-indigo-500');
                    }
                
                    // Click handler - just select date
                    dayCell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectedDate = new Date(cellDate);
                        updateCurrentDateDisplay();
                        generateCalendar(currentDate);
                        calendarDropdown.classList.add('hidden');
                    });
                
                    calendarGrid.appendChild(dayCell);
                }
                
                if (window.lucide) lucide.createIcons();
            }

            // ==================== CALENDAR NAVIGATION ====================
            calendarToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                calendarDropdown.classList.toggle('hidden');
                if (!calendarDropdown.classList.contains('hidden')) {
                    generateCalendar(currentDate);
                }
            });

            document.addEventListener('click', (e) => {
                if (!calendarToggle.contains(e.target) && !calendarDropdown.contains(e.target)) {
                    calendarDropdown.classList.add('hidden');
                }
            });

            calendarDropdown?.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            prevMonthBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                currentDate.setMonth(currentDate.getMonth() - 1);
                generateCalendar(currentDate);
            });

            nextMonthBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                currentDate.setMonth(currentDate.getMonth() + 1);
                generateCalendar(currentDate);
            });

            prevYearBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                currentDate.setFullYear(currentDate.getFullYear() - 1);
                generateCalendar(currentDate);
            });

            nextYearBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                currentDate.setFullYear(currentDate.getFullYear() + 1);
                generateCalendar(currentDate);
            });

            updateCurrentDateDisplay();

            console.log(' Simple calendar initialized');

            // Cash Flow Chart
            window.cashFlowChart = null;
            window.categoryChart = null;
            window.savingsChart = null;

            // Cash Flow Chart
            const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
            window.cashFlowChart = new Chart(cashFlowCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Income',
                        data: [5000, 5200, 4800, 5500, 6000, 5800, 6200, 6100, 5900, 6000, 6300, 6500],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Expenses',
                        data: [4200, 4500, 4300, 4700, 4900, 4600, 4800, 5000, 4700, 4300, 4400, 4600],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            window.categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Housing', 'Food', 'Transport', 'Entertainment', 'Healthcare', 'Shopping'],
                    datasets: [{
                        data: [1200, 650, 450, 320, 280, 240],
                        backgroundColor: ['#4f46e5', '#f97316', '#3b82f6', '#8b5cf6', '#ef4444', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    },
                    cutout: '70%'
                }
            });

            // Savings Chart
            const savingsCtx = document.getElementById('savingsChart').getContext('2d');

            // Create gradient
            const savingsGradient = savingsCtx.createLinearGradient(0, 0, 0, 300);
            savingsGradient.addColorStop(0, 'rgba(99, 102, 241, 0.8)');
            savingsGradient.addColorStop(0.5, 'rgba(139, 92, 246, 0.6)');
            savingsGradient.addColorStop(1, 'rgba(168, 85, 247, 0.4)');

            window.savingsChart = new Chart(savingsCtx, {  //  window.savingsChart so it's accessible
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Monthly Savings',
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],  //  Start with zeros
                        backgroundColor: savingsGradient,
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                        hoverBackgroundColor: 'rgba(99, 102, 241, 0.9)',
                        hoverBorderColor: 'rgba(99, 102, 241, 1)',
                        hoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return 'Saved: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            }
                        },
                        x: {
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 11,
                                    weight: '500'
                                }
                            },
                            grid: {
                                display: false,
                                drawBorder: false
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        });

        // After all classes
        // ========================================
        // SAVINGS CHARTS - COMPLETE FIXED VERSION
        // ========================================

        let savingsDonutChart = null;
        let savingsGrowthChart = null;

        function initializeSavingsCharts() {
            const savingsPage = document.getElementById('savings');
            if (!savingsPage || savingsPage.classList.contains('hidden')) {
                console.log('Savings page not visible, charts will initialize when page is shown');
                return;
            }

            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded!');
                return;
            }

            const donutCanvas = document.getElementById('savings-donut-chart');
            const growthCanvas = document.getElementById('savings-growth-chart');

            console.log('Initializing charts - Canvas elements found:', !!donutCanvas, !!growthCanvas);

            //  Chart 1: Beautiful Multi-Gradient Donut Chart
            if (donutCanvas && !savingsDonutChart) {
                try {
                    const ctx = donutCanvas.getContext('2d');
                    
                    // Create gradients for segments
                    const createGradient = (color1, color2) => {
                        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                        gradient.addColorStop(0, color1);
                        gradient.addColorStop(1, color2);
                        return gradient;
                    };
                    
                    savingsDonutChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['No Goals Yet'],
                            datasets: [{
                                data: [1],
                                backgroundColor: [
                                    createGradient('rgba(99, 102, 241, 0.8)', 'rgba(139, 92, 246, 0.6)'),
                                    createGradient('rgba(236, 72, 153, 0.8)', 'rgba(251, 113, 133, 0.6)'),
                                    createGradient('rgba(14, 165, 233, 0.8)', 'rgba(34, 211, 238, 0.6)'),
                                    createGradient('rgba(16, 185, 129, 0.8)', 'rgba(52, 211, 153, 0.6)'),
                                    createGradient('rgba(251, 146, 60, 0.8)', 'rgba(253, 186, 116, 0.6)')
                                ],
                                borderWidth: 3,
                                borderColor: '#fff',
                                hoverOffset: 15,
                                hoverBorderWidth: 4,
                                spacing: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 1000,
                                easing: 'easeInOutQuart'
                            },
                            plugins: {
                                legend: { 
                                    display: false 
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    padding: 12,
                                    cornerRadius: 8,
                                    displayColors: false,
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `${label}: $${value.toLocaleString()} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            cutout: '70%'
                        }
                    });
                    
                    console.log(' Beautiful donut chart created!');
                } catch(e) {
                    console.error('Error creating donut chart:', e);
                }
            }

            //  Chart 2: Stunning Area Chart with Gradient Fill
            if (growthCanvas && !savingsGrowthChart) {
                try {
                    const ctx = growthCanvas.getContext('2d');
                    
                    // Create beautiful multi-stop gradient
                    const gradient = ctx.createLinearGradient(0, 0, 0, 350);
                    gradient.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
                    gradient.addColorStop(0.3, 'rgba(139, 92, 246, 0.25)');
                    gradient.addColorStop(0.7, 'rgba(168, 85, 247, 0.1)');
                    gradient.addColorStop(1, 'rgba(192, 132, 252, 0.02)');
                    
                    savingsGrowthChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],  //  12 months
                            datasets: [{
                                label: 'Total Savings',
                                data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],  //  12 data points
                                borderColor: '#6366f1',
                                backgroundColor: gradient,
                                fill: true,
                                tension: 0.4,
                                borderWidth: 4,
                                pointRadius: 0,
                                pointHoverRadius: 10,
                                pointHoverBackgroundColor: '#6366f1',
                                pointHoverBorderColor: '#fff',
                                pointHoverBorderWidth: 4,
                                pointBackgroundColor: '#6366f1',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            aspectRatio: 2.5,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: { 
                                    display: false 
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    padding: 16,
                                    cornerRadius: 12,
                                    titleFont: {
                                        size: 16,
                                        weight: 'bold',
                                        family: "'Inter', sans-serif"
                                    },
                                    bodyFont: {
                                        size: 14,
                                        family: "'Inter', sans-serif"
                                    },
                                    displayColors: false,
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].label;
                                        },
                                        label: function(context) {
                                            return 'Total Saved: $' + context.parsed.y.toLocaleString();
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.06)',
                                        drawBorder: false,
                                        lineWidth: 1
                                    },
                                    border: {
                                        display: false
                                    },
                                    ticks: {
                                        padding: 12,
                                        color: '#6b7280',
                                        font: {
                                            size: 12,
                                            weight: '600',
                                            family: "'Inter', sans-serif"
                                        },
                                        callback: function(value) {
                                            return '$' + (value / 1000).toFixed(0) + 'k';
                                        }
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false,
                                        drawBorder: false
                                    },
                                    border: {
                                        display: false
                                    },
                                    ticks: {
                                        padding: 12,
                                        color: '#6b7280',
                                        font: {
                                            size: 12,
                                            weight: '600',
                                            family: "'Inter', sans-serif"
                                        }
                                    }
                                }
                            },
                            animation: {
                                duration: 1500,
                                easing: 'easeInOutCubic'
                            }
                        }
                    });
                    console.log(' Beautiful growth chart created!');
                } catch(e) {
                    console.error('Error creating growth chart:', e);
                }
            }

            setTimeout(() => {
                updateSavingsCharts();
            }, 100);
        }
       
        function updateSavingsCharts() {
            // MORE RELIABLE CHECK - Use window.savingsManager
            if (!window.savingsManager || !window.savingsManager.goals) {
                console.log('Savings manager not ready yet, skipping chart update');
                return;
            }

            //  Filter out spent goals
            const goals = window.savingsManager.goals.filter(g => !g.markedSpent);
            console.log('Updating charts with active goals:', goals.length, goals);
            
            const colors = ['#6366f1', '#8b5cf6', '#06b6d4', '#f59e0b', '#ef4444', '#10b981', '#ec4899', '#14b8a6'];

            // Update Donut Chart
            if (savingsDonutChart) {
                if (goals.length === 0) {
                    savingsDonutChart.data.labels = ['No Goals Yet'];
                    savingsDonutChart.data.datasets[0].data = [1];
                    savingsDonutChart.data.datasets[0].backgroundColor = ['#e5e7eb'];
                } else {
                    savingsDonutChart.data.labels = goals.map(g => g.name);
                    savingsDonutChart.data.datasets[0].data = goals.map(g => g.current || 0);
                    savingsDonutChart.data.datasets[0].backgroundColor = colors.slice(0, goals.length);
                }
                savingsDonutChart.update();
                console.log(' Donut chart updated');

                // Update Legend
                const legend = document.getElementById('chart-legend');
                if (legend) {
                    if (goals.length === 0) {
                        legend.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Add goals to see distribution</p>';
                    } else {
                        legend.innerHTML = goals.map((g, i) => `
                            <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 transition">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full mr-3 flex-shrink-0" style="background-color: ${colors[i % colors.length]}"></div>
                                    <span class="text-gray-700 text-sm font-medium">${g.name}</span>
                                </div>
                                <span class="font-bold text-gray-900 text-sm">$${(g.current || 0).toFixed(0)}</span>
                            </div>
                        `).join('');
                    }
                }
            }

            // Update Growth Chart
            if (savingsGrowthChart) {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const currentYear = new Date().getFullYear();
                const monthlyData = [];
                
                //  Loop through all 12 months of current year (Jan=0 to Dec=11)
                for (let month = 0; month < 12; month++) {
                    const monthSavings = goals.reduce((sum, g) => {
                        if (!g.deposits) return sum;
                        
                        const monthDeposits = g.deposits.filter(d => {
                            const dDate = new Date(d.date);
                            return dDate.getMonth() === month && 
                                dDate.getFullYear() === currentYear;
                        }).reduce((s, d) => s + d.amount, 0);
                        
                        return sum + monthDeposits;
                    }, 0);
                    
                    monthlyData.push(monthSavings);
                }
                
                savingsGrowthChart.data.labels = months;
                savingsGrowthChart.data.datasets[0].data = monthlyData;
                savingsGrowthChart.update();
                
                console.log(' Growth chart updated: Jan-Dec', currentYear);
            }           
            
            console.log(' All charts updated successfully!');

            // Update growth total display
            const growthTotal = document.getElementById('growth-total');
            if (growthTotal && savingsGrowthChart) {
                const total = savingsGrowthChart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                growthTotal.textContent = `Total: $${total.toFixed(2)}`;
            }
        }

        // Make function globally available
        window.updateSavingsCharts = updateSavingsCharts;

        // Listen for clicks on Savings navigation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up savings navigation listeners');
            
            // Find all navigation links
            const allLinks = document.querySelectorAll('a, button, [data-page]');
            
            allLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    const dataPage = this.getAttribute('data-page');
                    const page = dataPage || (href ? href.replace('#', '') : '');
                    
                    if (page === 'savings') {
                        console.log('Savings page clicked, initializing charts in 300ms...');
                        setTimeout(() => {
                            initializeSavingsCharts();
                        }, 300);
                    }
                });
            });
        });

        // ========================================
        // INVESTMENT CHARTS (UPDATED TO MATCH DASHBOARD STYLE)
        // ========================================

        let investmentAllocationChart = null;
        let investmentPerformanceChart = null;

        function initializeInvestmentCharts() {
            const investmentPage = document.getElementById('investments');

            if (!investmentPage) {
                console.error('Investment page not found!');
                return;
            }

            investmentPage.classList.remove('hidden');

            if (investmentPage.classList.contains('hidden')) {
                console.log('Investment page STILL hidden, waiting...');
                setTimeout(() => initializeInvestmentCharts(), 200);
                return;
            }

            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded!');
                return;
            }

            const allocationCanvas = document.getElementById('investment-allocation-chart');
            const performanceCanvas = document.getElementById('investment-performance-chart');

            console.log('Initializing investment charts - Canvas elements found:', !!allocationCanvas, !!performanceCanvas);

            //  COMPLETELY REWRITTEN Allocation Chart - Fixed all hover issues
            if (allocationCanvas && !investmentAllocationChart) {
                try {
                    investmentAllocationChart = new Chart(allocationCanvas.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['No Investments'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['#e5e7eb'],
                                borderWidth: 0,
                                spacing: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            elements: {
                                arc: {
                                    borderWidth: 0,
                                    hoverBorderWidth: 0,
                                    borderColor: 'transparent',
                                    hoverBorderColor: 'transparent'
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    enabled: true,
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    titleFont: { size: 14, weight: 'bold' },
                                    bodyFont: { size: 13 },
                                    padding: 12,
                                    cornerRadius: 8,
                                    displayColors: true,
                                    boxWidth: 12,
                                    boxHeight: 12,
                                    usePointStyle: true,
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].label;
                                        },
                                        label: function(context) {
                                            const value = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' (' + percentage + '%)';
                                        }
                                    }
                                }
                            },
                            cutout: '70%',
                            animation: {
                                animateRotate: true,
                                animateScale: false
                            },
                            onHover: (event, activeElements) => {
                                event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                            }
                        }
                    });
                    console.log(' Allocation chart created');
                } catch(e) {
                    console.error('Error creating allocation chart:', e);
                }
            }

            //  Create Performance Chart (Line) - Orange/Amber Theme
            if (performanceCanvas && !investmentPerformanceChart) {
                try {
                    investmentPerformanceChart = new Chart(performanceCanvas.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                            datasets: [{
                                label: 'Total Invested',
                                data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.15)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 0,
                                pointHoverRadius: 8,
                                pointHoverBackgroundColor: '#f59e0b',
                                pointHoverBorderColor: '#fff',
                                pointHoverBorderWidth: 3
                            }, {
                                label: 'Current Value',
                                data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.15)',
                                tension: 0.4,
                                fill: true,
                                borderWidth: 3,
                                pointRadius: 0,
                                pointHoverRadius: 8,
                                pointHoverBackgroundColor: '#8b5cf6',
                                pointHoverBorderColor: '#fff',
                                pointHoverBorderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    align: 'center',
                                    labels: {
                                        usePointStyle: true,
                                        pointStyle: 'circle',
                                        padding: 20,
                                        font: {
                                            size: 13,
                                            weight: '600'
                                        },
                                        color: '#374151'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    padding: 16,
                                    cornerRadius: 12,
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 13
                                    },
                                    bodySpacing: 8,
                                    displayColors: true,
                                    boxWidth: 12,
                                    boxHeight: 12,
                                    boxPadding: 6,
                                    usePointStyle: true,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                        },
                                        footer: function(tooltipItems) {
                                            const invested = tooltipItems[0].parsed.y;
                                            const current = tooltipItems[1] ? tooltipItems[1].parsed.y : 0;
                                            const returns = current - invested;
                                            const returnsPercent = invested > 0 ? ((returns / invested) * 100).toFixed(2) : 0;
                                            return '\nReturns: $' + returns.toLocaleString('en-US', {minimumFractionDigits: 2}) + ' (' + returnsPercent + '%)';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        drawBorder: false,
                                        color: '#f3f4f6',
                                        lineWidth: 1
                                    },
                                    ticks: {
                                        color: '#6b7280',
                                        font: {
                                            size: 11,
                                            weight: '500'
                                        },
                                        padding: 10,
                                        callback: function(value) {
                                            if (value >= 1000) {
                                                return '$' + (value / 1000).toFixed(0) + 'k';
                                            }
                                            return '$' + value;
                                        }
                                    },
                                    border: {
                                        display: false
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false,
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: '#6b7280',
                                        font: {
                                            size: 11,
                                            weight: '600'
                                        },
                                        padding: 8
                                    },
                                    border: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                    console.log(' Performance chart created');
                } catch(e) {
                    console.error('Error creating performance chart:', e);
                }
            }

            setTimeout(() => {
                updateInvestmentCharts();
            }, 100);
        }

        function updateInvestmentCharts() {
            if (!window.investmentManager) {
                console.log('Investment manager not ready yet');
                return;
            }

            const investments = window.investmentManager.investments || [];
            
            //  FIXED Update Function - Prevents entire chart from turning blue
            if (investmentAllocationChart) {
                if (investments.length === 0) {
                    investmentAllocationChart.data.labels = ['No Investments'];
                    investmentAllocationChart.data.datasets[0] = {
                        data: [1],
                        backgroundColor: ['#e5e7eb'],
                        borderWidth: 0,
                        spacing: 0
                    };
                } else {
                    const colors = [
                        '#8b5cf6',  // Purple
                        '#f59e0b',  // Amber
                        '#06b6d4',  // Cyan
                        '#10b981',  // Green
                        '#ec4899',  // Pink
                        '#f97316',  // Orange
                        '#3b82f6',  // Blue
                        '#14b8a6',  // Teal
                        '#a855f7',  // Violet
                        '#ef4444'   // Red
                    ];

                    investmentAllocationChart.data.labels = investments.map(inv => inv.name);
                    
                    // Replace entire dataset object instead of modifying properties
                    investmentAllocationChart.data.datasets[0] = {
                        data: investments.map(inv => inv.currentValue),
                        backgroundColor: investments.map((_, index) => colors[index % colors.length]),
                        borderWidth: 0,
                        spacing: 0
                    };
                }
                
                investmentAllocationChart.update('active'); // Changed from 'none' to 'active'
                console.log(' Allocation chart updated');
            }

            //  Update Performance Chart (Line) - remains the same
            if (investmentPerformanceChart) {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const currentYear = new Date().getFullYear();

                // Monthly totals for the current year (per month, NOT cumulative)
                const monthlyInvested = months.map((_, monthIndex) => {
                    return investments
                        .filter(inv => {
                            const date = new Date(inv.purchaseDate);
                            return date.getMonth() === monthIndex && date.getFullYear() === currentYear;
                        })
                        .reduce((sum, inv) => sum + inv.totalInvested, 0);
                });

                const monthlyValue = months.map((_, monthIndex) => {
                    return investments
                        .filter(inv => {
                            const date = new Date(inv.purchaseDate);
                            return date.getMonth() === monthIndex && date.getFullYear() === currentYear;
                        })
                        .reduce((sum, inv) => sum + inv.currentValue, 0);
                });

                // Use raw monthly data so each month stands on its own
                investmentPerformanceChart.data.datasets[0].data = monthlyInvested; // "Total Invested" per month
                investmentPerformanceChart.data.datasets[1].data = monthlyValue;    // "Portfolio Value" per month

                investmentPerformanceChart.update('none');
                console.log('Performance chart updated (monthly, non-cumulative)');
            }

            console.log(' All investment charts updated successfully!');
        }

        window.updateInvestmentCharts = updateInvestmentCharts;

        // Listen for clicks on Investments navigation (SAME AS SAVINGS)
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up investment navigation listeners');
            
            const allLinks = document.querySelectorAll('a, button, [data-page]');
            
            allLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    const dataPage = this.getAttribute('data-page');
                    const page = dataPage || (href ? href.replace('#', '') : '');
                    
                    if (page === 'investments') {
                        console.log('Investments page clicked, initializing charts in 300ms...');
                        setTimeout(() => {
                            initializeInvestmentCharts();
                        }, 300);
                    }
                });
            });
        });

    lucide.createIcons();

    </script>
</body>
</html>